<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Strateole 2 Project: zephyr.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Strateole 2 Project"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Strateole 2 Project
   </div>
   <div id="projectbrief">HaaseResearchGroup@UCSD</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,true,'search.php','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('zephyr_8c-example.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">zephyr.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *      @file zephyr.c</span></div><div class="line"><span class="comment"> *      @brief ROC2 Zephyr Interface Module</span></div><div class="line"><span class="comment"> *      </span></div><div class="line"><span class="comment"> *      This program is the first version of data collection software for the ROC2 Radio</span></div><div class="line"><span class="comment"> *      Occultation Instrument. It lacks the full feature set of the final instrument but</span></div><div class="line"><span class="comment"> *      performs the following:</span></div><div class="line"><span class="comment"> *      </span></div><div class="line"><span class="comment"> *      - Reads configuration file to determine commands for setting up GPS receiver</span></div><div class="line"><span class="comment"> *      - Configures GPS receiver</span></div><div class="line"><span class="comment"> *      - Launch data offload program</span></div><div class="line"><span class="comment"> *      - Logs data received from GPS receiver to files</span></div><div class="line"><span class="comment"> *      - When data file is closed, calls data processing script and open new file</span></div><div class="line"><span class="comment"> *      </span></div><div class="line"><span class="comment"> *      @author David Jabson, Brainstorm Engineering 2018 </span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *      @addtogroup zephyr_code</span></div><div class="line"><span class="comment"> *      @{</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;ctype.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;libconfig.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;time.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;termios.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;fcntl.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;sys/stat.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;poll.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;dirent.h&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="zephyr_8h.html">zephyr.h</a>&quot;</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Main function.</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// Calls ZephyrInit() to perform initialization then enters the main while loop where it</span></div><div class="line"><span class="comment">/// .... </span></div><div class="line"><span class="comment">/// the main loop stops, then ZephyrCleanup() is called before exiting.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="preprocessor">#define SEPTENTRIOTOGLNG 300000</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a0"></a><a class="code" href="group__zephyr__code.html#ga0ddf1224851353fc92bfbff6f499fa97">main</a> (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> err, acked, i, numread, j;</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *endptr, *readptr;</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> term, readbuf[<a name="a1"></a><a class="code" href="group__zephyr__header.html#gab3f00dac33458432279d4308226d8413">INBUFSIZE</a>], linebuf[<a class="code" href="group__zephyr__header.html#gab3f00dac33458432279d4308226d8413">INBUFSIZE</a>/2];</div><div class="line">        <span class="keyword">struct </span>termios options;</div><div class="line"><span class="comment">//      struct timespec curTime;</span></div><div class="line">        time_t Timer;</div><div class="line">        <span class="keywordtype">char</span> *nextFile;</div><div class="line">        <span class="keyword">enum</span> <a class="code" href="group__zephyr__header.html#ga10a0f35066079abd150539d0d13dbf3e">msg</a> InMsgType;</div><div class="line">        <span class="keywordtype">char</span> InMsgTypeStr[8];</div><div class="line">        time_t nextS=0, nextTm=0;</div><div class="line">        </div><div class="line">        <span class="keyword">struct </span>pollfd fds[1];</div><div class="line"></div><div class="line">        err = <a name="a2"></a><a class="code" href="group__zephyr__code.html#ga26a5cd9326852a6f3a89225c8642479b">ZephyrInit</a>(argc, argv);</div><div class="line"><span class="comment">//      led(RED);</span></div><div class="line">        <a name="a3"></a><a class="code" href="group__zephyr__header.html#gaf7d4b36cbbc4aa28f3f6c0e455b9b8bb">sendIMRatPower</a> = 1;</div><div class="line">        <span class="keywordflow">if</span>(err&lt;0)</div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Initialization error %d. Exiting\r\n&quot;</span>,<a name="a4"></a><a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>,err);</div><div class="line">                <span class="keywordflow">if</span>(<a name="a5"></a><a class="code" href="group__zephyr__header.html#gafbce215e681be701ae5373fd692dd9ba">hwversion</a>&gt;2) <a name="a6"></a><a class="code" href="group__zephyr__code.html#ga94bb341ea8ea68eb26f43e8664513609">led</a>(<a name="a7"></a><a class="code" href="group__roc2__header.html#ga8d23feea868a983c8c2b661e1e16972f">RED</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> </div><div class="line">        {</div><div class="line">                printf(<span class="stringliteral">&quot;SWVersion = %s\r\nSWDate = %s\r\n&quot;</span>,<a name="a8"></a><a class="code" href="group__roc2__header.html#gad6f212287232c8a7d12dbc0e5901635d">SWVersion</a>,<a name="a9"></a><a class="code" href="group__roc2__header.html#ga8e5d9993745ca60b1777be3b1fa57a53">SWDate</a>);</div><div class="line">                printf(<span class="stringliteral">&quot;%s: Module started.\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line"><span class="comment">//              write(zephyr.fp, &quot;ROC online\r\n&quot;, 12);</span></div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#gafbce215e681be701ae5373fd692dd9ba">hwversion</a>&gt;2) <a class="code" href="group__zephyr__code.html#ga94bb341ea8ea68eb26f43e8664513609">led</a>(<a name="a10"></a><a class="code" href="group__roc2__header.html#gacfbc006ea433ad708fdee3e82996e721">GREEN</a>);</div><div class="line">        }</div><div class="line">        </div><div class="line">        term=<a name="a11"></a><a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a name="a12"></a><a class="code" href="group__roc2__header.html#ga29c6cbcf2159ec289aa7742b1e99b316">term</a>[strlen(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga29c6cbcf2159ec289aa7742b1e99b316">term</a>)-1];</div><div class="line">        readptr=readbuf;</div><div class="line">        memset(readbuf, 0, <span class="keyword">sizeof</span>(readbuf));</div><div class="line"></div><div class="line">        fds[0].fd = <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a name="a13"></a><a class="code" href="group__roc2__header.html#ga5c82fa58c263d40b70b737c5efa07ef0">fp</a>;</div><div class="line">        fds[0].events = POLLIN;</div><div class="line"></div><div class="line"><span class="comment">//      tcgetattr(serial.fp, &amp;options);                                         // Get current port options</span></div><div class="line"><span class="comment">//      options.c_cflag |= CREAD;                                                       // Enable the serial receiver</span></div><div class="line"><span class="comment">//      tcflush(serial.fp,TCIOFLUSH);                                           // Flush serial buffers</span></div><div class="line"><span class="comment">//      if(tcsetattr(serial.fp, TCSANOW, &amp;options) == 0)        // Make the new settings active</span></div><div class="line"></div><div class="line">        Timer = time(NULL);</div><div class="line"></div><div class="line">        <span class="keywordflow">while</span>(!<a name="a14"></a><a class="code" href="group__roc2__header.html#ga2896431d6a80cd39b3d24b40237612ee">quit</a>)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span> (Timer != time(NULL)) {</div><div class="line">                        Timer = time(NULL);             <span class="comment">// set for next second</span></div><div class="line"></div><div class="line">                        <span class="keywordflow">if</span> (<a name="a15"></a><a class="code" href="group__zephyr__header.html#gac292f396289364d78037cae452f1aefc">waitingAck</a>) {</div><div class="line">                                <a class="code" href="group__zephyr__header.html#gac292f396289364d78037cae452f1aefc">waitingAck</a> -= 1;</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">if</span> (<a name="a16"></a><a class="code" href="group__zephyr__header.html#gaa37b17e868a3191ab989eeb7dc8cd393">waitingIM</a>) {</div><div class="line">                                <a class="code" href="group__zephyr__header.html#gaa37b17e868a3191ab989eeb7dc8cd393">waitingIM</a> -= 1;</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">if</span>(<a name="a17"></a><a class="code" href="group__zephyr__header.html#gac380ae62365b5574461d06a4c004d681">safeTimeout</a>) { </div><div class="line">                                <a class="code" href="group__zephyr__header.html#gac380ae62365b5574461d06a4c004d681">safeTimeout</a> -= 1;</div><div class="line">                                <span class="keywordflow">if</span> (<a class="code" href="group__zephyr__header.html#gac380ae62365b5574461d06a4c004d681">safeTimeout</a> == 0) { <span class="comment">// Haven&#39;t heard from Zephyr in over 2 hours, enter Standby mode</span></div><div class="line">                                        <a class="code" href="group__zephyr__header.html#gac380ae62365b5574461d06a4c004d681">safeTimeout</a> = <a name="a18"></a><a class="code" href="group__zephyr__header.html#ga3b02c8218b4fda72755b780d51977c38">SAFETIMEOUT</a>;</div><div class="line">                                        InstMode = <a name="a19"></a><a class="code" href="group__zephyr__header.html#gga1a6b6fb557d8d37d59700faf4e4c9167ad3000f705564090d2acd1d320ccc5135">SB</a>;</div><div class="line">                                        <a name="a20"></a><a class="code" href="group__zephyr__header.html#gae7b49ade5fe88e53a5f0dda94ae94b23">safeAck</a> = 0;</div><div class="line">                                }</div><div class="line">                        }</div><div class="line"></div><div class="line"><span class="preprocessor">#if 0</span></div><div class="line"><span class="comment">// This section checks to make sure we are not receiving chars in Low Power mode</span></div><div class="line"><span class="comment">// and that we are receiving chras in non-Low Power mode</span></div><div class="line">                        <span class="keywordflow">if</span>(<a name="a21"></a><a class="code" href="group__zephyr__header.html#ga52ca9e601c9d0389607ec95f1c49215e">lowPowerCheck</a>)       { </div><div class="line">                                <a class="code" href="group__zephyr__header.html#ga52ca9e601c9d0389607ec95f1c49215e">lowPowerCheck</a> -= 1;</div><div class="line">                                <span class="keywordflow">if</span> (<a class="code" href="group__zephyr__header.html#ga52ca9e601c9d0389607ec95f1c49215e">lowPowerCheck</a> == 0) { <span class="comment">// Check to make sure we are not receiing chars in Low Power mode</span></div><div class="line">                                        <a class="code" href="group__zephyr__header.html#ga52ca9e601c9d0389607ec95f1c49215e">lowPowerCheck</a> = <a name="a22"></a><a class="code" href="group__zephyr__header.html#ga052dadad9560c0874f9dfeedae0ccb3b">LOWPOWERCHECK</a>;</div><div class="line">                                        <span class="keywordflow">if</span> (<a name="a23"></a><a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>)</div><div class="line">                                                printf(<span class="stringliteral">&quot;%s:%d: Check Mode %d Power State with %d GPS Chars: %d\r\n&quot;</span>,</div><div class="line">                                                        <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, Timer, InstMode, <a name="a24"></a><a class="code" href="group__zephyr__header.html#gad3e6084a9ba20b4a2229e450de4b4cb1">gotGPSChars</a>, <a name="a25"></a><a class="code" href="group__zephyr__header.html#gaf8bedab821ee7f36762a64ac71e914a4">lowPowerCheckWait</a>);</div><div class="line">                                        <span class="keywordflow">if</span> (InstMode == <a name="a26"></a><a class="code" href="group__zephyr__header.html#gga1a6b6fb557d8d37d59700faf4e4c9167a417c69b8c9313307f484fd52ea61db84">LP</a>) {</div><div class="line">                                                <span class="keywordflow">if</span> (<a class="code" href="group__zephyr__header.html#gaf8bedab821ee7f36762a64ac71e914a4">lowPowerCheckWait</a> == 0) {</div><div class="line">                                                        <span class="keywordflow">if</span> (<a class="code" href="group__zephyr__header.html#gad3e6084a9ba20b4a2229e450de4b4cb1">gotGPSChars</a> &gt; 100) {</div><div class="line">                                                                <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Got %d GPS Chars in LP Mode - Toggle Low Power Line\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, <a class="code" href="group__zephyr__header.html#gad3e6084a9ba20b4a2229e450de4b4cb1">gotGPSChars</a>);</div><div class="line">                                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to low</span></div><div class="line">                                                                usleep(<a name="a27"></a><a class="code" href="group__zephyr__code.html#ga777ab160b5ad985f2ccc1a878e5936fd">SEPTENTRIOTOGLNG</a>);       <span class="comment">// 300 msecs</span></div><div class="line">                                                                system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line">                                                        }</div><div class="line">                                                        <a class="code" href="group__zephyr__header.html#gad3e6084a9ba20b4a2229e450de4b4cb1">gotGPSChars</a> = 0;</div><div class="line">                                                        <a class="code" href="group__zephyr__header.html#gaf8bedab821ee7f36762a64ac71e914a4">lowPowerCheckWait</a> = 5;</div><div class="line">                                                        <a name="a28"></a><a class="code" href="group__zephyr__header.html#gaf7f4cea1c772506355074b09428675b7">discardFirstFile</a> = 1;</div><div class="line">                                                } <span class="keywordflow">else</span> {</div><div class="line">                                                        <a class="code" href="group__zephyr__header.html#gaf8bedab821ee7f36762a64ac71e914a4">lowPowerCheckWait</a> -= 1;</div><div class="line">                                                }</div><div class="line">                                        } <span class="keywordflow">else</span> {</div><div class="line">                                                <span class="keywordflow">if</span> (<a class="code" href="group__zephyr__header.html#gaf8bedab821ee7f36762a64ac71e914a4">lowPowerCheckWait</a> == 0) {</div><div class="line">                                                        <span class="keywordflow">if</span> (<a class="code" href="group__zephyr__header.html#gad3e6084a9ba20b4a2229e450de4b4cb1">gotGPSChars</a> &lt; 100) {</div><div class="line">                                                                <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Only %d GPS Chars in NON LP Mode - Toggle Low Power Line\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, <a class="code" href="group__zephyr__header.html#gad3e6084a9ba20b4a2229e450de4b4cb1">gotGPSChars</a>);</div><div class="line">                                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to low</span></div><div class="line">                                                                usleep(<a class="code" href="group__zephyr__code.html#ga777ab160b5ad985f2ccc1a878e5936fd">SEPTENTRIOTOGLNG</a>);       <span class="comment">// 300 msecs</span></div><div class="line">                                                                system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line">                                                        }</div><div class="line">                                                        <a class="code" href="group__zephyr__header.html#gad3e6084a9ba20b4a2229e450de4b4cb1">gotGPSChars</a> = 0;</div><div class="line">                                                        <a class="code" href="group__zephyr__header.html#gaf8bedab821ee7f36762a64ac71e914a4">lowPowerCheckWait</a> = 8;</div><div class="line">                                                } <span class="keywordflow">else</span> {</div><div class="line">                                                        <a class="code" href="group__zephyr__header.html#gaf8bedab821ee7f36762a64ac71e914a4">lowPowerCheckWait</a> -= 1;</div><div class="line">                                                }</div><div class="line">                                        }</div><div class="line">                                }</div><div class="line">                        }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">                }</div><div class="line">                </div><div class="line"><span class="comment">//              if(time(NULL) == nextfile.tv_sec)</span></div><div class="line"><span class="comment">//              {</span></div><div class="line"><span class="comment">//                      nextfile.tv_sec+=file_len;</span></div><div class="line"><span class="comment">//                      NewFile();</span></div><div class="line"><span class="comment">//              }</span></div><div class="line">                usleep(200000);         <span class="comment">// sleep for 0.2s</span></div><div class="line">                </div><div class="line"><span class="comment">//              if(time(NULL) &gt; ackTimeout) waitingAck=0;</span></div><div class="line">                </div><div class="line">                <span class="keywordflow">switch</span>(InstMode)</div><div class="line">                {</div><div class="line">                        <span class="keywordflow">case</span> <a name="a29"></a><a class="code" href="group__zephyr__header.html#gga1a6b6fb557d8d37d59700faf4e4c9167a23f8b9ced0e0612b05e87ffd678d19f7">FL</a>:                <span class="comment">// Flight mode. Check for data files to offload</span></div><div class="line">                <span class="comment">//          if (verbose) printf(&quot;%s: FL Set Safe Output to Low\r\n&quot;, MODULE_NAME);</span></div><div class="line">                                <a class="code" href="group__zephyr__header.html#gaf7d4b36cbbc4aa28f3f6c0e455b9b8bb">sendIMRatPower</a> = 0;</div><div class="line">                                <span class="keywordflow">switch</span>(<a class="code" href="group__zephyr__header.html#gafbce215e681be701ae5373fd692dd9ba">hwversion</a>)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">case</span> 3:</div><div class="line">                                                <a name="a30"></a><a class="code" href="group__zephyr__code.html#ga7e696bce041fca9cc1924bcd65cbc503">set_safe</a>(<a name="a31"></a><a class="code" href="group__roc2__header.html#ga29e413f6725b2ba32d165ffaa35b01e5">OFF</a>);</div><div class="line">                                                <span class="keywordflow">break</span>;</div><div class="line">                                        <span class="keywordflow">default</span>:</div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio193/value&quot;</span>);                 <span class="comment">// Set SAFE digital output to lo</span></div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio233/value&quot;</span>);                 <span class="comment">// Set 5V On</span></div><div class="line">                                                <span class="keywordflow">break</span>;</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">if</span>(<a name="a32"></a><a class="code" href="group__zephyr__header.html#gafd6a133642d784682fb4eb4c33ca2bd8">modeSwitch</a>)  <span class="comment">// coming out of low power mode, reset GPS</span></div><div class="line">                                {</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#gafd6a133642d784682fb4eb4c33ca2bd8">modeSwitch</a>=0;</div><div class="line"><span class="comment">// Sepentrio Wakeup</span></div><div class="line">                                        <span class="keywordflow">if</span> (<a name="a33"></a><a class="code" href="group__zephyr__header.html#ga4388415ac8b79e24f68e40759a23651f">wakeUpFlag</a>) {</div><div class="line">                                                <a class="code" href="group__zephyr__header.html#ga4388415ac8b79e24f68e40759a23651f">wakeUpFlag</a> = 0;</div><div class="line">                                                <span class="keywordflow">switch</span>(<a class="code" href="group__zephyr__header.html#gafbce215e681be701ae5373fd692dd9ba">hwversion</a>)</div><div class="line">                                                {</div><div class="line">                                                        <span class="keywordflow">case</span> 3:</div><div class="line">                                                                <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Entering FL mode. GPS power on.\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                                                                <a name="a34"></a><a class="code" href="group__zephyr__code.html#ga093f472d65a4478a2a23fa69ea593ef0">gps_power</a>(<a name="a35"></a><a class="code" href="group__roc2__header.html#gad76d1750a6cdeebd506bfcd6752554d2">ON</a>);</div><div class="line">                                                                <span class="keywordflow">break</span>;</div><div class="line">                                                        <span class="keywordflow">default</span>:</div><div class="line">                                                                <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Toggle Wakeup to Septentrio - Flight Mode\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to low</span></div><div class="line">                                                                usleep(<a class="code" href="group__zephyr__code.html#ga777ab160b5ad985f2ccc1a878e5936fd">SEPTENTRIOTOGLNG</a>);       <span class="comment">// 300 msecs</span></div><div class="line">                                                                system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line">                                                                <a class="code" href="group__zephyr__header.html#gaf8bedab821ee7f36762a64ac71e914a4">lowPowerCheckWait</a> = 16;</div><div class="line">                                                                <a class="code" href="group__zephyr__header.html#ga52ca9e601c9d0389607ec95f1c49215e">lowPowerCheck</a> = <a class="code" href="group__zephyr__header.html#ga052dadad9560c0874f9dfeedae0ccb3b">LOWPOWERCHECK</a>;</div><div class="line">                                                                <a class="code" href="group__zephyr__header.html#gad3e6084a9ba20b4a2229e450de4b4cb1">gotGPSChars</a> = 0;</div><div class="line">                                                                <span class="keywordflow">break</span>;</div><div class="line">                                                }</div><div class="line">                                        }</div><div class="line">                                }</div><div class="line"></div><div class="line">                                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#gac292f396289364d78037cae452f1aefc">waitingAck</a>==0)</div><div class="line">                                <span class="keywordflow">if</span>(nextFile = <a name="a36"></a><a class="code" href="group__zephyr__code.html#gab66e64dd30463cea0a06ac33c9cb3522">GetNextFile</a>())</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">if</span> (strstr(nextFile,<span class="stringliteral">&quot;list.txt&quot;</span>)) {</div><div class="line">                                                <a name="a37"></a><a class="code" href="group__zephyr__header.html#gade6c9212e8175f2f26cb4ffa27f6f71c">TCflag</a> = 1;</div><div class="line">                                                <span class="keywordflow">if</span>(<a name="a38"></a><a class="code" href="group__zephyr__header.html#ga57408962695c0061aac03bb3a81b9658">TClastPart</a>==<a name="a39"></a><a class="code" href="group__zephyr__header.html#gad4b9eb4866c26710cf777628af77626e">TCnumParts</a>)              <span class="comment">// we finished the previous file, starting a new one</span></div><div class="line">                                                {</div><div class="line">                                                        strcpy(<a name="a40"></a><a class="code" href="group__zephyr__header.html#ga9de05a1c8882446cef651d95cb8c03f8">TCfileOffload</a>, nextFile);</div><div class="line">                                                }</div><div class="line">                                                <a name="a41"></a><a class="code" href="group__zephyr__code.html#gaf672e15ff453fe857ab4ce7de925f34a">TCSendFile</a>(<a class="code" href="group__zephyr__header.html#ga9de05a1c8882446cef651d95cb8c03f8">TCfileOffload</a>);</div><div class="line">                                        } <span class="keywordflow">else</span> {</div><div class="line">                                                <a class="code" href="group__zephyr__header.html#gade6c9212e8175f2f26cb4ffa27f6f71c">TCflag</a> = 0;</div><div class="line">                                                <span class="keywordflow">if</span>(<a name="a42"></a><a class="code" href="group__zephyr__header.html#ga7d97c19b1f965c9fdcefe9e9c83fe126">lastPart</a>==<a name="a43"></a><a class="code" href="group__zephyr__header.html#gaa37266c0efaae4ac2d8a5fbba8341a9e">numParts</a>)          <span class="comment">// we finished the previous file, starting a new one</span></div><div class="line">                                                {</div><div class="line">                                                        strcpy(<a name="a44"></a><a class="code" href="group__zephyr__header.html#gad9de7f17717cd6e46d8f5f4e869a4bd1">fileOffload</a>, nextFile);</div><div class="line">                                                }</div><div class="line">                                                <a name="a45"></a><a class="code" href="group__zephyr__code.html#ga184ae444081beacfe0bd5b712d378b59">SendFile</a>(<a class="code" href="group__zephyr__header.html#gad9de7f17717cd6e46d8f5f4e869a4bd1">fileOffload</a>);</div><div class="line">                                        }</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                        <span class="keywordflow">case</span> <a class="code" href="group__zephyr__header.html#gga1a6b6fb557d8d37d59700faf4e4c9167ad3000f705564090d2acd1d320ccc5135">SB</a>:                <span class="comment">// Standby mode. Send IMR msg once per minute until we get an IM msg that forces a mode change</span></div><div class="line">                                <span class="keywordflow">if</span> (<a class="code" href="group__zephyr__header.html#gafd6a133642d784682fb4eb4c33ca2bd8">modeSwitch</a>) {</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#gafd6a133642d784682fb4eb4c33ca2bd8">modeSwitch</a> = 0;</div><div class="line">                                        <span class="keywordflow">if</span> (<a class="code" href="group__zephyr__header.html#ga4388415ac8b79e24f68e40759a23651f">wakeUpFlag</a> &amp;&amp; <a name="a46"></a><a class="code" href="group__zephyr__header.html#gad4d4536ebc16bcd99fca3934346c8372">poweroffgps</a>) {</div><div class="line">                                                <span class="keywordflow">switch</span>(<a class="code" href="group__zephyr__header.html#gafbce215e681be701ae5373fd692dd9ba">hwversion</a>)</div><div class="line">                                                {</div><div class="line">                                                        <span class="keywordflow">case</span> 3:</div><div class="line"><span class="comment">//                                                              if (verbose) printf(&quot;%s: Entering SB mode. GPS power off.\r\n&quot;, MODULE_NAME);</span></div><div class="line"><span class="comment">//                                                              gps_power(OFF);</span></div><div class="line">                                                                <span class="keywordflow">break</span>;</div><div class="line">                                                        <span class="keywordflow">default</span>:</div><div class="line">                                                                <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Toggle Wakeup to Septentrio - Flight Mode\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to low</span></div><div class="line">                                                                usleep(<a class="code" href="group__zephyr__code.html#ga777ab160b5ad985f2ccc1a878e5936fd">SEPTENTRIOTOGLNG</a>);       <span class="comment">// 300 msecs</span></div><div class="line">                                                                system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line">                                                                <span class="keywordflow">break</span>;</div><div class="line">                                                }</div><div class="line">                                                <a class="code" href="group__zephyr__header.html#ga4388415ac8b79e24f68e40759a23651f">wakeUpFlag</a> = 0;</div><div class="line">                                                <a class="code" href="group__zephyr__header.html#gad4d4536ebc16bcd99fca3934346c8372">poweroffgps</a> = 0;</div><div class="line">                                                }</div><div class="line">                                        <a name="a47"></a><a class="code" href="group__zephyr__header.html#ga5b3e85b8b041c8b4a422f22faa6f87be">nextImr</a> = time(NULL)+5;</div><div class="line">                                }</div><div class="line">                <span class="comment">//          if (verbose) printf(&quot;%s: SB Set Safe Output to Low\r\n&quot;, MODULE_NAME);</span></div><div class="line">                                <span class="keywordflow">switch</span>(<a class="code" href="group__zephyr__header.html#gafbce215e681be701ae5373fd692dd9ba">hwversion</a>)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">case</span> 3:</div><div class="line">                                                <a class="code" href="group__zephyr__code.html#ga7e696bce041fca9cc1924bcd65cbc503">set_safe</a>(<a class="code" href="group__roc2__header.html#ga29e413f6725b2ba32d165ffaa35b01e5">OFF</a>);</div><div class="line">                                                <span class="keywordflow">break</span>;</div><div class="line">                                        <span class="keywordflow">default</span>:</div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio193/value&quot;</span>);                 <span class="comment">// Set SAFE digital output to lo</span></div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio233/value&quot;</span>);                 <span class="comment">// Set 5V On</span></div><div class="line">                                                <span class="keywordflow">break</span>;</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">if</span>(time(NULL) &gt; <a class="code" href="group__zephyr__header.html#ga5b3e85b8b041c8b4a422f22faa6f87be">nextImr</a>)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">if</span> (<a class="code" href="group__zephyr__header.html#gaf7d4b36cbbc4aa28f3f6c0e455b9b8bb">sendIMRatPower</a>) {</div><div class="line">                                                <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Sending IMR message\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                                                <a name="a48"></a><a class="code" href="group__zephyr__code.html#ga6e021f179fc712de402af1043ca1a9ef">SendMsg</a>(<a name="a49"></a><a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea7c1d11a9bbf54a9ff9af0ad29823bd73">IMR</a>, <span class="stringliteral">&quot;&quot;</span>, 0);</div><div class="line">                                                <a class="code" href="group__zephyr__header.html#gaa37b17e868a3191ab989eeb7dc8cd393">waitingIM</a> = <a name="a50"></a><a class="code" href="group__zephyr__header.html#gae1fcb66a99d5c37f2935facbd0925ca0">WAITFORIM</a>;</div><div class="line">                                        }</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#ga5b3e85b8b041c8b4a422f22faa6f87be">nextImr</a> = time(NULL)+60;</div><div class="line">                                }</div><div class="line"></div><div class="line"><span class="comment">//                              if(time(NULL) &gt; nextTm)</span></div><div class="line"><span class="comment">//                              {</span></div><div class="line"><span class="comment">//                                      if(verbose) printf(&quot;%s: Sending TM housekeeping message\r\n&quot;, MODULE_NAME);</span></div><div class="line"><span class="comment">//                                      dataTm = 0;</span></div><div class="line"><span class="comment">//                                      SendMsg(TM, &quot;&quot;, 0);</span></div><div class="line"><span class="comment">//                                      nextTm = time(NULL)+60;</span></div><div class="line"><span class="comment">//                              }</span></div><div class="line"></div><div class="line">                                <span class="keywordflow">if</span>((nextFile = <a class="code" href="group__zephyr__code.html#gab66e64dd30463cea0a06ac33c9cb3522">GetNextFile</a>()) &amp;&amp; !<a class="code" href="group__zephyr__header.html#gac292f396289364d78037cae452f1aefc">waitingAck</a> &amp;&amp; !<a class="code" href="group__zephyr__header.html#gaa37b17e868a3191ab989eeb7dc8cd393">waitingIM</a>)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">if</span> (strstr(nextFile,<span class="stringliteral">&quot;list.txt&quot;</span>)) {</div><div class="line">                                                <a class="code" href="group__zephyr__header.html#gade6c9212e8175f2f26cb4ffa27f6f71c">TCflag</a> = 1;</div><div class="line">                                                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#ga57408962695c0061aac03bb3a81b9658">TClastPart</a>==<a class="code" href="group__zephyr__header.html#gad4b9eb4866c26710cf777628af77626e">TCnumParts</a>)              <span class="comment">// we finished the previous file, starting a new one</span></div><div class="line">                                                {</div><div class="line">                                                        strcpy(<a class="code" href="group__zephyr__header.html#ga9de05a1c8882446cef651d95cb8c03f8">TCfileOffload</a>, nextFile);</div><div class="line">                                                }</div><div class="line">                                                <a class="code" href="group__zephyr__code.html#gaf672e15ff453fe857ab4ce7de925f34a">TCSendFile</a>(<a class="code" href="group__zephyr__header.html#ga9de05a1c8882446cef651d95cb8c03f8">TCfileOffload</a>);</div><div class="line">                                        } <span class="keywordflow">else</span> {</div><div class="line">                                                <a class="code" href="group__zephyr__header.html#gade6c9212e8175f2f26cb4ffa27f6f71c">TCflag</a> = 0;</div><div class="line">                                                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#ga7d97c19b1f965c9fdcefe9e9c83fe126">lastPart</a>==<a class="code" href="group__zephyr__header.html#gaa37266c0efaae4ac2d8a5fbba8341a9e">numParts</a>)  {       <span class="comment">// we finished the previous file, starting a new one</span></div><div class="line">                                                        <a name="a51"></a><a class="code" href="group__zephyr__header.html#ga9ad65e907dc15f9fd37da381332b2f1f">dataTm</a> = 0;</div><div class="line">                                                        <a class="code" href="group__zephyr__code.html#ga6e021f179fc712de402af1043ca1a9ef">SendMsg</a>(<a name="a52"></a><a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3eac0f142a65b7d596e898b5ede310ac154">TM</a>, <span class="stringliteral">&quot;&quot;</span>, 0);</div><div class="line">                                                        <a class="code" href="group__zephyr__header.html#gac292f396289364d78037cae452f1aefc">waitingAck</a>=<a name="a53"></a><a class="code" href="group__zephyr__header.html#ga7f970a76fd7cbf3dd6143df7262bbccc">WAITFORACK</a>;</div><div class="line">                                                        <a name="a54"></a><a class="code" href="group__zephyr__code.html#gabf9cb423a606dc4f8232d1b3394042d5">RemoveFile</a>(nextFile);</div><div class="line">                                                } <span class="keywordflow">else</span> {</div><div class="line">                                                        <a class="code" href="group__zephyr__code.html#ga184ae444081beacfe0bd5b712d378b59">SendFile</a>(<a class="code" href="group__zephyr__header.html#gad9de7f17717cd6e46d8f5f4e869a4bd1">fileOffload</a>);</div><div class="line">                                                }</div><div class="line">                                        }</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                        <span class="keywordflow">case</span> <a class="code" href="group__zephyr__header.html#gga1a6b6fb557d8d37d59700faf4e4c9167a417c69b8c9313307f484fd52ea61db84">LP</a>:                <span class="comment">// Low power mode. Put GPS in standby.</span></div><div class="line">                <span class="comment">//          if (verbose) printf(&quot;%s: LP Set Safe Output to Low\r\n&quot;, MODULE_NAME);</span></div><div class="line">                                <span class="keywordflow">switch</span>(<a class="code" href="group__zephyr__header.html#gafbce215e681be701ae5373fd692dd9ba">hwversion</a>)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">case</span> 3:</div><div class="line">                                                <a class="code" href="group__zephyr__code.html#ga7e696bce041fca9cc1924bcd65cbc503">set_safe</a>(<a class="code" href="group__roc2__header.html#ga29e413f6725b2ba32d165ffaa35b01e5">OFF</a>);</div><div class="line">                                                <span class="keywordflow">break</span>;</div><div class="line">                                        <span class="keywordflow">default</span>:</div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio193/value&quot;</span>);                 <span class="comment">// Set SAFE digital output to lo</span></div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio233/value&quot;</span>);                 <span class="comment">// Set 5V off</span></div><div class="line">                                                <span class="keywordflow">break</span>;</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#gafd6a133642d784682fb4eb4c33ca2bd8">modeSwitch</a>)</div><div class="line">                                {</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#gafd6a133642d784682fb4eb4c33ca2bd8">modeSwitch</a>=0;</div><div class="line"><span class="comment">//                                      system(&quot;echo \&quot;exePowerMode StandBy\&quot; &gt; /dev/ttyS3&quot;);           // Ugly hack for now (use this one for VM testing)</span></div><div class="line"><span class="comment">//                                      if (verbose) printf(&quot;%s: Send Low Power Command to Septentrio\r\n&quot;, MODULE_NAME);</span></div><div class="line"><span class="comment">//                                      system(&quot;echo \&quot;exePowerMode, StandBy\&quot; &gt; /dev/ttyAPP2&quot;);                // Ugly hack for now (use this one for flight HW)</span></div><div class="line">                                        <span class="keywordflow">switch</span>(<a class="code" href="group__zephyr__header.html#gafbce215e681be701ae5373fd692dd9ba">hwversion</a>)</div><div class="line">                                        {</div><div class="line">                                                <span class="keywordflow">case</span> 3:</div><div class="line">                                                        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Entering LP mode. GPS off.\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                                                        <a class="code" href="group__zephyr__code.html#ga093f472d65a4478a2a23fa69ea593ef0">gps_power</a>(<a class="code" href="group__roc2__header.html#ga29e413f6725b2ba32d165ffaa35b01e5">OFF</a>);</div><div class="line">                                                        <span class="keywordflow">break</span>;</div><div class="line">                                                <span class="keywordflow">default</span>:</div><div class="line">                                                        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Toggle Power Down to Septentrio - Flight Mode\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                                                        system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to low</span></div><div class="line">                                                        usleep(<a class="code" href="group__zephyr__code.html#ga777ab160b5ad985f2ccc1a878e5936fd">SEPTENTRIOTOGLNG</a>);       <span class="comment">// 300 msecs</span></div><div class="line">                                                        system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line">                                                        <span class="keywordflow">break</span>;</div><div class="line">                                        }</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#gaf8bedab821ee7f36762a64ac71e914a4">lowPowerCheckWait</a> = 5;</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#gad3e6084a9ba20b4a2229e450de4b4cb1">gotGPSChars</a> = 0;</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#gad4d4536ebc16bcd99fca3934346c8372">poweroffgps</a> = 1;</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#gaf7f4cea1c772506355074b09428675b7">discardFirstFile</a> = 1;                                                                                   <span class="comment">// Flag that power off command to GPS sent</span></div><div class="line">                                }</div><div class="line"><span class="comment">//                              nextImr = time(NULL) + 10000000;</span></div><div class="line"><span class="comment">//                              nextTm = time(NULL)+60;</span></div><div class="line"></div><div class="line">                                <span class="keywordflow">if</span>((nextFile = <a class="code" href="group__zephyr__code.html#gab66e64dd30463cea0a06ac33c9cb3522">GetNextFile</a>()) &amp;&amp; !<a class="code" href="group__zephyr__header.html#gac292f396289364d78037cae452f1aefc">waitingAck</a> &amp;&amp; !<a class="code" href="group__zephyr__header.html#gaa37b17e868a3191ab989eeb7dc8cd393">waitingIM</a>)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">if</span> (strstr(nextFile,<span class="stringliteral">&quot;list.txt&quot;</span>)) {</div><div class="line">                                                <a class="code" href="group__zephyr__header.html#gade6c9212e8175f2f26cb4ffa27f6f71c">TCflag</a> = 1;</div><div class="line">                                                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#ga57408962695c0061aac03bb3a81b9658">TClastPart</a>==<a class="code" href="group__zephyr__header.html#gad4b9eb4866c26710cf777628af77626e">TCnumParts</a>)              <span class="comment">// we finished the previous file, starting a new one</span></div><div class="line">                                                {</div><div class="line">                                                        strcpy(<a class="code" href="group__zephyr__header.html#ga9de05a1c8882446cef651d95cb8c03f8">TCfileOffload</a>, nextFile);</div><div class="line">                                                }</div><div class="line">                                                <a class="code" href="group__zephyr__code.html#gaf672e15ff453fe857ab4ce7de925f34a">TCSendFile</a>(<a class="code" href="group__zephyr__header.html#ga9de05a1c8882446cef651d95cb8c03f8">TCfileOffload</a>);</div><div class="line">                                        } <span class="keywordflow">else</span> {</div><div class="line">                                                <a class="code" href="group__zephyr__header.html#gade6c9212e8175f2f26cb4ffa27f6f71c">TCflag</a> = 0;</div><div class="line">                                                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#ga7d97c19b1f965c9fdcefe9e9c83fe126">lastPart</a>==<a class="code" href="group__zephyr__header.html#gaa37266c0efaae4ac2d8a5fbba8341a9e">numParts</a>)  {       <span class="comment">// we finished the previous file, starting a new one</span></div><div class="line">                                                        <a class="code" href="group__zephyr__header.html#ga9ad65e907dc15f9fd37da381332b2f1f">dataTm</a> = 0;</div><div class="line">                                                        <a class="code" href="group__zephyr__code.html#ga6e021f179fc712de402af1043ca1a9ef">SendMsg</a>(<a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3eac0f142a65b7d596e898b5ede310ac154">TM</a>, <span class="stringliteral">&quot;&quot;</span>, 0);</div><div class="line">                                                        <a class="code" href="group__zephyr__header.html#gac292f396289364d78037cae452f1aefc">waitingAck</a>=<a class="code" href="group__zephyr__header.html#ga7f970a76fd7cbf3dd6143df7262bbccc">WAITFORACK</a>;</div><div class="line">                                                        <a class="code" href="group__zephyr__code.html#gabf9cb423a606dc4f8232d1b3394042d5">RemoveFile</a>(nextFile);</div><div class="line">                                                } <span class="keywordflow">else</span> {</div><div class="line">                                                        <a class="code" href="group__zephyr__code.html#ga184ae444081beacfe0bd5b712d378b59">SendFile</a>(<a class="code" href="group__zephyr__header.html#gad9de7f17717cd6e46d8f5f4e869a4bd1">fileOffload</a>);</div><div class="line">                                                }</div><div class="line">                                        }</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                        <span class="keywordflow">case</span> <a name="a55"></a><a class="code" href="group__zephyr__header.html#gga1a6b6fb557d8d37d59700faf4e4c9167ac4d318ef07bfe697b043d75065f90349">SA</a>:                <span class="comment">// Safety mode.</span></div><div class="line">                                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#gafbce215e681be701ae5373fd692dd9ba">hwversion</a>&lt;3) system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio233/value&quot;</span>);                 <span class="comment">// Set 5V On</span></div><div class="line">                                <span class="keywordflow">if</span> (<a class="code" href="group__zephyr__header.html#gafd6a133642d784682fb4eb4c33ca2bd8">modeSwitch</a>) {</div><div class="line">                                        nextS = time(NULL) + 60;</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#gae7b49ade5fe88e53a5f0dda94ae94b23">safeAck</a> = 0;</div><div class="line">                                        <a class="code" href="group__zephyr__code.html#ga6e021f179fc712de402af1043ca1a9ef">SendMsg</a>(<a name="a56"></a><a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3eaf1ce01387d2348f8b858721a7db81670">S</a>, <span class="stringliteral">&quot;&quot;</span>, 0);              <span class="comment">// We need to send an S msg every time Zephyr sends us IM.S                                     </span></div><div class="line">                                        <a class="code" href="group__zephyr__header.html#gafd6a133642d784682fb4eb4c33ca2bd8">modeSwitch</a> = 0;</div><div class="line"><span class="preprocessor">#if 0</span></div><div class="line">                                        <span class="keywordflow">if</span> (<a class="code" href="group__zephyr__header.html#ga4388415ac8b79e24f68e40759a23651f">wakeUpFlag</a> &amp;&amp; <a class="code" href="group__zephyr__header.html#gad4d4536ebc16bcd99fca3934346c8372">poweroffgps</a>) {</div><div class="line">                                                <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Toggle Wakeup to Septentrio - Flight Mode\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio200/value&quot;</span>);                 <span class="comment">// Set value to low</span></div><div class="line">                                                usleep(500000); <span class="comment">// 500 msecs</span></div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio200/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line">                                                <a class="code" href="group__zephyr__header.html#ga4388415ac8b79e24f68e40759a23651f">wakeUpFlag</a> = 0;</div><div class="line">                                                <a class="code" href="group__zephyr__header.html#gad4d4536ebc16bcd99fca3934346c8372">poweroffgps</a> = 0;</div><div class="line">                                        }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">                                }</div><div class="line"></div><div class="line">                                <span class="keywordflow">if</span>((time(NULL) &gt; nextS) <span class="comment">/*&amp;&amp; !safeAck*/</span>)</div><div class="line">                                {</div><div class="line">                                        <a class="code" href="group__zephyr__code.html#ga6e021f179fc712de402af1043ca1a9ef">SendMsg</a>(<a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3eaf1ce01387d2348f8b858721a7db81670">S</a>, <span class="stringliteral">&quot;&quot;</span>, 0);</div><div class="line">                                        nextS = time(NULL)+60;</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#gae7b49ade5fe88e53a5f0dda94ae94b23">safeAck</a> = 0;</div><div class="line">                                }</div><div class="line"></div><div class="line"><span class="comment">//                      if (verbose) printf(&quot;%s: SA Set Safe Output to High\r\n&quot;, MODULE_NAME);</span></div><div class="line">                                <span class="keywordflow">switch</span>(<a class="code" href="group__zephyr__header.html#gafbce215e681be701ae5373fd692dd9ba">hwversion</a>)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">case</span> 3:</div><div class="line">                                                <a class="code" href="group__zephyr__code.html#ga7e696bce041fca9cc1924bcd65cbc503">set_safe</a>(<a class="code" href="group__roc2__header.html#gad76d1750a6cdeebd506bfcd6752554d2">ON</a>);</div><div class="line">                                                <span class="keywordflow">break</span>;</div><div class="line">                                        <span class="keywordflow">default</span>:</div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio193/value&quot;</span>);                 <span class="comment">// Set SAFE digital output to high</span></div><div class="line">                                                <span class="keywordflow">break</span>;</div><div class="line">                                }</div><div class="line"><span class="comment">//                              nextImr = time(NULL) + 10000000;</span></div><div class="line"></div><div class="line">                                <span class="keywordflow">if</span> ((nextFile = <a class="code" href="group__zephyr__code.html#gab66e64dd30463cea0a06ac33c9cb3522">GetNextFile</a>()) &amp;&amp; !<a class="code" href="group__zephyr__header.html#gac292f396289364d78037cae452f1aefc">waitingAck</a>)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">if</span> (strstr(nextFile,<span class="stringliteral">&quot;list.txt&quot;</span>)) {</div><div class="line">                                                <a class="code" href="group__zephyr__header.html#gade6c9212e8175f2f26cb4ffa27f6f71c">TCflag</a> = 1;</div><div class="line">                                                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#ga57408962695c0061aac03bb3a81b9658">TClastPart</a>==<a class="code" href="group__zephyr__header.html#gad4b9eb4866c26710cf777628af77626e">TCnumParts</a>)              <span class="comment">// we finished the previous file, starting a new one</span></div><div class="line">                                                {</div><div class="line">                                                        strcpy(<a class="code" href="group__zephyr__header.html#ga9de05a1c8882446cef651d95cb8c03f8">TCfileOffload</a>, nextFile);</div><div class="line">                                                }</div><div class="line">                                                <a class="code" href="group__zephyr__code.html#gaf672e15ff453fe857ab4ce7de925f34a">TCSendFile</a>(<a class="code" href="group__zephyr__header.html#ga9de05a1c8882446cef651d95cb8c03f8">TCfileOffload</a>);</div><div class="line">                                        } <span class="keywordflow">else</span> {</div><div class="line">                                                <a class="code" href="group__zephyr__header.html#gade6c9212e8175f2f26cb4ffa27f6f71c">TCflag</a> = 0;</div><div class="line">                                                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#ga7d97c19b1f965c9fdcefe9e9c83fe126">lastPart</a>==<a class="code" href="group__zephyr__header.html#gaa37266c0efaae4ac2d8a5fbba8341a9e">numParts</a>)  {       <span class="comment">// we finished the previous file, starting a new one</span></div><div class="line">                                                        <a class="code" href="group__zephyr__header.html#ga9ad65e907dc15f9fd37da381332b2f1f">dataTm</a> = 0;</div><div class="line">                                                        <a class="code" href="group__zephyr__code.html#ga6e021f179fc712de402af1043ca1a9ef">SendMsg</a>(<a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3eac0f142a65b7d596e898b5ede310ac154">TM</a>, <span class="stringliteral">&quot;&quot;</span>, 0);</div><div class="line">                                                        <a class="code" href="group__zephyr__header.html#gac292f396289364d78037cae452f1aefc">waitingAck</a>=<a class="code" href="group__zephyr__header.html#ga7f970a76fd7cbf3dd6143df7262bbccc">WAITFORACK</a>;</div><div class="line">                                                        <a class="code" href="group__zephyr__code.html#gabf9cb423a606dc4f8232d1b3394042d5">RemoveFile</a>(nextFile);</div><div class="line">                                                } <span class="keywordflow">else</span> {</div><div class="line">                                                        <a class="code" href="group__zephyr__code.html#ga184ae444081beacfe0bd5b712d378b59">SendFile</a>(<a class="code" href="group__zephyr__header.html#gad9de7f17717cd6e46d8f5f4e869a4bd1">fileOffload</a>);</div><div class="line">                                                }</div><div class="line">                                        }</div><div class="line">                                }</div><div class="line"></div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                                </div><div class="line">                        <span class="keywordflow">case</span> <a name="a57"></a><a class="code" href="group__zephyr__header.html#gga1a6b6fb557d8d37d59700faf4e4c9167a9b01ce700b7e6a55a2bd1f0b5c0be748">EF</a>:                <span class="comment">// End flight mode. Shutdown, stop all Zephyr comms.</span></div><div class="line"><span class="comment">//                              system(&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio233/value&quot;);                 // Set 5V Off</span></div><div class="line"><span class="comment">//                              shutdown = TRUE;        // I thought we were supposed to shut down here but that&#39;s apparently not correct.</span></div><div class="line"><span class="comment">//                              quit=1;                         // Just do nothing for now.</span></div><div class="line">                                <span class="keywordflow">if</span> (<a class="code" href="group__zephyr__header.html#gafd6a133642d784682fb4eb4c33ca2bd8">modeSwitch</a>) {</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#gafd6a133642d784682fb4eb4c33ca2bd8">modeSwitch</a> = 0;</div><div class="line"><span class="comment">//                                      system(&quot;echo \&quot; \&quot; &gt; /dev/ttyAPP2&quot;);            // wakeup</span></div><div class="line">                                }</div><div class="line"></div><div class="line"><span class="comment">//                              nextImr = time(NULL) + 10000000;</span></div><div class="line">                                <span class="keywordflow">if</span>((nextFile = <a class="code" href="group__zephyr__code.html#gab66e64dd30463cea0a06ac33c9cb3522">GetNextFile</a>()) &amp;&amp; (<a class="code" href="group__zephyr__header.html#gac292f396289364d78037cae452f1aefc">waitingAck</a>==0))</div><div class="line">                                {</div><div class="line">                                        <a class="code" href="group__zephyr__code.html#gabf9cb423a606dc4f8232d1b3394042d5">RemoveFile</a>(nextFile);</div><div class="line">                                }</div><div class="line"></div><div class="line">                                <a class="code" href="group__zephyr__header.html#gac380ae62365b5574461d06a4c004d681">safeTimeout</a> = <a class="code" href="group__zephyr__header.html#ga3b02c8218b4fda72755b780d51977c38">SAFETIMEOUT</a>;</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        <span class="keywordflow">default</span>:</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">                </div><div class="line">                <span class="keywordflow">if</span>(poll (fds, 1, 10)) {</div><div class="line"><span class="comment">//                      if ((fds [1].revents &amp; POLLIN) || ((data_readptr-1) &gt; data_endptr))</span></div><div class="line">                        <span class="keywordflow">if</span> (fds [0].revents &amp; POLLIN)           <span class="comment">// incoming data on Zephyr serial port</span></div><div class="line">                        {</div><div class="line">                                err = ioctl(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga5c82fa58c263d40b70b737c5efa07ef0">fp</a>, FIONREAD, &amp;i);</div><div class="line">                                <span class="keywordflow">if</span>(err)</div><div class="line">                                {</div><div class="line">                                        fprintf(stderr,<span class="stringliteral">&quot;%s: I/O error, exiting.&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                                        <a name="a58"></a><a class="code" href="group__zephyr__header.html#ga5161d377a61befc3f8103e794d5cb582">shutdown</a> = <a name="a59"></a><a class="code" href="group__roc2__header.html#gaa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line">                                        <a class="code" href="group__roc2__header.html#ga2896431d6a80cd39b3d24b40237612ee">quit</a>=<a name="a60"></a><a class="code" href="group__roc2__header.html#gaa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line">                                }</div><div class="line"></div><div class="line">        <span class="comment">//                      if(verbose) printf(&quot;%d bytes ready to read from %s\r\n&quot;,i, gps_data.port);</span></div><div class="line">                                <span class="keywordflow">if</span>((readptr + i - readbuf) &gt; <a class="code" href="group__zephyr__header.html#gab3f00dac33458432279d4308226d8413">INBUFSIZE</a>) <span class="comment">// Serial read will overrun buffer if we do it</span></div><div class="line">                                {</div><div class="line">                                        fprintf(stderr, <span class="stringliteral">&quot;%s: Serial buffer overrun. Data lost!\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                                        readptr=readbuf;</div><div class="line">                                        memset(readbuf, 0, <span class="keyword">sizeof</span>(readbuf));</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">else</span></div><div class="line">                                {</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#gac380ae62365b5574461d06a4c004d681">safeTimeout</a> = <a class="code" href="group__zephyr__header.html#ga3b02c8218b4fda72755b780d51977c38">SAFETIMEOUT</a>;      <span class="comment">// Enter safety mode if no data from Zephyr in 10 minutes</span></div><div class="line">        <span class="comment">//                              printf(&quot;readbuf=%x  readptr=%x\r\n&quot;,readbuf,readptr);</span></div><div class="line">                                        numread = read(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga5c82fa58c263d40b70b737c5efa07ef0">fp</a>, readptr, i);</div><div class="line">                                        readptr += numread;</div><div class="line">        <span class="comment">//                              printf(&quot;first char = 0x%d\r\n&quot;,readbuf[0]);</span></div><div class="line">                                        <span class="keywordflow">if</span>(strstr(readbuf, <span class="stringliteral">&quot;&lt;/CRC&gt;\n&quot;</span>))                 <span class="comment">// Found end of a message</span></div><div class="line">                                        {</div><div class="line">                                                readptr=readbuf;</div><div class="line">                                                <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(readbuf);</div><div class="line">                                                fflush(stdout);</div><div class="line">                                                <span class="keywordflow">while</span>(endptr=strstr(readptr, <span class="stringliteral">&quot;&lt;/CRC&gt;\n&quot;</span>))</div><div class="line">                                                {</div><div class="line">                                                        sscanf(readptr,<span class="stringliteral">&quot;&lt;%s&gt;&quot;</span>,InMsgTypeStr);</div><div class="line">                                                        InMsgTypeStr[strlen(InMsgTypeStr)-1]=0;         <span class="comment">// Remove trailing &gt;</span></div><div class="line">                                                        InMsgType=<a name="a61"></a><a class="code" href="group__zephyr__code.html#ga224d36d32fdd9a46fced3ac36c639169">MsgType</a>(InMsgTypeStr);</div><div class="line">                                                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Received message type %d\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, InMsgType);</div><div class="line">                                                        <a name="a62"></a><a class="code" href="group__zephyr__code.html#ga4420395a38828d6be4aae8646268d258">MsgHandler</a>(InMsgType, readbuf);</div><div class="line">                                                        readptr=endptr+strlen(<span class="stringliteral">&quot;&lt;/CRC&gt;\n&quot;</span>);</div><div class="line"></div><div class="line">                                                        <a name="a63"></a><a class="code" href="group__zephyr__header.html#gafe4816e53e5d7a1264d7b0eec60b7eb9">nextMsgTime</a>.tv_nsec += 300000000;                                               <span class="comment">// next message (1 sec from now)</span></div><div class="line">                                                        <span class="keywordflow">if</span> (<a class="code" href="group__zephyr__header.html#gafe4816e53e5d7a1264d7b0eec60b7eb9">nextMsgTime</a>.tv_nsec &gt; 1000000000) {</div><div class="line">                                                                <a class="code" href="group__zephyr__header.html#gafe4816e53e5d7a1264d7b0eec60b7eb9">nextMsgTime</a>.tv_nsec -= 1000000000;                                              <span class="comment">// next message (1 sec from now)</span></div><div class="line">                                                                <a class="code" href="group__zephyr__header.html#gafe4816e53e5d7a1264d7b0eec60b7eb9">nextMsgTime</a>.tv_sec += 1;                                                <span class="comment">// next message (1 sec from now)</span></div><div class="line">                                                        }</div><div class="line">                                                }</div><div class="line">                                                readptr=readbuf;</div><div class="line">                                                memset(readbuf, 0, <span class="keyword">sizeof</span>(readbuf));</div><div class="line">                                        }</div><div class="line">                                        <span class="keywordflow">else</span></div><div class="line">                                        {</div><div class="line">        <span class="comment">//                                      printf(&quot;read %d bytes\r\n&quot;,numread);</span></div><div class="line">        <span class="comment">//                                      printf(readbuf);</span></div><div class="line">        <span class="comment">//                                      fflush(stdout);</span></div><div class="line">                                        }</div><div class="line">                                                </div><div class="line">                                }</div><div class="line">                        }</div><div class="line">                } </div><div class="line"><span class="comment">//              else</span></div><div class="line"><span class="comment">//              {</span></div><div class="line"><span class="comment">//                      if(time(NULL) &gt; safeTimeout)    // Haven&#39;t heard from Zephyr in over 2 hours, enter Safety mode</span></div><div class="line"><span class="comment">//                      {</span></div><div class="line"><span class="comment">//                              InstMode = SA;</span></div><div class="line"><span class="comment">//                      }</span></div><div class="line"><span class="comment">//              }</span></div><div class="line">        }</div><div class="line"></div><div class="line">        <a name="a64"></a><a class="code" href="group__zephyr__code.html#ga40809263d9e34d3d93cdb0eed73db857">ZephyrCleanup</a>();</div><div class="line">        printf(<span class="stringliteral">&quot;%s: Module stopped.\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line"></div><div class="line">        exit(<a name="a65"></a><a class="code" href="group__roc2__header.html#ga416de92c0d71270e5d9eb87ba5853e39">BCSUCCESS</a>);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#ga4420395a38828d6be4aae8646268d258">MsgHandler</a>(<span class="keyword">enum</span> <a class="code" href="group__zephyr__header.html#ga10a0f35066079abd150539d0d13dbf3e">msg</a> msgtype, <span class="keywordtype">char</span> *msgdata)</div><div class="line">{</div><div class="line">        <span class="keywordflow">switch</span>(msgtype)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> <a name="a66"></a><a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea162f8ad933bb692377c68dae033e50a5">IM</a>:</div><div class="line">                        <span class="keywordflow">return</span>(<a name="a67"></a><a class="code" href="group__zephyr__code.html#gac8252c63f3bdc239fbdf6fbd93d40c76">HandleIM</a>(msgdata));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a name="a68"></a><a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea9379400f962d840155ba4d20e8a05f43">SAck</a>:</div><div class="line">                        <span class="keywordflow">return</span>(<a name="a69"></a><a class="code" href="group__zephyr__code.html#gac5b4e6f9b660a68301b5cd686040e61a">HandleSAck</a>(msgdata));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a name="a70"></a><a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea247b880fc48dc1c74961ba58ae0f68a2">SW</a>:</div><div class="line">                        <span class="keywordflow">return</span>(<a name="a71"></a><a class="code" href="group__zephyr__code.html#ga81340cc09bb1fbb59c968fa3d3b41064">HandleSW</a>(msgdata));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a name="a72"></a><a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea24ef62bfe96b185bf5737652c028b4df">TMAck</a>:</div><div class="line">                        <span class="keywordflow">if</span>(<a name="a73"></a><a class="code" href="group__zephyr__code.html#ga405decabf57ea3d65a9fea453e4a2fa3">HandleTMAck</a>(msgdata))</div><div class="line">                        {</div><div class="line">                                <a class="code" href="group__zephyr__header.html#gac292f396289364d78037cae452f1aefc">waitingAck</a>=0;</div><div class="line">                                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#ga9ad65e907dc15f9fd37da381332b2f1f">dataTm</a>)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">if</span> (<a class="code" href="group__zephyr__header.html#gade6c9212e8175f2f26cb4ffa27f6f71c">TCflag</a>) {</div><div class="line">                                                <a class="code" href="group__zephyr__header.html#ga57408962695c0061aac03bb3a81b9658">TClastPart</a>++;</div><div class="line">                                                <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Rcvd TMAck. File %s Part %d/%d\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>,<a class="code" href="group__zephyr__header.html#ga9de05a1c8882446cef651d95cb8c03f8">TCfileOffload</a>,<a class="code" href="group__zephyr__header.html#ga57408962695c0061aac03bb3a81b9658">TClastPart</a>,<a class="code" href="group__zephyr__header.html#gad4b9eb4866c26710cf777628af77626e">TCnumParts</a>);</div><div class="line">                                                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#ga57408962695c0061aac03bb3a81b9658">TClastPart</a>==<a class="code" href="group__zephyr__header.html#gad4b9eb4866c26710cf777628af77626e">TCnumParts</a>)              <span class="comment">// done with file transfer</span></div><div class="line">                                                {</div><div class="line">                                                        <a class="code" href="group__zephyr__code.html#gabf9cb423a606dc4f8232d1b3394042d5">RemoveFile</a>(<a class="code" href="group__zephyr__header.html#ga9de05a1c8882446cef651d95cb8c03f8">TCfileOffload</a>);</div><div class="line">                                                        <a class="code" href="group__zephyr__header.html#gade6c9212e8175f2f26cb4ffa27f6f71c">TCflag</a> = 0;</div><div class="line">                                                }</div><div class="line">                                        } <span class="keywordflow">else</span> {</div><div class="line">                                                <a class="code" href="group__zephyr__header.html#ga7d97c19b1f965c9fdcefe9e9c83fe126">lastPart</a>++;</div><div class="line">                                                <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Rcvd TMAck. File %s Part %d/%d\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>,<a class="code" href="group__zephyr__header.html#gad9de7f17717cd6e46d8f5f4e869a4bd1">fileOffload</a>,<a class="code" href="group__zephyr__header.html#ga7d97c19b1f965c9fdcefe9e9c83fe126">lastPart</a>,<a class="code" href="group__zephyr__header.html#gaa37266c0efaae4ac2d8a5fbba8341a9e">numParts</a>);</div><div class="line">                                                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#ga7d97c19b1f965c9fdcefe9e9c83fe126">lastPart</a>==<a class="code" href="group__zephyr__header.html#gaa37266c0efaae4ac2d8a5fbba8341a9e">numParts</a>)          <span class="comment">// done with file transfer</span></div><div class="line">                                                {</div><div class="line">                                                        <a class="code" href="group__zephyr__code.html#gabf9cb423a606dc4f8232d1b3394042d5">RemoveFile</a>(<a class="code" href="group__zephyr__header.html#gad9de7f17717cd6e46d8f5f4e869a4bd1">fileOffload</a>);</div><div class="line">                                                }                                               </div><div class="line">                                        }</div><div class="line">                                        <span class="keywordflow">return</span>(1);</div><div class="line">                                }</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">else</span></div><div class="line">                        {</div><div class="line">                                <span class="keywordflow">return</span>(0);</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a name="a74"></a><a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3eae179015c05e581c38074e893dbf27840">TC</a>:</div><div class="line">                        <span class="keywordflow">return</span>(<a name="a75"></a><a class="code" href="group__zephyr__code.html#ga24fd4d56749147dbdfbb5817276010a8">HandleTC</a>(msgdata));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a name="a76"></a><a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea171ede81b49deebf3e342cdf41c62182">GPS</a>:</div><div class="line">                        <span class="keywordflow">return</span>(<a name="a77"></a><a class="code" href="group__zephyr__code.html#ga6f9ac83f838130b9d2723d02ae37562e">HandleGPS</a>(msgdata));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">return</span>(-1);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#gac8252c63f3bdc239fbdf6fbd93d40c76">HandleIM</a>(<span class="keywordtype">char</span> *msgdata)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> modestr[3]=<span class="stringliteral">&quot;&quot;</span>;</div><div class="line">        <span class="keywordtype">char</span> *loc;</div><div class="line">        <span class="keyword">enum</span> <a class="code" href="group__zephyr__header.html#ga1a6b6fb557d8d37d59700faf4e4c9167">mode</a> newmode;</div><div class="line"></div><div class="line">        <a class="code" href="group__zephyr__header.html#gaa37b17e868a3191ab989eeb7dc8cd393">waitingIM</a> = 0;</div><div class="line">        </div><div class="line">        loc=strstr(msgdata, <span class="stringliteral">&quot;&lt;Mode&gt;&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span> (loc == 0) {</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: HandleIM &lt;Mode&gt; not found, ERROR!!!\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                <span class="keywordflow">return</span>;</div><div class="line">        }</div><div class="line">        strncpy(modestr,loc+strlen(<span class="stringliteral">&quot;&lt;Mode&gt;&quot;</span>),2);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Switching to mode %s\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, modestr);</div><div class="line">        <a name="a78"></a><a class="code" href="group__zephyr__header.html#gabb86b381a046a6c970fefe4d03cf08ad">LastMode</a> = InstMode;            <span class="comment">// Save current inst mode</span></div><div class="line">        <span class="keywordflow">if</span>(strncmp(modestr, <span class="stringliteral">&quot;FL&quot;</span>, 2)==0)        <span class="comment">///&lt; Switch to flight mode</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                newmode=<a class="code" href="group__zephyr__header.html#gga1a6b6fb557d8d37d59700faf4e4c9167a23f8b9ced0e0612b05e87ffd678d19f7">FL</a>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(modestr, <span class="stringliteral">&quot;SB&quot;</span>, 2)==0)   <span class="comment">///&lt; Switch to Standby mode</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                newmode=<a class="code" href="group__zephyr__header.html#gga1a6b6fb557d8d37d59700faf4e4c9167ad3000f705564090d2acd1d320ccc5135">SB</a>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(modestr, <span class="stringliteral">&quot;LP&quot;</span>, 2)==0)   <span class="comment">///&lt; Switch to Low Power mode</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                newmode=<a class="code" href="group__zephyr__header.html#gga1a6b6fb557d8d37d59700faf4e4c9167a417c69b8c9313307f484fd52ea61db84">LP</a>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(modestr, <span class="stringliteral">&quot;SA&quot;</span>, 2)==0)   <span class="comment">///&lt; Switch to Safety mode</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                newmode=<a class="code" href="group__zephyr__header.html#gga1a6b6fb557d8d37d59700faf4e4c9167ac4d318ef07bfe697b043d75065f90349">SA</a>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(modestr, <span class="stringliteral">&quot;EF&quot;</span>, 2)==0)   <span class="comment">///&lt; Switch to End Flight mode</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                newmode=<a class="code" href="group__zephyr__header.html#gga1a6b6fb557d8d37d59700faf4e4c9167a9b01ce700b7e6a55a2bd1f0b5c0be748">EF</a>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Unknown mode change request: %s\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, modestr);</div><div class="line">                <span class="keywordflow">return</span>(-1);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Now in mode %d\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, newmode);</div><div class="line">        <span class="keywordflow">if</span> ((InstMode != newmode) || (newmode==<a class="code" href="group__zephyr__header.html#gga1a6b6fb557d8d37d59700faf4e4c9167ac4d318ef07bfe697b043d75065f90349">SA</a>)) {</div><div class="line">                <a class="code" href="group__zephyr__header.html#gafd6a133642d784682fb4eb4c33ca2bd8">modeSwitch</a> = 1;</div><div class="line"><span class="comment">// Do wake up when coming out of LP,SA or EF since we may have been gone to SA or EF from LP</span></div><div class="line">                <span class="keywordflow">if</span> (InstMode == <a class="code" href="group__zephyr__header.html#gga1a6b6fb557d8d37d59700faf4e4c9167a417c69b8c9313307f484fd52ea61db84">LP</a>) {</div><div class="line"><span class="comment">//                      if ((newmode == FL) || (newmode == SB)) {</span></div><div class="line">                                <a class="code" href="group__zephyr__header.html#ga4388415ac8b79e24f68e40759a23651f">wakeUpFlag</a> = 1; <span class="comment">// only toggle wake up after low power mode</span></div><div class="line"><span class="comment">//                      }</span></div><div class="line">                }</div><div class="line"></div><div class="line"><span class="comment">// Do wake up when coming out of SA or EF since we may have been gone to SA or EF from LP</span></div><div class="line"><span class="comment">//              if ((InstMode == SA) || (InstMode == EF)) {</span></div><div class="line"><span class="comment">//                      wakeUpFlag = 1; // only toggle wake up after low power mode</span></div><div class="line"><span class="comment">//              }</span></div><div class="line">        } </div><div class="line">        InstMode = newmode;</div><div class="line">        <a class="code" href="group__zephyr__code.html#ga6e021f179fc712de402af1043ca1a9ef">SendMsg</a>(<a name="a79"></a><a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea7f6a37befbb900cb0a526b9a5c349c70">IMAck</a>, <span class="stringliteral">&quot;&quot;</span>, 0);</div><div class="line">        <span class="comment">//if(newmode==SA)</span></div><div class="line">        <span class="comment">//{</span></div><div class="line">        <span class="comment">//      SendMsg(S, &quot;&quot;, 0);              // We need to send an S msg every time Zephyr sends us IM.S</span></div><div class="line">        <span class="comment">//}</span></div><div class="line"><span class="comment">//      nextImr = time(NULL) + 10000000;                // Set timer way into future so no more IMR msgs go out</span></div><div class="line"><span class="comment">//      return(newmode);</span></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#gac5b4e6f9b660a68301b5cd686040e61a">HandleSAck</a>(<span class="keywordtype">char</span> *msgdata)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> ackstr[4]=<span class="stringliteral">&quot;&quot;</span>;</div><div class="line">        <span class="keywordtype">char</span> *loc;</div><div class="line">        </div><div class="line">        loc=strstr(msgdata, <span class="stringliteral">&quot;&lt;Ack&gt;&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span> (loc == 0) {</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: HandleSAck &lt;Ack&gt; not found, ERROR!!!\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                <span class="keywordflow">return</span> (0);</div><div class="line">        }</div><div class="line">        strncpy(ackstr,loc+strlen(<span class="stringliteral">&quot;&lt;Ack&gt;&quot;</span>),3);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Ack is %s\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, ackstr);</div><div class="line">        <span class="keywordflow">if</span>(!strncmp(ackstr,<span class="stringliteral">&quot;ACK&quot;</span>,3)) </div><div class="line">        {</div><div class="line">                <a class="code" href="group__zephyr__header.html#gae7b49ade5fe88e53a5f0dda94ae94b23">safeAck</a> = 1;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> </div><div class="line">        {</div><div class="line">                <a class="code" href="group__zephyr__header.html#gae7b49ade5fe88e53a5f0dda94ae94b23">safeAck</a> = 0;</div><div class="line">        }</div><div class="line">        </div><div class="line">        <span class="keywordflow">return</span>(<a class="code" href="group__zephyr__header.html#gae7b49ade5fe88e53a5f0dda94ae94b23">safeAck</a>);</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#ga81340cc09bb1fbb59c968fa3d3b41064">HandleSW</a>(<span class="keywordtype">char</span> *msgdata)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Received shutdown warning.\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#ga405decabf57ea3d65a9fea453e4a2fa3">HandleTMAck</a>(<span class="keywordtype">char</span> *msgdata)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> ackstr[4]=<span class="stringliteral">&quot;&quot;</span>;</div><div class="line">        <span class="keywordtype">char</span> *loc;</div><div class="line">        </div><div class="line">        loc=strstr(msgdata, <span class="stringliteral">&quot;&lt;Ack&gt;&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span> (loc == 0) {</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Handle TMAck &lt;Ack&gt; not found, ERROR!!!\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                <span class="keywordflow">return</span> (0);</div><div class="line">        }</div><div class="line">        strncpy(ackstr,loc+strlen(<span class="stringliteral">&quot;&lt;Ack&gt;&quot;</span>),3);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Ack is %s\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, ackstr);</div><div class="line">        <span class="keywordflow">if</span>(!strncmp(ackstr,<span class="stringliteral">&quot;ACK&quot;</span>,3)) <span class="keywordflow">return</span>(1);</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">return</span>(0);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/** @brief  HandleTC() reads the TC commands and returns a terminal echo of the response</span></div><div class="line"><span class="comment"> *      </span></div><div class="line"><span class="comment"> *      1. To carry out a telecommand (TC), user types in the linux command in &#39;cmd&#39; under /root/LV/TC_Files. Note: Only one file can exist here at a time</span></div><div class="line"><span class="comment"> *      2. Zephyr wraps cmd in standard XML format and sends to ROC</span></div><div class="line"><span class="comment"> *      3. HandleTC() decipher XML format and reads the linux command</span></div><div class="line"><span class="comment"> *      4. HandleTC() compares the command to the list and executes it</span></div><div class="line"><span class="comment"> *      5. HandleTC() copies linux terminal output to file under /queue, which is automatically sent back to Zephyr Module</span></div><div class="line"><span class="comment"> *      </span></div><div class="line"><span class="comment"> *      @param *msgdata pointer to the zephyr TC file containing TC instructions</span></div><div class="line"><span class="comment"> *      @return 0 on error</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#ga24fd4d56749147dbdfbb5817276010a8">HandleTC</a>(<span class="keywordtype">char</span> *msgdata)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> lenstr[8]=<span class="stringliteral">&quot;&quot;</span>;</div><div class="line">        <span class="keywordtype">char</span> cmdstr[128];</div><div class="line">        <span class="keywordtype">char</span> *loc, *payload, *filename;</div><div class="line">        <span class="keywordtype">int</span> len, doit;</div><div class="line">        FILE *f;</div><div class="line">        </div><div class="line">        loc=strstr(msgdata, <span class="stringliteral">&quot;&lt;Length&gt;&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span> (loc == 0) {</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: HandleTC &lt;Length&gt; not found, ERROR!!!\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                <span class="keywordflow">return</span> (0);</div><div class="line">        }</div><div class="line">        sscanf(loc+strlen(<span class="stringliteral">&quot;&lt;Length&gt;&quot;</span>),<span class="stringliteral">&quot;%d&quot;</span>,&amp;len);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Rcvd TC msg. Payload is %d bytes\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, len);</div><div class="line">        payload=malloc(len);</div><div class="line">        </div><div class="line">        loc=strstr(msgdata, <span class="stringliteral">&quot;&lt;/CRC&gt;\n&quot;</span>)+strlen(<span class="stringliteral">&quot;&lt;/CRC&gt;\n&quot;</span>);             <span class="comment">// point to beginning of binary section</span></div><div class="line">        <span class="keywordflow">if</span> (loc == 0) {</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: HandleTC &lt;/CRC&gt; not found, ERROR!!!\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                free(payload);</div><div class="line">                <span class="keywordflow">return</span> (0);</div><div class="line">        }</div><div class="line">        <span class="comment">//printf(&quot;LOC:%c&quot;, loc[0]);</span></div><div class="line">        loc+=strlen(<span class="stringliteral">&quot;START&quot;</span>);                                                                   <span class="comment">// skip over binary section header</span></div><div class="line">        memcpy(payload, loc, len);                                                              <span class="comment">// copy payload into buffer</span></div><div class="line">        <span class="comment">//printf(&quot;:%c:%2.2s\n&quot;, loc[0], payload);</span></div><div class="line">        </div><div class="line"><span class="comment">/*      loc=strstr(payload,&quot;!!&quot;);                                                               // search for !! that separates filename from data</span></div><div class="line"><span class="comment">        filename=malloc(strlen(pathUpload)+(loc-payload));              // allocate space for name of upload file</span></div><div class="line"><span class="comment">        memcpy(filename, pathUpload, strlen(pathUpload));               // copy upload directory into filename</span></div><div class="line"><span class="comment">        memcpy(filename+strlen(pathUpload), payload, loc-payload);                              // copy filename</span></div><div class="line"><span class="comment">        loc+=2;                                                                                                 // point to beginning of data</span></div><div class="line"><span class="comment">        </span></div><div class="line"><span class="comment">        f = fopen(filename, &quot;w&quot;);</span></div><div class="line"><span class="comment">        printf(&quot;Writing %s to file %s\r\n&quot;, loc, filename);</span></div><div class="line"><span class="comment">        fwrite(loc, 1, len-(loc-payload), f);</span></div><div class="line"><span class="comment">        fclose(f); */</span></div><div class="line">        </div><div class="line">        <a class="code" href="group__zephyr__code.html#ga6e021f179fc712de402af1043ca1a9ef">SendMsg</a>(<a name="a80"></a><a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea7e72124ca75fccf172d7c0888e3d8e98">TCAck</a>, <span class="stringliteral">&quot;&quot;</span>, 0);</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(memmem(payload, len, <span class="stringliteral">&quot;ls&quot;</span>, strlen(<span class="stringliteral">&quot;ls&quot;</span>)))    <span class="comment">// do &quot;ls -1&quot; on queue and put results in file for offload</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;ls -l /data/roc/queue &gt; /data/roc/queue/list.txt&quot;</span>);</div><div class="line">                doit=1;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(memmem(payload, len, <span class="stringliteral">&quot;reboot&quot;</span>, strlen(<span class="stringliteral">&quot;reboot&quot;</span>)))       <span class="comment">// reboot ROC</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;reboot&quot;</span>);       </div><div class="line">                doit=1;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(memmem(payload, len, <span class="stringliteral">&quot;clear&quot;</span>, strlen(<span class="stringliteral">&quot;clear&quot;</span>))) <span class="comment">// clear download queue</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;rm %s/*&quot;</span>,<a name="a81"></a><a class="code" href="group__roc2__header.html#gaf3e7ebf92f13594acf3ba281bcfd1c0b">queueDir</a>);</div><div class="line">                doit=0;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Executing command &#39;%s&#39;\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, cmdstr);</div><div class="line">        <span class="keywordflow">if</span>(doit) system(cmdstr);</div><div class="line"></div><div class="line">        </div><div class="line">        free(payload);</div><div class="line"><span class="comment">//      free(filename);</span></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#ga6f9ac83f838130b9d2723d02ae37562e">HandleGPS</a>(<span class="keywordtype">char</span> *msgdata)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Received GPS message.\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Performs module initialization</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// Calls LoadConfigFileSettings() to load the configuration file settings for this module and calls</span></div><div class="line"><span class="comment">/// CmdLineHandler() to handle any command line options. Finally configures a ZMQ REP</span></div><div class="line"><span class="comment">/// socket to listen for messages from other modules.</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// \param argc Number of command line arguments passed to main().</span></div><div class="line"><span class="comment">/// \param argv[] List of command line arguments passed to main().</span></div><div class="line"><span class="comment">/// \return</span></div><div class="line"><span class="comment">/// - BCSUCCESS if successful.</span></div><div class="line"><span class="comment">/// - BCCONFIGREADERROR indicates an error in LoadConfigFileSettings().</span></div><div class="line"><span class="comment">/// - BCCMDLINEERROR indicates an error in CmdLineHandler().</span></div><div class="line"><span class="comment">/// - BCZMQOPTERROR indicates an error setting the options of a ZMQ socket.</span></div><div class="line"><span class="comment">/// - BCMODLISTERROR indicates an error in PopulateModules().</span></div><div class="line"><span class="comment">/// - BCZMQBINDERROR indicates an error binding the ZMQ REP socket.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#ga26a5cd9326852a6f3a89225c8642479b">ZephyrInit</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> err, port;</div><div class="line"></div><div class="line">        <a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a> = <a class="code" href="group__roc2__header.html#gaa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line">        <a class="code" href="group__roc2__header.html#ga2896431d6a80cd39b3d24b40237612ee">quit</a> = <a class="code" href="group__roc2__header.html#gaa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line"></div><div class="line">        fclose(stdin);</div><div class="line"></div><div class="line">        <span class="comment">// Read config file</span></div><div class="line">        <span class="keywordflow">if</span>(<a name="a82"></a><a class="code" href="group__zephyr__code.html#ga8ed0e63e6cf78544f92b023037e3e7b8">LoadConfigFileSettings</a>(&amp;<a name="a83"></a><a class="code" href="group__zephyr__header.html#gaac92057dcdbc7740fb0c9166a6002229">cfgZephyr</a>, <a name="a84"></a><a class="code" href="group__zephyr__header.html#gaa33b085cbf737c4c0159e57eb661da0d">pathCfgZephyr</a>) != <a class="code" href="group__roc2__header.html#ga416de92c0d71270e5d9eb87ba5853e39">BCSUCCESS</a>)</div><div class="line">                <span class="keywordflow">return</span>(<a name="a85"></a><a class="code" href="group__roc2__header.html#gacc734db768f05ebce6e4e985e44f46c5">BCCONFIGREADERROR</a>);              </div><div class="line"></div><div class="line">        <span class="comment">// Parse command line options</span></div><div class="line">        <span class="keywordflow">if</span>(<a name="a86"></a><a class="code" href="group__zephyr__code.html#ga5dbf303fd2c465b1e724a247623fdbd2">CmdLineHandler</a>(argc, argv) != <a class="code" href="group__roc2__header.html#ga416de92c0d71270e5d9eb87ba5853e39">BCSUCCESS</a>)</div><div class="line">        {</div><div class="line">                <a name="a87"></a><a class="code" href="group__zephyr__code.html#ga40185ea52d16cecaafae70740e90af29">Usage</a>();</div><div class="line">                <span class="keywordflow">return</span>(<a name="a88"></a><a class="code" href="group__roc2__header.html#ga2e4e582aaaf87aeeb9f5cce7b1be9794">BCCMDLINEERROR</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Set up serial ports</span></div><div class="line">        err = <a name="a89"></a><a class="code" href="group__zephyr__code.html#ga919ac26442368faff61c89f0f62fd58b">SerialPortInit</a>(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>);</div><div class="line">        <span class="keywordflow">if</span>(err != <a class="code" href="group__roc2__header.html#ga416de92c0d71270e5d9eb87ba5853e39">BCSUCCESS</a>)</div><div class="line">                <span class="keywordflow">return</span>(err);</div><div class="line">        </div><div class="line">        <span class="comment">// Set up data logging</span></div><div class="line"><span class="comment">//      CreateDayDirectory();</span></div><div class="line"><span class="comment">//      OpenLogFile(MODULE_NAME);</span></div><div class="line"><span class="comment">//      clock_gettime(CLOCK_REALTIME, &amp;now);    // use internal clock for now. Eventually get times from data blocks</span></div><div class="line"><span class="comment">//      nextfile.tv_sec = now.tv_sec + file_len;</span></div><div class="line"><span class="comment">//      nextfile.tv_nsec = now.tv_nsec;</span></div><div class="line">        </div><div class="line">        <a class="code" href="group__zephyr__header.html#gad4d4536ebc16bcd99fca3934346c8372">poweroffgps</a> = 0;</div><div class="line">        <a name="a90"></a><a class="code" href="group__zephyr__header.html#ga8d5fb6f3fe9be9941e57854d5c3f2568">MsgID</a> = 0;</div><div class="line">        InstMode = <a class="code" href="group__zephyr__header.html#gga1a6b6fb557d8d37d59700faf4e4c9167ad3000f705564090d2acd1d320ccc5135">SB</a>;</div><div class="line">        <a class="code" href="group__zephyr__header.html#gafd6a133642d784682fb4eb4c33ca2bd8">modeSwitch</a> = 0;</div><div class="line">        <a class="code" href="group__zephyr__header.html#ga4388415ac8b79e24f68e40759a23651f">wakeUpFlag</a> = 0;</div><div class="line">        <a class="code" href="group__zephyr__header.html#gae7b49ade5fe88e53a5f0dda94ae94b23">safeAck</a> = 0;</div><div class="line">        <a class="code" href="group__zephyr__header.html#gaa37266c0efaae4ac2d8a5fbba8341a9e">numParts</a> = <a class="code" href="group__zephyr__header.html#gad4b9eb4866c26710cf777628af77626e">TCnumParts</a> = 0;</div><div class="line">        <a class="code" href="group__zephyr__header.html#ga7d97c19b1f965c9fdcefe9e9c83fe126">lastPart</a> = <a class="code" href="group__zephyr__header.html#ga57408962695c0061aac03bb3a81b9658">TClastPart</a> = 0;</div><div class="line">        <a class="code" href="group__zephyr__header.html#gac292f396289364d78037cae452f1aefc">waitingAck</a> = 0;</div><div class="line">        <a class="code" href="group__zephyr__header.html#gaa37b17e868a3191ab989eeb7dc8cd393">waitingIM</a> = 0;</div><div class="line">        <a class="code" href="group__zephyr__header.html#ga5161d377a61befc3f8103e794d5cb582">shutdown</a> = <a class="code" href="group__roc2__header.html#gaa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line">        <a class="code" href="group__zephyr__header.html#gac380ae62365b5574461d06a4c004d681">safeTimeout</a> = <a class="code" href="group__zephyr__header.html#ga3b02c8218b4fda72755b780d51977c38">SAFETIMEOUT</a>;              <span class="comment">// Enter Safe mode if we don&#39;t hear from Zephyr in 10 minutes</span></div><div class="line">        <a class="code" href="group__zephyr__header.html#ga52ca9e601c9d0389607ec95f1c49215e">lowPowerCheck</a> = <a class="code" href="group__zephyr__header.html#ga052dadad9560c0874f9dfeedae0ccb3b">LOWPOWERCHECK</a>;  <span class="comment">// Time Interval to check for low power state</span></div><div class="line">        <a class="code" href="group__zephyr__header.html#gaf8bedab821ee7f36762a64ac71e914a4">lowPowerCheckWait</a> = 5;                  <span class="comment">// wait an extra cycle before checking</span></div><div class="line">        <a class="code" href="group__zephyr__header.html#gaf7f4cea1c772506355074b09428675b7">discardFirstFile</a> = 0;</div><div class="line">        clock_gettime(CLOCK_REALTIME, &amp;<a class="code" href="group__zephyr__header.html#gafe4816e53e5d7a1264d7b0eec60b7eb9">nextMsgTime</a>);    <span class="comment">// OK to send msg at any time</span></div><div class="line">        <a class="code" href="group__zephyr__header.html#ga5b3e85b8b041c8b4a422f22faa6f87be">nextImr</a> = time(NULL)+5;</div><div class="line"></div><div class="line">        <span class="comment">// Set up named pipe</span></div><div class="line">        printf(<span class="stringliteral">&quot;%s: mkfifo returned %d\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, mkfifo(<a name="a91"></a><a class="code" href="group__roc2__header.html#gad68a72f177ed1f87cf7cc8325069d9a0">ipcPipe</a>, 0666));</div><div class="line">        <a name="a92"></a><a class="code" href="group__roc2__header.html#ga576d1db2a3cf8ffa97ba33bbb1420592">pipefp</a> = fopen(<a class="code" href="group__roc2__header.html#gad68a72f177ed1f87cf7cc8325069d9a0">ipcPipe</a>, <span class="stringliteral">&quot;r+&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga576d1db2a3cf8ffa97ba33bbb1420592">pipefp</a>)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Opened named pipe successfully\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Attempt to open named pipe returned %d\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, errno);</div><div class="line">        }</div><div class="line">        </div><div class="line">        <span class="keywordflow">switch</span>(<a class="code" href="group__zephyr__header.html#gafbce215e681be701ae5373fd692dd9ba">hwversion</a>)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> 3:</div><div class="line">                        <a class="code" href="group__zephyr__code.html#ga093f472d65a4478a2a23fa69ea593ef0">gps_power</a>(<a class="code" href="group__roc2__header.html#gad76d1750a6cdeebd506bfcd6752554d2">ON</a>);  <span class="comment">// Note: this also turns on power to LED&#39;s</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Init: Set Safe Export\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;193\&quot; &gt; /sys/class/gpio/export&quot;</span>);                                <span class="comment">// Prepare SAFE digital output</span></div><div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Init: Set Safe Direction\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;out\&quot; &gt; /sys/class/gpio/gpio193/direction&quot;</span>);             <span class="comment">// Set as output</span></div><div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Init: Set Safe Low\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio193/value&quot;</span>);                 <span class="comment">// Set value to low</span></div><div class="line">        </div><div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Init: Set nRST Export\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;200\&quot; &gt; /sys/class/gpio/export&quot;</span>);                                <span class="comment">// Prepare SAFE digital output</span></div><div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Init: Set nRST Direction\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;out\&quot; &gt; /sys/class/gpio/gpio200/direction&quot;</span>);             <span class="comment">// Set as output</span></div><div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Init: Set nRST Low\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio200/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line"></div><div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Init: Set TogglePwr Export\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;202\&quot; &gt; /sys/class/gpio/export&quot;</span>);                                <span class="comment">// Prepare SAFE digital output</span></div><div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Init: Set nRST Direction\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;out\&quot; &gt; /sys/class/gpio/gpio202/direction&quot;</span>);             <span class="comment">// Set as output</span></div><div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Init: Set nRST Low\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line"></div><div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Init: Set 5VPwr Export\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;233\&quot; &gt; /sys/class/gpio/export&quot;</span>);                                <span class="comment">// Prepare SAFE digital output</span></div><div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Init: Set 5VPwr Direction\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;out\&quot; &gt; /sys/class/gpio/gpio233/direction&quot;</span>);             <span class="comment">// Set as output</span></div><div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Init: Set 5VPwr High(on)\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio233/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">        </div><div class="line">        <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#ga416de92c0d71270e5d9eb87ba5853e39">BCSUCCESS</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Closes sockets and frees memory.</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// There will be some serial port clean up stuff in here.</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// \return Always returns BCSUCCESS</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#ga40809263d9e34d3d93cdb0eed73db857">ZephyrCleanup</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a name="a93"></a><a class="code" href="group__roc2__header.html#ga74b83d1a2e086188b8e87ca651f3a610">port</a>) free(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga74b83d1a2e086188b8e87ca651f3a610">port</a>);</div><div class="line">        <span class="keywordflow">if</span> (<a name="a94"></a><a class="code" href="group__roc2__header.html#ga12878be4d584d4841c7d409b8f024644">data_dir</a>) free(<a class="code" href="group__roc2__header.html#ga12878be4d584d4841c7d409b8f024644">data_dir</a>);</div><div class="line"></div><div class="line">        close(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga5c82fa58c263d40b70b737c5efa07ef0">fp</a>);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#ga5161d377a61befc3f8103e794d5cb582">shutdown</a>) system(<span class="stringliteral">&quot;shutdown now&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#ga416de92c0d71270e5d9eb87ba5853e39">BCSUCCESS</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Parses command line arguments.</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// \param argc Number of command line arguments passed to main().</span></div><div class="line"><span class="comment">/// \param argv[] List of command line arguments passed to main().</span></div><div class="line"><span class="comment">/// \return</span></div><div class="line"><span class="comment">/// - BCSUCCESS if successful</span></div><div class="line"><span class="comment">/// - BCERROR if there was an error parsing any of the command line options</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#ga5dbf303fd2c465b1e724a247623fdbd2">CmdLineHandler</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i;</div><div class="line"></div><div class="line">        opterr=0;</div><div class="line">        optind=0;       <span class="comment">// Reinitialize getopt()</span></div><div class="line"></div><div class="line">        <span class="keywordflow">while</span> ((i = getopt (argc, argv, <a name="a95"></a><a class="code" href="group__roc2__header.html#gac8ac8737a0d1260142bafa03c1f8e566">cloptions</a>)) != -1)</div><div class="line">        <span class="keywordflow">switch</span> (i)</div><div class="line">                {</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;v&#39;</span>:               <span class="comment">// &#39;v&#39; option turns on verbose mode</span></div><div class="line">                                <a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a> = <a class="code" href="group__roc2__header.html#gaa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line"><span class="comment">//                      case &#39;l&#39;:               // &#39;l&#39; option specifies data file length</span></div><div class="line"><span class="comment">//                              file_len=get_baud(atoi(optarg));</span></div><div class="line"><span class="comment">//                              if((file_len &lt; 0) || (file_len &gt; 3600))</span></div><div class="line"><span class="comment">//                              {</span></div><div class="line"><span class="comment">//                                      fprintf(stderr, &quot;%s: Invalid file length setting %s\r\n&quot;, MODULE_NAME, optarg);</span></div><div class="line"><span class="comment">//                                      return(BCERROR);</span></div><div class="line"><span class="comment">//                              }</span></div><div class="line"><span class="comment">//                              printf(&quot;File length = %d\r\n&quot;,file_len);</span></div><div class="line"><span class="comment">//                              break;</span></div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:               <span class="comment">// &#39;p&#39; option specifies serial port to use</span></div><div class="line">                                free(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga74b83d1a2e086188b8e87ca651f3a610">port</a>);</div><div class="line">                                <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga74b83d1a2e086188b8e87ca651f3a610">port</a> = malloc(strlen(optarg)+1);</div><div class="line">                                strcpy(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga74b83d1a2e086188b8e87ca651f3a610">port</a>, optarg);</div><div class="line">                                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga74b83d1a2e086188b8e87ca651f3a610">port</a> == NULL)</div><div class="line">                                {</div><div class="line">                                        fprintf(stderr, <span class="stringliteral">&quot;%s: Error setting serial port to %s\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>,optarg);</div><div class="line">                                        <span class="keywordflow">return</span>(<a name="a96"></a><a class="code" href="group__roc2__header.html#ga92d440cdd980e61a41b9238ca8d8cdc5">BCERROR</a>);</div><div class="line">                                }</div><div class="line">                                printf(<span class="stringliteral">&quot;Port = %s\r\n&quot;</span>,<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga74b83d1a2e086188b8e87ca651f3a610">port</a>);</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:               <span class="comment">// &#39;s&#39; option specifies serial port speed</span></div><div class="line">                                <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a name="a97"></a><a class="code" href="group__roc2__header.html#ga218b4f7c6cc2681a99c23a3b089d68b1">speed</a>=<a name="a98"></a><a class="code" href="group__zephyr__code.html#gaf890f66e1e86cf2e43aafd221eddabbd">get_baud</a>(atoi(optarg));</div><div class="line">                                <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga218b4f7c6cc2681a99c23a3b089d68b1">speed</a>=<a class="code" href="group__zephyr__code.html#gaf890f66e1e86cf2e43aafd221eddabbd">get_baud</a>(atoi(optarg));</div><div class="line">                                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga218b4f7c6cc2681a99c23a3b089d68b1">speed</a> == <a class="code" href="group__roc2__header.html#ga92d440cdd980e61a41b9238ca8d8cdc5">BCERROR</a>)</div><div class="line">                                {</div><div class="line">                                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid bits setting %s\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, optarg);</div><div class="line">                                        <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#ga92d440cdd980e61a41b9238ca8d8cdc5">BCERROR</a>);</div><div class="line">                                }</div><div class="line">                                printf(<span class="stringliteral">&quot;Speed = %d\r\n&quot;</span>,<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga218b4f7c6cc2681a99c23a3b089d68b1">speed</a>);</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;b&#39;</span>:               <span class="comment">// &#39;b&#39; option specifies serial port bit settings</span></div><div class="line">                                <span class="keywordflow">if</span>(<a name="a99"></a><a class="code" href="group__zephyr__code.html#gadab6d320323ece6f7627cb9bb04d0eb9">verify_bits</a>(optarg))</div><div class="line">                                {</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a name="a100"></a><a class="code" href="group__roc2__header.html#gad1e28a1a66a25529b0b61b9ca4e66d44">bits</a> = optarg[0]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a name="a101"></a><a class="code" href="group__roc2__header.html#gad14da60f9217c7f12ee2224d23872b45">parity</a> = optarg[1];</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a name="a102"></a><a class="code" href="group__roc2__header.html#ga6c0af9f2e97842405fb15ed952ef2976">stop</a> = optarg[2]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#gad1e28a1a66a25529b0b61b9ca4e66d44">bits</a> = optarg[0]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#gad14da60f9217c7f12ee2224d23872b45">parity</a> = optarg[1];</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga6c0af9f2e97842405fb15ed952ef2976">stop</a> = optarg[2]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">else</span></div><div class="line">                                {</div><div class="line">                                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid bits setting %s\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, optarg);</div><div class="line">                                        <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#ga92d440cdd980e61a41b9238ca8d8cdc5">BCERROR</a>);</div><div class="line">                                }</div><div class="line">                                printf(<span class="stringliteral">&quot;Bits = %d, Par = %c, Stop = %d\r\n&quot;</span>,<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#gad1e28a1a66a25529b0b61b9ca4e66d44">bits</a>, <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#gad14da60f9217c7f12ee2224d23872b45">parity</a>,<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga6c0af9f2e97842405fb15ed952ef2976">stop</a>);</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;f&#39;</span>:               <span class="comment">// &#39;f&#39; option specifies serial port flow control</span></div><div class="line">                                <span class="keywordflow">if</span>(<a name="a103"></a><a class="code" href="group__zephyr__code.html#ga10d59c21de300f9eae88f1b90ef845f2">verify_flow</a>(optarg))</div><div class="line">                                {</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a name="a104"></a><a class="code" href="group__roc2__header.html#ga0987f44fb6e6bc92483048e54ccd19da">flow</a> = optarg[0];</div><div class="line">                                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga0987f44fb6e6bc92483048e54ccd19da">flow</a> = optarg[0];</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">else</span></div><div class="line">                                {</div><div class="line">                                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid flow control setting %s\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, optarg);</div><div class="line">                                        <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#ga92d440cdd980e61a41b9238ca8d8cdc5">BCERROR</a>);</div><div class="line">                                }</div><div class="line">                                printf(<span class="stringliteral">&quot;Flow = %c\r\n&quot;</span>,<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga0987f44fb6e6bc92483048e54ccd19da">flow</a>);</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;?&#39;</span>:</div><div class="line">                                <span class="keywordflow">if</span> ((optopt == <span class="charliteral">&#39;f&#39;</span>) || (optopt == <span class="charliteral">&#39;p&#39;</span>) || (optopt == <span class="charliteral">&#39;s&#39;</span>) || (optopt == <span class="charliteral">&#39;b&#39;</span>) || (optopt == <span class="charliteral">&#39;l&#39;</span>))</div><div class="line">                                        fprintf (stderr, <span class="stringliteral">&quot;%s: Option -%c requires an argument.\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>,optopt);</div><div class="line">                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isprint (optopt))</div><div class="line">                                        fprintf (stderr, <span class="stringliteral">&quot;%s: Unknown option `-%c&#39;.\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>,optopt);</div><div class="line">                                <span class="keywordflow">else</span></div><div class="line">                                        fprintf (stderr,<span class="stringliteral">&quot;%s: Unknown option character `\\x%x&#39;.\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>,optopt);</div><div class="line">                                <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#ga92d440cdd980e61a41b9238ca8d8cdc5">BCERROR</a>);</div><div class="line">                        <span class="keywordflow">default</span>:</div><div class="line">                                <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#ga92d440cdd980e61a41b9238ca8d8cdc5">BCERROR</a>);</div><div class="line">                }</div><div class="line">        <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#ga416de92c0d71270e5d9eb87ba5853e39">BCSUCCESS</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Prints the usage summary showing valid command line options.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__zephyr__code.html#ga40185ea52d16cecaafae70740e90af29">Usage</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"></div><div class="line">        printf(<span class="stringliteral">&quot;Usage:\r\n zephyr [OPTIONS]\r\n\r\n&quot;</span>);</div><div class="line">        printf(<span class="stringliteral">&quot;Options:\r\n -b &lt;bit settings&gt;\tUse &lt;bit settings&gt; for the serial port (default = %s).\r\n&quot;</span>,<a name="a105"></a><a class="code" href="group__roc2__header.html#ga22d8a5fa29f522516412a79347c65379">BITS_DEFAULT</a>);</div><div class="line">        printf(<span class="stringliteral">&quot; -f [N | H | S]\tSpecifies what type of flow control to use (N=None, H=Hardware, S=Software) (default=%c).\r\n&quot;</span>,<a name="a106"></a><a class="code" href="group__roc2__header.html#gad9fdf5915b4e8cea83af20712b77225c">FLOW_DEFAULT</a>);</div><div class="line">        printf(<span class="stringliteral">&quot; -s &lt;speed&gt;\tConfigure the serial ports for &lt;speed&gt; bits per second (default = %d).\r\n&quot;</span>,<a name="a107"></a><a class="code" href="group__roc2__header.html#ga13011473aa992ebdbad6b99830b54d56">BAUD_DEFAULT</a>);</div><div class="line"><span class="comment">//      printf(&quot; -l &lt;length&gt;\tCreate data files of length &lt;length&gt; seconds (default = %d).\r\n&quot;,FILE_LEN_DEFAULT);</span></div><div class="line">        printf(<span class="stringliteral">&quot; -v\tVerbose mode.\r\n&quot;</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Reads the program configuration file</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// This function opens the module&#39;s configuration file (whose path is defined in the</span></div><div class="line"><span class="comment">/// pathCfgRoc global) and reads the contents. The currently supported settings that can</span></div><div class="line"><span class="comment">/// be placed in the config file are:</span></div><div class="line"><span class="comment">/// - (Optional) Port number to use for incoming socket connections (socket_in)</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// \param cfg Pointer to config_t object for storing state of config file operations.</span></div><div class="line"><span class="comment">/// \param path String containing full path of the config file to read.</span></div><div class="line"><span class="comment">/// \return</span></div><div class="line"><span class="comment">/// - BCSUCCESS if successful</span></div><div class="line"><span class="comment">/// - BCCONFIGREADERROR indicates an error reading the configuration file</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#ga8ed0e63e6cf78544f92b023037e3e7b8">LoadConfigFileSettings</a>(config_t *cfg, <span class="keyword">const</span> <span class="keywordtype">char</span> *path)</div><div class="line">{</div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *str;</div><div class="line">        <span class="keywordtype">int</span> count, i;</div><div class="line"></div><div class="line">        config_init(cfg);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(config_read_file(cfg, path) == CONFIG_FALSE)</div><div class="line">        {</div><div class="line">                fprintf(stderr,<span class="stringliteral">&quot;%s: Error %s in config file %s, line %d\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, config_error_text(cfg),config_error_file(cfg),config_error_line(cfg));</div><div class="line">                config_destroy(cfg);</div><div class="line">                <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#gacc734db768f05ebce6e4e985e44f46c5">BCCONFIGREADERROR</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        <a name="a108"></a><a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a> = config_lookup(cfg, <span class="stringliteral">&quot;data_dir&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a> != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(<a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a>);</div><div class="line">                <span class="keywordflow">if</span>(str != NULL)</div><div class="line">                {</div><div class="line">                        <a class="code" href="group__roc2__header.html#ga12878be4d584d4841c7d409b8f024644">data_dir</a> = malloc(strlen(str)+1);</div><div class="line">                        strcpy(<a class="code" href="group__roc2__header.html#ga12878be4d584d4841c7d409b8f024644">data_dir</a>, str);</div><div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Data logged in %s.\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, <a class="code" href="group__roc2__header.html#ga12878be4d584d4841c7d409b8f024644">data_dir</a>);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid directory name %s in config file. Using default location %s\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, str, <a name="a109"></a><a class="code" href="group__roc2__header.html#ga5d4e9da7ecf27d35f3194989053adee0">DIR_DEFAULT</a>);</div><div class="line">                        <a class="code" href="group__roc2__header.html#ga12878be4d584d4841c7d409b8f024644">data_dir</a> = <a class="code" href="group__roc2__header.html#ga5d4e9da7ecf27d35f3194989053adee0">DIR_DEFAULT</a>;</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                <a class="code" href="group__roc2__header.html#ga12878be4d584d4841c7d409b8f024644">data_dir</a> = <a class="code" href="group__roc2__header.html#ga5d4e9da7ecf27d35f3194989053adee0">DIR_DEFAULT</a>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a> = config_lookup(cfg, <span class="stringliteral">&quot;zeph_port&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a> != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(<a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a>);</div><div class="line">                <span class="keywordflow">if</span>(str != NULL)</div><div class="line">                {</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga74b83d1a2e086188b8e87ca651f3a610">port</a> = malloc(strlen(str)+1);</div><div class="line">                        strcpy(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga74b83d1a2e086188b8e87ca651f3a610">port</a>, str);</div><div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: GPS commands on %s.\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga74b83d1a2e086188b8e87ca651f3a610">port</a>);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid device name %s in config file.\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, str);</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga74b83d1a2e086188b8e87ca651f3a610">port</a> = NULL;</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga74b83d1a2e086188b8e87ca651f3a610">port</a> = NULL;</div><div class="line">        }</div><div class="line"></div><div class="line"></div><div class="line">        <a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a> = config_lookup(cfg, <span class="stringliteral">&quot;zeph_speed&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a> != NULL)</div><div class="line">        {</div><div class="line">                <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga218b4f7c6cc2681a99c23a3b089d68b1">speed</a> = <a class="code" href="group__zephyr__code.html#gaf890f66e1e86cf2e43aafd221eddabbd">get_baud</a>(config_setting_get_int(<a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a>));</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga218b4f7c6cc2681a99c23a3b089d68b1">speed</a> == <a class="code" href="group__roc2__header.html#ga92d440cdd980e61a41b9238ca8d8cdc5">BCERROR</a>)</div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid baud rate %d in config file %s. Using default vaule %d.\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga218b4f7c6cc2681a99c23a3b089d68b1">speed</a>, path, <a class="code" href="group__roc2__header.html#ga13011473aa992ebdbad6b99830b54d56">BAUD_DEFAULT</a>);</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga218b4f7c6cc2681a99c23a3b089d68b1">speed</a> = <a class="code" href="group__roc2__header.html#ga13011473aa992ebdbad6b99830b54d56">BAUD_DEFAULT</a>;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Using baud rate %d for serial port %s from config file %s.\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga218b4f7c6cc2681a99c23a3b089d68b1">speed</a>, <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga74b83d1a2e086188b8e87ca651f3a610">port</a>, path);</div><div class="line">                }</div><div class="line">        } </div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga218b4f7c6cc2681a99c23a3b089d68b1">speed</a> = <a class="code" href="group__roc2__header.html#ga13011473aa992ebdbad6b99830b54d56">BAUD_DEFAULT</a>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a> = config_lookup(cfg, <span class="stringliteral">&quot;bits&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a> != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(<a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a>);</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__code.html#gadab6d320323ece6f7627cb9bb04d0eb9">verify_bits</a>(str))</div><div class="line">                {</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#gad1e28a1a66a25529b0b61b9ca4e66d44">bits</a> = str[0]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#gad14da60f9217c7f12ee2224d23872b45">parity</a> = str[1];</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga6c0af9f2e97842405fb15ed952ef2976">stop</a> = str[2]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Using serial bit settings %s.\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, str);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid bits setting %s in config file. Using default value %s\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, str, <a class="code" href="group__roc2__header.html#ga22d8a5fa29f522516412a79347c65379">BITS_DEFAULT</a>);</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#gad1e28a1a66a25529b0b61b9ca4e66d44">bits</a> = 8;</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#gad14da60f9217c7f12ee2224d23872b45">parity</a> = <span class="charliteral">&#39;N&#39;</span>;</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga6c0af9f2e97842405fb15ed952ef2976">stop</a> = 1;</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#gad1e28a1a66a25529b0b61b9ca4e66d44">bits</a> = 8;</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#gad14da60f9217c7f12ee2224d23872b45">parity</a> = <span class="charliteral">&#39;N&#39;</span>;</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga6c0af9f2e97842405fb15ed952ef2976">stop</a> = 1;</div><div class="line">        }</div><div class="line"></div><div class="line">        <a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a> = config_lookup(cfg, <span class="stringliteral">&quot;flow&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a> != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(<a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a>);</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__code.html#ga10d59c21de300f9eae88f1b90ef845f2">verify_flow</a>(str))</div><div class="line">                {</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga0987f44fb6e6bc92483048e54ccd19da">flow</a> = str[0];</div><div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Using %c flow control.\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga0987f44fb6e6bc92483048e54ccd19da">flow</a>);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid flow control setting %c in config file. Using default value %s\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, str[0], <a class="code" href="group__roc2__header.html#gad9fdf5915b4e8cea83af20712b77225c">FLOW_DEFAULT</a>);</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga0987f44fb6e6bc92483048e54ccd19da">flow</a> = <a class="code" href="group__roc2__header.html#gad9fdf5915b4e8cea83af20712b77225c">FLOW_DEFAULT</a>;</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga0987f44fb6e6bc92483048e54ccd19da">flow</a> = <a class="code" href="group__roc2__header.html#gad9fdf5915b4e8cea83af20712b77225c">FLOW_DEFAULT</a>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a> = config_lookup(cfg, <span class="stringliteral">&quot;terminator&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a> != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(<a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a>);</div><div class="line">                <span class="keywordflow">if</span>(str != NULL)</div><div class="line">                {</div><div class="line">                        strcpy(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga29c6cbcf2159ec289aa7742b1e99b316">term</a>, str);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid line terminator specified. Using default value\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                        strcpy(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga29c6cbcf2159ec289aa7742b1e99b316">term</a>, <a name="a110"></a><a class="code" href="group__roc2__header.html#gae315cdbfa1dca5c4f0468fe98782056c">TERM_DEFAULT</a>);</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                strcpy(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga29c6cbcf2159ec289aa7742b1e99b316">term</a>, <a class="code" href="group__roc2__header.html#gae315cdbfa1dca5c4f0468fe98782056c">TERM_DEFAULT</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        <a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a> = config_lookup(cfg, <span class="stringliteral">&quot;lp_mode&quot;</span>);</div><div class="line"></div><div class="line">        <a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a> = config_lookup(cfg, <span class="stringliteral">&quot;hwversion&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a> != NULL)</div><div class="line">        {</div><div class="line">                <a class="code" href="group__zephyr__header.html#gafbce215e681be701ae5373fd692dd9ba">hwversion</a> = config_setting_get_int(<a class="code" href="group__roc2__header.html#ga7ae3c951fb9113513e6ceaafe61564b2">setting</a>);</div><div class="line">                printf(<span class="stringliteral">&quot;%s: Interface board version %d.\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, <a class="code" href="group__zephyr__header.html#gafbce215e681be701ae5373fd692dd9ba">hwversion</a>);</div><div class="line">        } </div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                <a class="code" href="group__zephyr__header.html#gafbce215e681be701ae5373fd692dd9ba">hwversion</a> = <a name="a111"></a><a class="code" href="group__zephyr__header.html#ga374a75d2eadaf96cdf19950865c7373f">HWVERSION_DEFAULT</a>;</div><div class="line">                printf(<span class="stringliteral">&quot;%s: No interface board version number found. Using default %d.\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, <a class="code" href="group__zephyr__header.html#gafbce215e681be701ae5373fd692dd9ba">hwversion</a>);</div><div class="line">        }</div><div class="line">        </div><div class="line">        config_destroy(cfg);</div><div class="line">        <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#ga416de92c0d71270e5d9eb87ba5853e39">BCSUCCESS</a>);</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#ga919ac26442368faff61c89f0f62fd58b">SerialPortInit</a>(<a name="_a112"></a><a class="code" href="structserial.html">serial</a> port)</div><div class="line">{</div><div class="line">        <span class="keyword">struct </span>termios options;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Opening port %s\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, port.<a class="code" href="group__roc2__header.html#ga74b83d1a2e086188b8e87ca651f3a610">port</a>);</div><div class="line">        port.<a class="code" href="group__roc2__header.html#ga5c82fa58c263d40b70b737c5efa07ef0">fp</a> = open(port.<a class="code" href="group__roc2__header.html#ga74b83d1a2e086188b8e87ca651f3a610">port</a>, O_RDWR | O_NOCTTY | O_NDELAY);        <span class="comment">// Open serial port</span></div><div class="line">        <span class="keywordflow">if</span>(port.<a class="code" href="group__roc2__header.html#ga5c82fa58c263d40b70b737c5efa07ef0">fp</a> == <a class="code" href="group__roc2__header.html#ga92d440cdd980e61a41b9238ca8d8cdc5">BCERROR</a>)</div><div class="line">                <span class="keywordflow">return</span>(<a name="a113"></a><a class="code" href="group__roc2__header.html#ga917385f51ef11c435842e3a175902f42">BCSEROPENERROR</a>);</div><div class="line"></div><div class="line">        tcgetattr(port.<a class="code" href="group__roc2__header.html#ga5c82fa58c263d40b70b737c5efa07ef0">fp</a>, &amp;options);                                           <span class="comment">// Get current port options</span></div><div class="line"></div><div class="line">        cfsetispeed(&amp;options, port.<a class="code" href="group__roc2__header.html#ga218b4f7c6cc2681a99c23a3b089d68b1">speed</a>);                              <span class="comment">// Set input baud rate</span></div><div class="line">        cfsetospeed(&amp;options, port.<a class="code" href="group__roc2__header.html#ga218b4f7c6cc2681a99c23a3b089d68b1">speed</a>);                              <span class="comment">// Set output baud rate</span></div><div class="line"></div><div class="line">        options.c_cflag &amp;= ~CSIZE;                                                      <span class="comment">// Clear data bit fields</span></div><div class="line">        <span class="keywordflow">switch</span>(port.<a class="code" href="group__roc2__header.html#gad1e28a1a66a25529b0b61b9ca4e66d44">bits</a>)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> 7:</div><div class="line">                        options.c_cflag |= CS7;                                         <span class="comment">// Select 7 data bits</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> 8:</div><div class="line">                        options.c_cflag |= CS8;                                         <span class="comment">// Select 8 data bits</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">return</span>(<a name="a114"></a><a class="code" href="group__roc2__header.html#gae81be3717fce090da2f1fead60cbcaee">BCINVALIDBITS</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span>(port.<a class="code" href="group__roc2__header.html#gad14da60f9217c7f12ee2224d23872b45">parity</a>)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;N&#39;</span>:</div><div class="line">                        options.c_cflag &amp;= ~PARENB;                                     <span class="comment">// Clear parity enable bit</span></div><div class="line">                        options.c_iflag &amp;= ~INPCK;                                      <span class="comment">// Disable parity checking of incoming data</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;O&#39;</span>:</div><div class="line">                        options.c_cflag |= PARENB;                                      <span class="comment">// Set parity enable bit</span></div><div class="line">                        options.c_cflag |= PARODD;                                      <span class="comment">// Set odd parity bit</span></div><div class="line">                        options.c_iflag |= (INPCK | ISTRIP);            <span class="comment">// Enable parity checking of incoming data</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;E&#39;</span>:</div><div class="line">                        options.c_cflag |= PARENB;                                      <span class="comment">// Set parity enable bit</span></div><div class="line">                        options.c_cflag &amp;= ~PARODD;                                     <span class="comment">// Clear odd parity bit (which means use even parity)</span></div><div class="line">                        options.c_iflag |= (INPCK | ISTRIP);            <span class="comment">// Enable parity checking of incoming data</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">return</span>(<a name="a115"></a><a class="code" href="group__roc2__header.html#ga95fc7e0c0cea8fdb89d2b22411469b5e">BCINVALIDPAR</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span>(port.<a class="code" href="group__roc2__header.html#ga6c0af9f2e97842405fb15ed952ef2976">stop</a>)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> 1:</div><div class="line">                        options.c_cflag &amp;= ~CSTOPB;                                     <span class="comment">// Clear stop bits bit (which means use 1 stop bit)</span></div><div class="line">                        <span class="keywordflow">break</span>;                  </div><div class="line">                <span class="keywordflow">case</span> 2:</div><div class="line">                        options.c_cflag |= CSTOPB;                                      <span class="comment">// Set stop bits bit (which means use 2 stop bits)</span></div><div class="line">                        <span class="keywordflow">break</span>;                  </div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">return</span>(<a name="a116"></a><a class="code" href="group__roc2__header.html#gac5ed0d3199ad199fb8af5fd13af5ed76">BCINVALIDSTOP</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span>(port.<a class="code" href="group__roc2__header.html#ga0987f44fb6e6bc92483048e54ccd19da">flow</a>)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;N&#39;</span>:</div><div class="line">                        options.c_cflag &amp;= ~CRTSCTS;                            <span class="comment">// Disable hardware flow control</span></div><div class="line">                        options.c_iflag &amp;= ~(IXON | IXOFF | IXANY);     <span class="comment">// Disable software flow control</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;H&#39;</span>:</div><div class="line">                        options.c_cflag |= CRTSCTS;                                     <span class="comment">// Enable hardware flow control</span></div><div class="line">                        options.c_iflag &amp;= ~(IXON | IXOFF | IXANY);     <span class="comment">// Disable software flow control</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;S&#39;</span>:</div><div class="line">                        options.c_cflag &amp;= ~CRTSCTS;                            <span class="comment">// Disable hardware flow control</span></div><div class="line">                        options.c_iflag |= (IXON | IXOFF | IXANY);      <span class="comment">// Enable software flow control</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">return</span>(<a name="a117"></a><a class="code" href="group__roc2__header.html#ga3cc54957cc0646a3182940f88684be4d">BCINVALIDFLOW</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        options.c_iflag &amp;= ~ICRNL;                                                      <span class="comment">// disable mapping of CR to NL</span></div><div class="line">        options.c_lflag &amp;= ~(ICANON | ECHO | ECHOE | ECHOK | ECHONL | ECHOCTL | ECHOPRT | ECHOKE | ISIG);       <span class="comment">// Turn off line read (canonical) mode and character echoes</span></div><div class="line">        options.c_cflag |= CLOCAL;                                                      <span class="comment">// Set local mode</span></div><div class="line"><span class="comment">//      options.c_cflag &amp;= ~CREAD;                                                      // Disable the receiver for now</span></div><div class="line">        options.c_cflag |= CREAD;                                                       <span class="comment">// Enable the receiver</span></div><div class="line">        options.c_oflag &amp;= ~OPOST;                                                      <span class="comment">// Disable all processed output settings</span></div><div class="line">        options.c_cc[VMIN] = 0;                                                         <span class="comment">// Forces the read() function to return immediately with however many characters are available</span></div><div class="line">        options.c_cc[VTIME] = 0;                                                        <span class="comment">// Tells the read() function not to wait for any data</span></div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(tcsetattr(port.<a class="code" href="group__roc2__header.html#ga5c82fa58c263d40b70b737c5efa07ef0">fp</a>, TCSANOW, &amp;options) == 0)  <span class="comment">// Make the new settings active</span></div><div class="line">        {</div><div class="line"><span class="comment">//              sleep(2);</span></div><div class="line">                tcflush(port.<a class="code" href="group__roc2__header.html#ga5c82fa58c263d40b70b737c5efa07ef0">fp</a>,TCIOFLUSH);</div><div class="line">                <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#ga416de92c0d71270e5d9eb87ba5853e39">BCSUCCESS</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">                <span class="keywordflow">return</span>(<a name="a118"></a><a class="code" href="group__roc2__header.html#ga883799ad282c86bfe883fe8861adaf21">BCSETATTRERROR</a>);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#gaf890f66e1e86cf2e43aafd221eddabbd">get_baud</a>(<span class="keywordtype">int</span> baud)</div><div class="line">{</div><div class="line">        <span class="keywordflow">switch</span> (baud) {</div><div class="line">        <span class="keywordflow">case</span> 300:</div><div class="line">                <span class="keywordflow">return</span> B300;</div><div class="line">        <span class="keywordflow">case</span> 600:</div><div class="line">                <span class="keywordflow">return</span> B600;</div><div class="line">        <span class="keywordflow">case</span> 1200:</div><div class="line">                <span class="keywordflow">return</span> B1200;</div><div class="line">        <span class="keywordflow">case</span> 2400:</div><div class="line">                <span class="keywordflow">return</span> B2400;</div><div class="line">        <span class="keywordflow">case</span> 4800:</div><div class="line">                <span class="keywordflow">return</span> B4800;</div><div class="line">        <span class="keywordflow">case</span> 9600:</div><div class="line">                <span class="keywordflow">return</span> B9600;</div><div class="line">        <span class="keywordflow">case</span> 19200:</div><div class="line">                <span class="keywordflow">return</span> B19200;</div><div class="line">        <span class="keywordflow">case</span> 38400:</div><div class="line">                <span class="keywordflow">return</span> B38400;</div><div class="line">        <span class="keywordflow">case</span> 57600:</div><div class="line">                <span class="keywordflow">return</span> B57600;</div><div class="line">        <span class="keywordflow">case</span> 115200:</div><div class="line">                <span class="keywordflow">return</span> B115200;</div><div class="line">        <span class="keywordflow">case</span> 230400:</div><div class="line">                <span class="keywordflow">return</span> B230400;</div><div class="line">        <span class="keywordflow">case</span> 460800:</div><div class="line">                <span class="keywordflow">return</span> B460800;</div><div class="line">        <span class="keywordflow">case</span> 500000:</div><div class="line">                <span class="keywordflow">return</span> B500000;</div><div class="line">        <span class="keywordflow">case</span> 576000:</div><div class="line">                <span class="keywordflow">return</span> B576000;</div><div class="line">        <span class="keywordflow">case</span> 921600:</div><div class="line">                <span class="keywordflow">return</span> B921600;</div><div class="line">        <span class="keywordflow">case</span> 1000000:</div><div class="line">                <span class="keywordflow">return</span> B1000000;</div><div class="line">        <span class="keywordflow">case</span> 1152000:</div><div class="line">                <span class="keywordflow">return</span> B1152000;</div><div class="line">        <span class="keywordflow">case</span> 1500000:</div><div class="line">                <span class="keywordflow">return</span> B1500000;</div><div class="line">        <span class="keywordflow">case</span> 2000000:</div><div class="line">                <span class="keywordflow">return</span> B2000000;</div><div class="line">        <span class="keywordflow">case</span> 2500000:</div><div class="line">                <span class="keywordflow">return</span> B2500000;</div><div class="line">        <span class="keywordflow">case</span> 3000000:</div><div class="line">                <span class="keywordflow">return</span> B3000000;</div><div class="line">        <span class="keywordflow">case</span> 3500000:</div><div class="line">                <span class="keywordflow">return</span> B3500000;</div><div class="line">        <span class="keywordflow">case</span> 4000000:</div><div class="line">                <span class="keywordflow">return</span> B4000000;</div><div class="line">        <span class="keywordflow">default</span>: </div><div class="line">                <span class="keywordflow">return</span> <a class="code" href="group__roc2__header.html#ga92d440cdd980e61a41b9238ca8d8cdc5">BCERROR</a>;</div><div class="line">        }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#gadab6d320323ece6f7627cb9bb04d0eb9">verify_bits</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *bits)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span>(((bits[0]==<span class="charliteral">&#39;7&#39;</span>) || (bits[0]==<span class="charliteral">&#39;8&#39;</span>)) &amp;&amp; ((toupper(bits[1])==<span class="charliteral">&#39;N&#39;</span>) || (toupper(bits[1])==<span class="charliteral">&#39;O&#39;</span>) || (toupper(bits[1])==<span class="charliteral">&#39;E&#39;</span>)) &amp;&amp; ((bits[2]==<span class="charliteral">&#39;1&#39;</span>) || (bits[2]==<span class="charliteral">&#39;2&#39;</span>)))</div><div class="line">                <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#gaa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">                <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#gaa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#ga10d59c21de300f9eae88f1b90ef845f2">verify_flow</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *bits)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span>((toupper(bits[0])==<span class="charliteral">&#39;N&#39;</span>) || (toupper(bits[0])==<span class="charliteral">&#39;H&#39;</span>) || (toupper(bits[0])==<span class="charliteral">&#39;S&#39;</span>))</div><div class="line">                <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#gaa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">                <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#gaa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">char</span> *<a name="a119"></a><a class="code" href="group__zephyr__code.html#ga0bacb9e2137b9572d5f02c23de2ad813">TodaysDirectoryName</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        time_t epoch;</div><div class="line">        <span class="keyword">struct </span>tm *<a name="a120"></a><a class="code" href="group__roc2__header.html#ga133013525fac7907e0baa31ec30f8b4b">now</a>;</div><div class="line">        <span class="keyword">struct </span>timespec ts;</div><div class="line">        <span class="keywordtype">char</span> *rootname, *fullpath;</div><div class="line"></div><div class="line">        epoch = time(NULL);</div><div class="line"><span class="comment">//      epoch = ts.tv_sec;</span></div><div class="line">        now = gmtime(&amp;epoch);</div><div class="line">        sprintf(<a name="a121"></a><a class="code" href="group__roc2__header.html#gacf09df540c710aea6e3e39d4c149f119">todaysDirectoryName</a>,<span class="stringliteral">&quot;%04d%02d%02d&quot;</span>, (now-&gt;tm_year)+1900, (now-&gt;tm_mon)+1, now-&gt;tm_mday);</div><div class="line">        <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#gacf09df540c710aea6e3e39d4c149f119">todaysDirectoryName</a>);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">char</span> *<a name="a122"></a><a class="code" href="group__zephyr__code.html#ga29819f4927e98849304e948f13c12574">TodaysDirectoryPath</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> len;</div><div class="line">        <span class="keywordtype">char</span> *dirname, *fullpath;</div><div class="line"></div><div class="line">        dirname = <a class="code" href="group__zephyr__code.html#ga0bacb9e2137b9572d5f02c23de2ad813">TodaysDirectoryName</a>();</div><div class="line"></div><div class="line">        fullpath = &amp;<a name="a123"></a><a class="code" href="group__roc2__header.html#ga17c8b16a620d8fa68aa30017abe96c50">todaysDirectoryPath</a>[0];</div><div class="line">        len = strlen(<a class="code" href="group__roc2__header.html#ga12878be4d584d4841c7d409b8f024644">data_dir</a>);</div><div class="line">        strcpy(fullpath, <a class="code" href="group__roc2__header.html#ga12878be4d584d4841c7d409b8f024644">data_dir</a>);</div><div class="line">        strcpy(fullpath + len, <span class="stringliteral">&quot;/&quot;</span>);</div><div class="line">        strcpy(fullpath + len + 1, dirname);</div><div class="line">        strcpy(fullpath + len + 1 + strlen(dirname), <span class="stringliteral">&quot;/&quot;</span>);</div><div class="line">        fullpath[len + strlen(dirname) + 2] = 0;        <span class="comment">// Null term</span></div><div class="line">        <span class="keywordflow">return</span>(fullpath);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a124"></a><a class="code" href="group__zephyr__code.html#ga88fb6383c5c934e876be013729f8ab60">TodaysDirectoryExists</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i, found;</div><div class="line">        DIR *dir;</div><div class="line"></div><div class="line">        found = <a class="code" href="group__roc2__header.html#gaa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line"></div><div class="line">        dir = opendir(<a class="code" href="group__zephyr__code.html#ga29819f4927e98849304e948f13c12574">TodaysDirectoryPath</a>());</div><div class="line">        <span class="keywordflow">if</span>(!dir)</div><div class="line">                <span class="keywordflow">if</span>(ENOENT == errno)             <span class="comment">// Directory not found</span></div><div class="line">                {</div><div class="line">                        found = <a class="code" href="group__roc2__header.html#gaa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span>                                    <span class="comment">// Some other error occurred</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">return</span>(<a name="a125"></a><a class="code" href="group__roc2__header.html#ga3cd32c0121e7225577c4bc3c456c9771">BCFILEOPENERROR</a>);</div><div class="line">                }</div><div class="line">                        </div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(found) printf(<span class="stringliteral">&quot;%s: Found %s\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, <a class="code" href="group__zephyr__code.html#ga0bacb9e2137b9572d5f02c23de2ad813">TodaysDirectoryName</a>());</div><div class="line">                <span class="keywordflow">else</span> printf(<span class="stringliteral">&quot;%s: Did not find %s\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, <a class="code" href="group__zephyr__code.html#ga0bacb9e2137b9572d5f02c23de2ad813">TodaysDirectoryName</a>());</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span>(found);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a126"></a><a class="code" href="group__zephyr__code.html#ga0eaf55c523b081609cd85dd6eb04682b">CreateDayDirectory</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i, ret;</div><div class="line"></div><div class="line">        ret = mkdir(<a class="code" href="group__zephyr__code.html#ga29819f4927e98849304e948f13c12574">TodaysDirectoryPath</a>(), 0777);</div><div class="line">        <span class="keywordflow">if</span>(ret)</div><div class="line">                <span class="keywordflow">if</span>(errno != EEXIST)             <span class="comment">// Existing directories not an error, anything else is</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">return</span>(errno);</div><div class="line">                }</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#ga416de92c0d71270e5d9eb87ba5853e39">BCSUCCESS</a>);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">char</span> *<a name="a127"></a><a class="code" href="group__zephyr__code.html#ga45786db9b46a6cc20e64bd0a851655bc">LogFileName</a>(<span class="keywordtype">char</span> *name)</div><div class="line">{</div><div class="line">        time_t epoch;</div><div class="line">        <span class="keyword">struct </span>tm *<a class="code" href="group__roc2__header.html#ga133013525fac7907e0baa31ec30f8b4b">now</a>;</div><div class="line">        <span class="keywordtype">char</span> *rootname, *fullpath;</div><div class="line">        <span class="keyword">struct </span>timespec ts;</div><div class="line"></div><div class="line">        <span class="keywordtype">char</span> *filename = malloc(14 + 1 + strlen(name) + 4 + 1); <span class="comment">// format is YYYYMMDDhhmmss_name.txt</span></div><div class="line">        <span class="keywordflow">if</span>(filename == NULL)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">return</span>(NULL);</div><div class="line">        }</div><div class="line"></div><div class="line">        epoch = time(NULL);</div><div class="line"><span class="comment">//      epoch = ts.tv_sec;</span></div><div class="line">        now = gmtime(&amp;epoch);</div><div class="line">        sprintf(filename,<span class="stringliteral">&quot;%s_%04d%02d%02d%02d%02d%02d.sbf&quot;</span>, name, (now-&gt;tm_year)+1900, (now-&gt;tm_mon)+1, now-&gt;tm_mday, now-&gt;tm_hour, now-&gt;tm_min, now-&gt;tm_sec);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>((rootname = <a class="code" href="group__zephyr__code.html#ga29819f4927e98849304e948f13c12574">TodaysDirectoryPath</a>()) == NULL)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">return</span>(NULL);</div><div class="line">        }</div><div class="line"></div><div class="line">        fullpath = &amp;<a name="a128"></a><a class="code" href="group__roc2__header.html#ga6195294dffffff6b11f3b629568b055e">logFileName</a>[0];</div><div class="line">        strcpy(fullpath, rootname);</div><div class="line"><span class="comment">//      strcpy(fullpath + strlen(rootname), &quot;/&quot;);</span></div><div class="line">        strcpy(fullpath + strlen(rootname), filename);</div><div class="line">        fullpath[strlen(rootname) + strlen(filename)] = 0;</div><div class="line"></div><div class="line">        free (filename);</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>(fullpath);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a129"></a><a class="code" href="group__zephyr__code.html#gaf8b73dc85a9b8da6978eac659ec8531b">OpenLogFile</a>(<span class="keywordtype">char</span> *name)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i, index, ret;</div><div class="line">        <span class="keywordtype">char</span> *strName;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(!<a class="code" href="group__zephyr__code.html#ga88fb6383c5c934e876be013729f8ab60">TodaysDirectoryExists</a>())</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__code.html#ga0eaf55c523b081609cd85dd6eb04682b">CreateDayDirectory</a>()) <span class="keywordflow">return</span>(<a name="a130"></a><a class="code" href="group__roc2__header.html#gabc2e895a6ef8c5a51ce9b7358e596f1b">BCFILEERROR</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        ret = <a class="code" href="group__roc2__header.html#ga416de92c0d71270e5d9eb87ba5853e39">BCSUCCESS</a>;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>((strName = <a class="code" href="group__zephyr__code.html#ga45786db9b46a6cc20e64bd0a851655bc">LogFileName</a>(name)) == NULL)</div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Error generating log file name.\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#gabc2e895a6ef8c5a51ce9b7358e596f1b">BCFILEERROR</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>((<a name="a131"></a><a class="code" href="group__roc2__header.html#gaa065f30aa9f5f9a42132c82c787ee70b">fp</a> = fopen(strName, <span class="stringliteral">&quot;a+&quot;</span>)) == NULL)</div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Error Opening log file %s.\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, strName);</div><div class="line">                ret = <a class="code" href="group__roc2__header.html#ga3cd32c0121e7225577c4bc3c456c9771">BCFILEOPENERROR</a>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) </div><div class="line">                {</div><div class="line">                        printf(<span class="stringliteral">&quot;%s: Opened log file %s.\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, strName);</div><div class="line">                        fflush(stdout);</div><div class="line">                }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>(ret);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a132"></a><a class="code" href="group__zephyr__code.html#ga84b0f0a6d9c4b56b743eb5b171f3172c">CloseLogFile</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i, index, err, ret;</div><div class="line"></div><div class="line">        ret = <a class="code" href="group__roc2__header.html#ga416de92c0d71270e5d9eb87ba5853e39">BCSUCCESS</a>;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(err = fclose(<a class="code" href="group__roc2__header.html#gaa065f30aa9f5f9a42132c82c787ee70b">fp</a>))</div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Error closing log file.\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                ret = <a class="code" href="group__roc2__header.html#gabc2e895a6ef8c5a51ce9b7358e596f1b">BCFILEERROR</a>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(ret == <a class="code" href="group__roc2__header.html#ga416de92c0d71270e5d9eb87ba5853e39">BCSUCCESS</a>)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Closed log files.\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>(ret);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a133"></a><a class="code" href="group__zephyr__code.html#ga5366f78d45883b7ad5934d6910efa6c5">NewFile</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <a class="code" href="group__zephyr__code.html#ga84b0f0a6d9c4b56b743eb5b171f3172c">CloseLogFile</a>();</div><div class="line">        <a class="code" href="group__zephyr__code.html#gaf8b73dc85a9b8da6978eac659ec8531b">OpenLogFile</a>(<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#ga416de92c0d71270e5d9eb87ba5853e39">BCSUCCESS</a>);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a134"></a><a class="code" href="group__zephyr__code.html#gaf31e21e2ff935496c7ce8dc5e52b65c3">LogData</a>(FILE *<a class="code" href="group__roc2__header.html#gaa065f30aa9f5f9a42132c82c787ee70b">fp</a>, <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> n)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> ret;</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#gaa065f30aa9f5f9a42132c82c787ee70b">fp</a>==NULL)</div><div class="line">        {</div><div class="line">                fprintf(stderr,<span class="stringliteral">&quot;%s: Error. Invalid log file stream\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#gabc2e895a6ef8c5a51ce9b7358e596f1b">BCFILEERROR</a>);</div><div class="line">        }</div><div class="line">        ret = fwrite(data, 1, n, <a class="code" href="group__roc2__header.html#gaa065f30aa9f5f9a42132c82c787ee70b">fp</a>);</div><div class="line">        fflush(<a class="code" href="group__roc2__header.html#gaa065f30aa9f5f9a42132c82c787ee70b">fp</a>);</div><div class="line">        <span class="keywordflow">return</span>(ret);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">char</span> *<a class="code" href="group__zephyr__code.html#gab66e64dd30463cea0a06ac33c9cb3522">GetNextFile</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        DIR *dir;</div><div class="line">        <span class="keyword">struct </span>dirent *entry, *lastentry;</div><div class="line">        <span class="keywordtype">int</span> found;</div><div class="line">        <span class="keywordtype">char</span> *fullPath;</div><div class="line">        </div><div class="line">        found = <a class="code" href="group__roc2__header.html#gaa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;</div><div class="line">        dir = opendir(<a class="code" href="group__roc2__header.html#gaf3e7ebf92f13594acf3ba281bcfd1c0b">queueDir</a>);</div><div class="line">        <span class="keywordflow">if</span>(dir != NULL)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">while</span>((!found) &amp;&amp; (entry = readdir(dir)))</div><div class="line">                {</div><div class="line">                        <span class="keywordflow">if</span>(strcmp(entry-&gt;d_name,<span class="stringliteral">&quot;list.txt&quot;</span>)==0)</div><div class="line">                                {</div><div class="line">                                found = <a class="code" href="group__roc2__header.html#gaa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line">                                }</div><div class="line">                }</div><div class="line">                closedir(dir);</div><div class="line">                <span class="keywordflow">if</span> (!found) {</div><div class="line">                        dir = opendir(<a class="code" href="group__roc2__header.html#gaf3e7ebf92f13594acf3ba281bcfd1c0b">queueDir</a>);</div><div class="line">                        <span class="keywordflow">while</span>((!found) &amp;&amp; (entry = readdir(dir)))</div><div class="line">                        {</div><div class="line">                                <span class="keywordflow">if</span>(entry-&gt;d_name[0] != <span class="charliteral">&#39;.&#39;</span>)</div><div class="line">                                        {</div><div class="line">                                        found = <a class="code" href="group__roc2__header.html#gaa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;</div><div class="line">                                        }</div><div class="line">                        }</div><div class="line">                        closedir(dir);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span>(found)</div><div class="line">                {</div><div class="line">                        <span class="keyword">struct </span>stat st;</div><div class="line"></div><div class="line">                        fullPath= &amp;<a name="a135"></a><a class="code" href="group__zephyr__header.html#ga2dc23420046ef8fdfba8feceb60aa1c0">getNextFile</a>[0];</div><div class="line">                        strcpy(fullPath,<a class="code" href="group__roc2__header.html#gaf3e7ebf92f13594acf3ba281bcfd1c0b">queueDir</a>);</div><div class="line">                        strcpy(fullPath+strlen(<a class="code" href="group__roc2__header.html#gaf3e7ebf92f13594acf3ba281bcfd1c0b">queueDir</a>), <span class="stringliteral">&quot;/&quot;</span>);</div><div class="line">                        strcpy(fullPath+strlen(<a class="code" href="group__roc2__header.html#gaf3e7ebf92f13594acf3ba281bcfd1c0b">queueDir</a>)+1, entry-&gt;d_name);</div><div class="line">                        stat(fullPath, &amp;st);</div><div class="line">                        <span class="keywordflow">if</span> (strstr(fullPath,<span class="stringliteral">&quot;list.txt&quot;</span>)==0) {</div><div class="line">                                <span class="keywordflow">if</span> (!<a class="code" href="group__zephyr__header.html#gaf7f4cea1c772506355074b09428675b7">discardFirstFile</a>) {</div><div class="line">                                        <span class="keywordflow">if</span> (!<a class="code" href="group__zephyr__header.html#ga7d97c19b1f965c9fdcefe9e9c83fe126">lastPart</a>) <a class="code" href="group__zephyr__header.html#gad3e6084a9ba20b4a2229e450de4b4cb1">gotGPSChars</a> += st.st_size;</div><div class="line">                                        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: File Size = %d, Discard=%d\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, st.st_size, <a class="code" href="group__zephyr__header.html#gaf7f4cea1c772506355074b09428675b7">discardFirstFile</a>);</div><div class="line">                                }</div><div class="line">                                <a class="code" href="group__zephyr__header.html#gaf7f4cea1c772506355074b09428675b7">discardFirstFile</a> = 0;</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">return</span>(fullPath);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">return</span>(NULL);</div><div class="line">                }</div><div class="line">        }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#ga184ae444081beacfe0bd5b712d378b59">SendFile</a>(<span class="keywordtype">char</span> *name)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> *buf;</div><div class="line">        <span class="keyword">struct </span>stat st;</div><div class="line">        <span class="keywordtype">int</span> err, n;</div><div class="line">        FILE *ptr;</div><div class="line"></div><div class="line">        err=stat(name, &amp;st);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Opening file %s\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, name);</div><div class="line">        ptr = fopen(name, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(ptr==NULL)</div><div class="line">        {</div><div class="line">                fprintf(stderr,<span class="stringliteral">&quot;%s: Error getting file size\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#gabc2e895a6ef8c5a51ce9b7358e596f1b">BCFILEERROR</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#gaa37266c0efaae4ac2d8a5fbba8341a9e">numParts</a>&gt;<a class="code" href="group__zephyr__header.html#ga7d97c19b1f965c9fdcefe9e9c83fe126">lastPart</a>)                                           <span class="comment">// In the middle of a file transfer</span></div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Continuing offload of %s %d/%d\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, name, <a class="code" href="group__zephyr__header.html#ga7d97c19b1f965c9fdcefe9e9c83fe126">lastPart</a>+1, <a class="code" href="group__zephyr__header.html#gaa37266c0efaae4ac2d8a5fbba8341a9e">numParts</a>);</div><div class="line">                buf=malloc(<a name="a136"></a><a class="code" href="group__zephyr__header.html#gaaf06a3762adb0aa04b8a5f8f016ca5e9">MAX_DATA</a>);</div><div class="line">                <span class="keywordflow">if</span>(buf==NULL)</div><div class="line">                {</div><div class="line">                        fprintf(stderr,<span class="stringliteral">&quot;%s: Error allocating buffer for file read\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                        <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#gabc2e895a6ef8c5a51ce9b7358e596f1b">BCFILEERROR</a>);</div><div class="line">                }</div><div class="line">                fseek(ptr, <a class="code" href="group__zephyr__header.html#gaaf06a3762adb0aa04b8a5f8f016ca5e9">MAX_DATA</a>*<a class="code" href="group__zephyr__header.html#ga7d97c19b1f965c9fdcefe9e9c83fe126">lastPart</a>, SEEK_SET);        <span class="comment">// move to proper place in the data file</span></div><div class="line">                n = fread(buf, 1, <a class="code" href="group__zephyr__header.html#gaaf06a3762adb0aa04b8a5f8f016ca5e9">MAX_DATA</a>, ptr);</div><div class="line">                <a class="code" href="group__zephyr__header.html#ga9ad65e907dc15f9fd37da381332b2f1f">dataTm</a> = 1;</div><div class="line">                <a class="code" href="group__zephyr__code.html#ga6e021f179fc712de402af1043ca1a9ef">SendMsg</a>(<a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3eac0f142a65b7d596e898b5ede310ac154">TM</a>, buf, n);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span>                                                                            <span class="comment">// Starting new transfer</span></div><div class="line">        {</div><div class="line">                <a class="code" href="group__zephyr__header.html#gaa37266c0efaae4ac2d8a5fbba8341a9e">numParts</a> = (st.st_size / <a class="code" href="group__zephyr__header.html#gaaf06a3762adb0aa04b8a5f8f016ca5e9">MAX_DATA</a>) + 1;         <span class="comment">// calculate how many parts the file needs to be broken into</span></div><div class="line">                <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: size = %d parts = %d\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>,st.st_size,<a class="code" href="group__zephyr__header.html#gaa37266c0efaae4ac2d8a5fbba8341a9e">numParts</a>);</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#gaa37266c0efaae4ac2d8a5fbba8341a9e">numParts</a>&gt;1)                                                          <span class="comment">// multipart file</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Starting offload of %s 1/%d\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, name, <a class="code" href="group__zephyr__header.html#gaa37266c0efaae4ac2d8a5fbba8341a9e">numParts</a>);</div><div class="line">                        buf=malloc(<a class="code" href="group__zephyr__header.html#gaaf06a3762adb0aa04b8a5f8f016ca5e9">MAX_DATA</a>);</div><div class="line">                        <span class="keywordflow">if</span>(buf==NULL)</div><div class="line">                        {</div><div class="line">                                fprintf(stderr,<span class="stringliteral">&quot;%s: Error allocating buffer for file read\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                                <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#gabc2e895a6ef8c5a51ce9b7358e596f1b">BCFILEERROR</a>);</div><div class="line">                        }</div><div class="line">                        n = fread(buf, 1, <a class="code" href="group__zephyr__header.html#gaaf06a3762adb0aa04b8a5f8f016ca5e9">MAX_DATA</a>, ptr);</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga9ad65e907dc15f9fd37da381332b2f1f">dataTm</a> = 1;</div><div class="line">                        <a class="code" href="group__zephyr__code.html#ga6e021f179fc712de402af1043ca1a9ef">SendMsg</a>(<a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3eac0f142a65b7d596e898b5ede310ac154">TM</a>, buf, n);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {                                                                                       <span class="comment">// single part file</span></div><div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s:  Offloading %s 1/1\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, name);</div><div class="line">                        buf=malloc(st.st_size);</div><div class="line">                        <span class="keywordflow">if</span>(buf==NULL)</div><div class="line">                        {</div><div class="line">                                fprintf(stderr,<span class="stringliteral">&quot;%s: Error allocating buffer for file read\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                                <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#gabc2e895a6ef8c5a51ce9b7358e596f1b">BCFILEERROR</a>);</div><div class="line">                        }</div><div class="line">                        n = fread(buf, 1, st.st_size, ptr);</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga9ad65e907dc15f9fd37da381332b2f1f">dataTm</a> = 1;</div><div class="line">                        <a class="code" href="group__zephyr__code.html#ga6e021f179fc712de402af1043ca1a9ef">SendMsg</a>(<a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3eac0f142a65b7d596e898b5ede310ac154">TM</a>, buf, st.st_size);</div><div class="line"><span class="comment">//                      write(zephyr.fp, buf, n);</span></div><div class="line">                }</div><div class="line">        }</div><div class="line">        <a class="code" href="group__zephyr__header.html#gac292f396289364d78037cae452f1aefc">waitingAck</a>=<a class="code" href="group__zephyr__header.html#ga7f970a76fd7cbf3dd6143df7262bbccc">WAITFORACK</a>;</div><div class="line"><span class="comment">//      ackTimeout=time(NULL) + 5;</span></div><div class="line">        fclose(ptr);</div><div class="line">        <span class="keywordflow">if</span> (buf) free(buf);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#gaf672e15ff453fe857ab4ce7de925f34a">TCSendFile</a>(<span class="keywordtype">char</span> *name)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> *buf;</div><div class="line">        <span class="keyword">struct </span>stat st;</div><div class="line">        <span class="keywordtype">int</span> err, n;</div><div class="line">        FILE *ptr;</div><div class="line"></div><div class="line">        err=stat(name, &amp;st);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Opening file %s\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, name);</div><div class="line">        ptr = fopen(name, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(ptr==NULL)</div><div class="line">        {</div><div class="line">                fprintf(stderr,<span class="stringliteral">&quot;%s: Error getting file size\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#gabc2e895a6ef8c5a51ce9b7358e596f1b">BCFILEERROR</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#gad4b9eb4866c26710cf777628af77626e">TCnumParts</a>&gt;<a class="code" href="group__zephyr__header.html#ga57408962695c0061aac03bb3a81b9658">TClastPart</a>)                                               <span class="comment">// In the middle of a file transfer</span></div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Continuing offload of %s %d/%d\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, name, <a class="code" href="group__zephyr__header.html#ga57408962695c0061aac03bb3a81b9658">TClastPart</a>+1, <a class="code" href="group__zephyr__header.html#gad4b9eb4866c26710cf777628af77626e">TCnumParts</a>);</div><div class="line">                buf=malloc(<a class="code" href="group__zephyr__header.html#gaaf06a3762adb0aa04b8a5f8f016ca5e9">MAX_DATA</a>);</div><div class="line">                <span class="keywordflow">if</span>(buf==NULL)</div><div class="line">                {</div><div class="line">                        fprintf(stderr,<span class="stringliteral">&quot;%s: Error allocating buffer for file read\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                        <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#gabc2e895a6ef8c5a51ce9b7358e596f1b">BCFILEERROR</a>);</div><div class="line">                }</div><div class="line">                fseek(ptr, <a class="code" href="group__zephyr__header.html#gaaf06a3762adb0aa04b8a5f8f016ca5e9">MAX_DATA</a>*<a class="code" href="group__zephyr__header.html#ga57408962695c0061aac03bb3a81b9658">TClastPart</a>, SEEK_SET);      <span class="comment">// move to proper place in the data file</span></div><div class="line">                n = fread(buf, 1, <a class="code" href="group__zephyr__header.html#gaaf06a3762adb0aa04b8a5f8f016ca5e9">MAX_DATA</a>, ptr);</div><div class="line">                <a class="code" href="group__zephyr__header.html#ga9ad65e907dc15f9fd37da381332b2f1f">dataTm</a> = 1;</div><div class="line">                <a class="code" href="group__zephyr__code.html#ga6e021f179fc712de402af1043ca1a9ef">SendMsg</a>(<a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3eac0f142a65b7d596e898b5ede310ac154">TM</a>, buf, n);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span>                                                                            <span class="comment">// Starting new transfer</span></div><div class="line">        {</div><div class="line">                <a class="code" href="group__zephyr__header.html#gad4b9eb4866c26710cf777628af77626e">TCnumParts</a> = (st.st_size / <a class="code" href="group__zephyr__header.html#gaaf06a3762adb0aa04b8a5f8f016ca5e9">MAX_DATA</a>) + 1;               <span class="comment">// calculate how many parts the file needs to be broken into</span></div><div class="line">                <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: size = %d parts = %d\r\n&quot;</span>,<a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>,st.st_size,<a class="code" href="group__zephyr__header.html#gad4b9eb4866c26710cf777628af77626e">TCnumParts</a>);</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#gad4b9eb4866c26710cf777628af77626e">TCnumParts</a>&gt;1)                                                                <span class="comment">// multipart file</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Starting offload of %s 1/%d\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, name, <a class="code" href="group__zephyr__header.html#gad4b9eb4866c26710cf777628af77626e">TCnumParts</a>);</div><div class="line">                        buf=malloc(<a class="code" href="group__zephyr__header.html#gaaf06a3762adb0aa04b8a5f8f016ca5e9">MAX_DATA</a>);</div><div class="line">                        <span class="keywordflow">if</span>(buf==NULL)</div><div class="line">                        {</div><div class="line">                                fprintf(stderr,<span class="stringliteral">&quot;%s: Error allocating buffer for file read\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                                <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#gabc2e895a6ef8c5a51ce9b7358e596f1b">BCFILEERROR</a>);</div><div class="line">                        }</div><div class="line">                        n = fread(buf, 1, <a class="code" href="group__zephyr__header.html#gaaf06a3762adb0aa04b8a5f8f016ca5e9">MAX_DATA</a>, ptr);</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga9ad65e907dc15f9fd37da381332b2f1f">dataTm</a> = 1;</div><div class="line">                        <a class="code" href="group__zephyr__code.html#ga6e021f179fc712de402af1043ca1a9ef">SendMsg</a>(<a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3eac0f142a65b7d596e898b5ede310ac154">TM</a>, buf, n);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {                                                                                       <span class="comment">// single part file</span></div><div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s:  Offloading %s 1/1\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, name);</div><div class="line">                        buf=malloc(st.st_size);</div><div class="line">                        <span class="keywordflow">if</span>(buf==NULL)</div><div class="line">                        {</div><div class="line">                                fprintf(stderr,<span class="stringliteral">&quot;%s: Error allocating buffer for file read\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>);</div><div class="line">                                <span class="keywordflow">return</span>(<a class="code" href="group__roc2__header.html#gabc2e895a6ef8c5a51ce9b7358e596f1b">BCFILEERROR</a>);</div><div class="line">                        }</div><div class="line">                        n = fread(buf, 1, st.st_size, ptr);</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga9ad65e907dc15f9fd37da381332b2f1f">dataTm</a> = 1;</div><div class="line">                        <a class="code" href="group__zephyr__code.html#ga6e021f179fc712de402af1043ca1a9ef">SendMsg</a>(<a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3eac0f142a65b7d596e898b5ede310ac154">TM</a>, buf, st.st_size);</div><div class="line"><span class="comment">//                      write(zephyr.fp, buf, n);</span></div><div class="line">                }</div><div class="line">        }</div><div class="line">        <a class="code" href="group__zephyr__header.html#gac292f396289364d78037cae452f1aefc">waitingAck</a>=<a class="code" href="group__zephyr__header.html#ga7f970a76fd7cbf3dd6143df7262bbccc">WAITFORACK</a>;</div><div class="line"><span class="comment">//      ackTimeout=time(NULL) + 5;</span></div><div class="line">        fclose(ptr);</div><div class="line">        <span class="keywordflow">if</span> (buf) free(buf);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__zephyr__code.html#gabf9cb423a606dc4f8232d1b3394042d5">RemoveFile</a>(<span class="keywordtype">char</span> *name)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span> (strstr(name,<span class="stringliteral">&quot;list.txt&quot;</span>)) {  </div><div class="line">                <a class="code" href="group__zephyr__header.html#ga57408962695c0061aac03bb3a81b9658">TClastPart</a>=0;</div><div class="line">                <a class="code" href="group__zephyr__header.html#gad4b9eb4866c26710cf777628af77626e">TCnumParts</a>=0;</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">                <a class="code" href="group__zephyr__header.html#ga7d97c19b1f965c9fdcefe9e9c83fe126">lastPart</a>=0;</div><div class="line">                <a class="code" href="group__zephyr__header.html#gaa37266c0efaae4ac2d8a5fbba8341a9e">numParts</a>=0;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span>(<span class="keyword">remove</span>(name));</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__zephyr__code.html#ga6e021f179fc712de402af1043ca1a9ef">SendMsg</a>(<span class="keyword">enum</span> <a class="code" href="group__zephyr__header.html#ga10a0f35066079abd150539d0d13dbf3e">msg</a> msgtype, <span class="keywordtype">char</span> *payload, <span class="keywordtype">int</span> payload_size)</div><div class="line">{</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> cs;</div><div class="line">        <span class="keywordtype">int</span> ptr;</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> byte;</div><div class="line">        <span class="keyword">struct </span>timespec curTime;</div><div class="line">        <span class="keywordtype">char</span> hdr_msg[128];</div><div class="line">        <span class="keywordtype">size_t</span>  wrote;</div><div class="line">        </div><div class="line">        clock_gettime(CLOCK_REALTIME, &amp;curTime);</div><div class="line">        <span class="keywordflow">while</span>((curTime.tv_sec &lt; <a class="code" href="group__zephyr__header.html#gafe4816e53e5d7a1264d7b0eec60b7eb9">nextMsgTime</a>.tv_sec) || ((curTime.tv_sec == <a class="code" href="group__zephyr__header.html#gafe4816e53e5d7a1264d7b0eec60b7eb9">nextMsgTime</a>.tv_sec) &amp;&amp; (curTime.tv_nsec &lt; <a class="code" href="group__zephyr__header.html#gafe4816e53e5d7a1264d7b0eec60b7eb9">nextMsgTime</a>.tv_nsec)))     <span class="comment">// Wait until it&#39;s ok to send next msg</span></div><div class="line">        {</div><div class="line">                clock_gettime(CLOCK_REALTIME, &amp;curTime);</div><div class="line">                usleep(50000);          <span class="comment">// sleep for 50ms</span></div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s: Sending message at time %ld.%03ld\r\n&quot;</span>, <a class="code" href="group__roc2__header.html#ga14ded244c47bbba850a8a4be6d16c7e3">MODULE_NAME</a>, curTime.tv_sec, curTime.tv_nsec/1000000);</div><div class="line">        <span class="keywordflow">switch</span>(msgtype)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea7c1d11a9bbf54a9ff9af0ad29823bd73">IMR</a>:                       <span class="comment">///&lt; Tells Zephyr we&#39;re done booting and ready for mode change</span></div><div class="line"><span class="comment"></span>                        sprintf(<a name="a137"></a><a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>,<span class="stringliteral">&quot;&lt;IMR&gt;\n\t&lt;Msg&gt;%d&lt;/Msg&gt;\n\t&lt;Inst&gt;%s&lt;/Inst&gt;\n\t&lt;SWDate&gt;%s&lt;/SWDate&gt;\n\t&lt;SWVersion&gt;%s&lt;/SWVersion&gt;\n\t&lt;ZProtocolVersion&gt;%s&lt;/ZProtocolVersion&gt;\n&lt;/IMR&gt;\n&quot;</span>,<a class="code" href="group__zephyr__header.html#ga8d5fb6f3fe9be9941e57854d5c3f2568">MsgID</a>,<a name="a138"></a><a class="code" href="group__zephyr__header.html#ga39c375768ddcc0625a1557e78d08c6e8">INSTID</a>,<a class="code" href="group__roc2__header.html#ga8e5d9993745ca60b1777be3b1fa57a53">SWDate</a>,<a class="code" href="group__roc2__header.html#gad6f212287232c8a7d12dbc0e5901635d">SWVersion</a>,<a name="a139"></a><a class="code" href="group__zephyr__header.html#gad70863efc178e87c7ea48699a141771b">ZephVersion</a>);</div><div class="line">                        <a name="a140"></a><a class="code" href="group__zephyr__header.html#ga0ec421eee79cdd961d241dd324a226fa">crc_calc</a>=<a name="a141"></a><a class="code" href="group__zephyr__code.html#gaa7865b0822633a51bd794f1922f39711">ComputeCRC</a>(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>,strlen(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>));</div><div class="line">                        sprintf(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>+strlen(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>),<span class="stringliteral">&quot;&lt;CRC&gt;%d&lt;/CRC&gt;\n&quot;</span>,<a class="code" href="group__zephyr__header.html#ga0ec421eee79cdd961d241dd324a226fa">crc_calc</a>);</div><div class="line">                        <span class="keywordflow">if</span> (<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>);</div><div class="line">                        write(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga5c82fa58c263d40b70b737c5efa07ef0">fp</a>, <a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>, strlen(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea7f6a37befbb900cb0a526b9a5c349c70">IMAck</a>:                     <span class="comment">///&lt; Tells Zephyr we got the mode change command</span></div><div class="line"><span class="comment"></span>                        sprintf(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>,<span class="stringliteral">&quot;&lt;IMAck&gt;\n\t&lt;Msg&gt;%d&lt;/Msg&gt;\n\t&lt;Inst&gt;%s&lt;/Inst&gt;\n\t&lt;Ack&gt;%s&lt;/Ack&gt;\n&lt;/IMAck&gt;\n&quot;</span>,<a class="code" href="group__zephyr__header.html#ga8d5fb6f3fe9be9941e57854d5c3f2568">MsgID</a>,<a class="code" href="group__zephyr__header.html#ga39c375768ddcc0625a1557e78d08c6e8">INSTID</a>,<span class="stringliteral">&quot;ACK&quot;</span>);          <span class="comment">///&lt; always sending ACK for now, change later</span></div><div class="line"><span class="comment"></span>                        <a class="code" href="group__zephyr__header.html#ga0ec421eee79cdd961d241dd324a226fa">crc_calc</a>=<a class="code" href="group__zephyr__code.html#gaa7865b0822633a51bd794f1922f39711">ComputeCRC</a>(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>,strlen(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>));</div><div class="line">                        sprintf(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>+strlen(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>),<span class="stringliteral">&quot;&lt;CRC&gt;%d&lt;/CRC&gt;\n&quot;</span>,<a class="code" href="group__zephyr__header.html#ga0ec421eee79cdd961d241dd324a226fa">crc_calc</a>);</div><div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>);</div><div class="line">                        write(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga5c82fa58c263d40b70b737c5efa07ef0">fp</a>, <a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>, strlen(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3eaf1ce01387d2348f8b858721a7db81670">S</a>:                         <span class="comment">///&lt; Tells Zephyr we&#39;re in Safety mode now, ok to shut off power</span></div><div class="line"><span class="comment"></span>                        sprintf(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>,<span class="stringliteral">&quot;&lt;S&gt;\n\t&lt;Msg&gt;%d&lt;/Msg&gt;\n\t&lt;Inst&gt;%s&lt;/Inst&gt;\n&lt;/S&gt;\n&quot;</span>,<a class="code" href="group__zephyr__header.html#ga8d5fb6f3fe9be9941e57854d5c3f2568">MsgID</a>,<a class="code" href="group__zephyr__header.html#ga39c375768ddcc0625a1557e78d08c6e8">INSTID</a>);         </div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga0ec421eee79cdd961d241dd324a226fa">crc_calc</a>=<a class="code" href="group__zephyr__code.html#gaa7865b0822633a51bd794f1922f39711">ComputeCRC</a>(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>,strlen(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>));</div><div class="line">                        sprintf(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>+strlen(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>),<span class="stringliteral">&quot;&lt;CRC&gt;%d&lt;/CRC&gt;\n&quot;</span>,<a class="code" href="group__zephyr__header.html#ga0ec421eee79cdd961d241dd324a226fa">crc_calc</a>);</div><div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>);</div><div class="line">                        write(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga5c82fa58c263d40b70b737c5efa07ef0">fp</a>, <a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>, strlen(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3eac0f142a65b7d596e898b5ede310ac154">TM</a>:                        <span class="comment">///&lt; Telemetry message. This is how we send data to Zephyr</span></div><div class="line"><span class="comment"></span>                        <span class="keywordflow">if</span> (<a class="code" href="group__zephyr__header.html#gade6c9212e8175f2f26cb4ffa27f6f71c">TCflag</a>) {</div><div class="line">                                sprintf(hdr_msg, <span class="stringliteral">&quot;%s,%d,%d&quot;</span>,<a class="code" href="group__zephyr__header.html#ga9de05a1c8882446cef651d95cb8c03f8">TCfileOffload</a>,<a class="code" href="group__zephyr__header.html#ga57408962695c0061aac03bb3a81b9658">TClastPart</a>,<a class="code" href="group__zephyr__header.html#gad4b9eb4866c26710cf777628af77626e">TCnumParts</a>);</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__header.html#ga9ad65e907dc15f9fd37da381332b2f1f">dataTm</a>)         <span class="comment">// This message contains a data payload</span></div><div class="line">                        {</div><div class="line">                                sprintf(hdr_msg, <span class="stringliteral">&quot;%s,%d,%d&quot;</span>,<a class="code" href="group__zephyr__header.html#gad9de7f17717cd6e46d8f5f4e869a4bd1">fileOffload</a>,<a class="code" href="group__zephyr__header.html#ga7d97c19b1f965c9fdcefe9e9c83fe126">lastPart</a>,<a class="code" href="group__zephyr__header.html#gaa37266c0efaae4ac2d8a5fbba8341a9e">numParts</a>);</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">else</span>                    <span class="comment">// This is just a housekeeping message, no data payload</span></div><div class="line">                        {</div><div class="line">                                sprintf(hdr_msg,<span class="stringliteral">&quot;000&quot;</span>);         <span class="comment">// This should eventually contain # satellites tracked</span></div><div class="line">                        }</div><div class="line">                        sprintf(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>,<span class="stringliteral">&quot;&lt;TM&gt;\n\t&lt;Msg&gt;%d&lt;/Msg&gt;\n\t&lt;Inst&gt;%s&lt;/Inst&gt;\n\t&lt;StateFlag1&gt;FINE&lt;/StateFlag1&gt;\n\t&lt;StateMess1&gt;%s&lt;/StateMess1&gt;\n\t&lt;Length&gt;%d&lt;/Length&gt;\n&lt;/TM&gt;\n&quot;</span>,<a class="code" href="group__zephyr__header.html#ga8d5fb6f3fe9be9941e57854d5c3f2568">MsgID</a>,<a class="code" href="group__zephyr__header.html#ga39c375768ddcc0625a1557e78d08c6e8">INSTID</a>,hdr_msg,payload_size);</div><div class="line">                        <a class="code" href="group__zephyr__header.html#ga0ec421eee79cdd961d241dd324a226fa">crc_calc</a>=<a class="code" href="group__zephyr__code.html#gaa7865b0822633a51bd794f1922f39711">ComputeCRC</a>(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>,strlen(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>));</div><div class="line">                        sprintf(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>+strlen(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>),<span class="stringliteral">&quot;&lt;CRC&gt;%d&lt;/CRC&gt;\n&quot;</span>,<a class="code" href="group__zephyr__header.html#ga0ec421eee79cdd961d241dd324a226fa">crc_calc</a>);</div><div class="line">                        sprintf(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>+strlen(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>),<span class="stringliteral">&quot;START&quot;</span>);</div><div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%s:Payload %d bytes:&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>, payload_size);</div><div class="line">                        ptr=strlen(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>);</div><div class="line">                        memcpy(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>+ptr,payload,payload_size);</div><div class="line">                        ptr+=payload_size;</div><div class="line">                        cs = <a class="code" href="group__zephyr__code.html#gaa7865b0822633a51bd794f1922f39711">ComputeCRC</a>(payload,payload_size);</div><div class="line">                        byte = ((cs &amp; 0xFF00) &gt;&gt; 8) &amp; 0xFF;</div><div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%02X&quot;</span>, byte);</div><div class="line">                        memcpy(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>+ptr, &amp;byte, 1);</div><div class="line">                        ptr++;</div><div class="line">                        byte = cs &amp; 0xFF;</div><div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;%02X&quot;</span>, byte);</div><div class="line">                        memcpy(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>+ptr, &amp;byte, 1);</div><div class="line">                        ptr++;</div><div class="line">                        sprintf(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>+ptr,<span class="stringliteral">&quot;END&quot;</span>);</div><div class="line">                        ptr+=3;</div><div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<span class="stringliteral">&quot;:END\n&quot;</span>);</div><div class="line">                        wrote=0;</div><div class="line"><span class="comment">//                      printf(&quot;data to write = %d\r\n&quot;, ptr);</span></div><div class="line">                        <span class="keywordflow">while</span>(ptr &gt; 0)</div><div class="line">                        {</div><div class="line">                                wrote = write(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga5c82fa58c263d40b70b737c5efa07ef0">fp</a>, <a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>+wrote, ptr);</div><div class="line">                                ptr -= wrote;</div><div class="line"><span class="comment">//                              printf(&quot;wrote = %d  ptr = %d\r\n&quot;, wrote, ptr);</span></div><div class="line"><span class="comment">//                              usleep(300000);         // sleep for 300ms</span></div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea7e72124ca75fccf172d7c0888e3d8e98">TCAck</a>:                     <span class="comment">///&lt; Tells Zephyr we got the telecommand message (uplink data)</span></div><div class="line"><span class="comment"></span>                        sprintf(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>,<span class="stringliteral">&quot;&lt;TCAck&gt;\n\t&lt;Msg&gt;%d&lt;/Msg&gt;\n\t&lt;Inst&gt;%s&lt;/Inst&gt;\n\t&lt;Ack&gt;%s&lt;/Ack&gt;\n&lt;/TCAck&gt;\n&quot;</span>,<a class="code" href="group__zephyr__header.html#ga8d5fb6f3fe9be9941e57854d5c3f2568">MsgID</a>,<a class="code" href="group__zephyr__header.html#ga39c375768ddcc0625a1557e78d08c6e8">INSTID</a>,<span class="stringliteral">&quot;ACK&quot;</span>);          <span class="comment">///&lt; always sending ACK for now, change later</span></div><div class="line"><span class="comment"></span>                        <a class="code" href="group__zephyr__header.html#ga0ec421eee79cdd961d241dd324a226fa">crc_calc</a>=<a class="code" href="group__zephyr__code.html#gaa7865b0822633a51bd794f1922f39711">ComputeCRC</a>(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>,strlen(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>));</div><div class="line">                        sprintf(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>+strlen(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>),<span class="stringliteral">&quot;&lt;CRC&gt;%d&lt;/CRC&gt;\n&quot;</span>,<a class="code" href="group__zephyr__header.html#ga0ec421eee79cdd961d241dd324a226fa">crc_calc</a>);</div><div class="line">                        <span class="keywordflow">if</span>(<a class="code" href="group__roc2__header.html#ga0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>) printf(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>);</div><div class="line">                        write(<a class="code" href="group__zephyr__header.html#ga677b57bdce5f420b65e52d6eeb0bec5a">zephyr</a>.<a class="code" href="group__roc2__header.html#ga5c82fa58c263d40b70b737c5efa07ef0">fp</a>, <a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>, strlen(<a class="code" href="group__zephyr__header.html#gaa19539ddd566e3d6135096b9866542c6">outBuf</a>));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">        </div><div class="line">        <a class="code" href="group__zephyr__header.html#ga8d5fb6f3fe9be9941e57854d5c3f2568">MsgID</a>++;</div><div class="line"><span class="comment">//      nextMsgTime = curTime;  // set earliest time for sending</span></div><div class="line">        clock_gettime(CLOCK_REALTIME, &amp;<a class="code" href="group__zephyr__header.html#gafe4816e53e5d7a1264d7b0eec60b7eb9">nextMsgTime</a>);    <span class="comment">// set earliest time for sending</span></div><div class="line"><span class="comment">//      if (msgtype != TM) {</span></div><div class="line"><span class="comment">//              nextMsgTime.tv_nsec += 300000000;                                       // next message (300 msec from now)</span></div><div class="line"><span class="comment">//              if (nextMsgTime.tv_nsec &gt; 1000000000) {</span></div><div class="line"><span class="comment">//                      nextMsgTime.tv_nsec -= 1000000000;</span></div><div class="line"><span class="comment">//                      nextMsgTime.tv_sec += 1;</span></div><div class="line"><span class="comment">//              }</span></div><div class="line"><span class="comment">//      } else  nextMsgTime.tv_sec += 1;                                                // next message (1 sec from now)</span></div><div class="line">        <a class="code" href="group__zephyr__header.html#gafe4816e53e5d7a1264d7b0eec60b7eb9">nextMsgTime</a>.tv_sec += 1;                                                <span class="comment">// next message (1 sec from now)</span></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a name="a142"></a><a class="code" href="group__zephyr__code.html#gaabe674fb7d630daaebb86607af12308a">CRCComp</a>(<span class="keywordtype">char</span>* data, <span class="keywordtype">int</span> len)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="group__zephyr__code.html#gaa7865b0822633a51bd794f1922f39711">ComputeCRC</a>(data, len)==<a name="a143"></a><a class="code" href="group__zephyr__header.html#ga5fbc376cbc0c53ee6f214ee2c5e18f33">crc_msg</a>) <span class="keywordflow">return</span>(1);</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">return</span>(0);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a name="a144"></a><a class="code" href="group__zephyr__code.html#ga626fb8bdfcd2bed45be4fe9fabb74f48">CRC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> last, <span class="keywordtype">char</span> next)</div><div class="line">{</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> x, y;</div><div class="line"></div><div class="line">        x = ((last&gt;&gt;8) ^ next) &amp; 0xff;</div><div class="line">        x ^= x&gt;&gt;4;</div><div class="line"></div><div class="line">        y = (last &lt;&lt; 8) ^ (x &lt;&lt; 12) ^ (x &lt;&lt;5) ^ x;</div><div class="line"></div><div class="line">        y &amp;= 0xffff;</div><div class="line">        <span class="keywordflow">return</span>(y);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="group__zephyr__code.html#gaa7865b0822633a51bd794f1922f39711">ComputeCRC</a>(<span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> len)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i;</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> result;</div><div class="line"></div><div class="line">        result = 0x1021;</div><div class="line">        <span class="keywordflow">for</span>(i=0;i&lt;len;i++)</div><div class="line">        {</div><div class="line">                result=<a class="code" href="group__zephyr__code.html#ga626fb8bdfcd2bed45be4fe9fabb74f48">CRC</a>(result, data[i]);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span>(result);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">enum</span> <a class="code" href="group__zephyr__header.html#ga10a0f35066079abd150539d0d13dbf3e">msg</a> <a class="code" href="group__zephyr__code.html#ga224d36d32fdd9a46fced3ac36c639169">MsgType</a>(<span class="keywordtype">char</span> *typestr)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span>(strncmp(typestr, <span class="stringliteral">&quot;IM&quot;</span>, 2)==0)        <span class="comment">///&lt; Got an IM message</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                <span class="keywordflow">return</span>(<a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea162f8ad933bb692377c68dae033e50a5">IM</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(typestr, <span class="stringliteral">&quot;SAck&quot;</span>, 4)==0) <span class="comment">///&lt; Got an SAck message</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                <span class="keywordflow">return</span>(<a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea9379400f962d840155ba4d20e8a05f43">SAck</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(typestr, <span class="stringliteral">&quot;SW&quot;</span>, 2)==0)   <span class="comment">///&lt; Got an SW message</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                <span class="keywordflow">return</span>(<a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea247b880fc48dc1c74961ba58ae0f68a2">SW</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(typestr, <span class="stringliteral">&quot;TMAck&quot;</span>, 5)==0)        <span class="comment">///&lt; Got a TMAck message</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                <span class="keywordflow">return</span>(<a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea24ef62bfe96b185bf5737652c028b4df">TMAck</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(typestr, <span class="stringliteral">&quot;TC&quot;</span>, 2)==0)   <span class="comment">///&lt; Got a TC message</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                <span class="keywordflow">return</span>(<a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3eae179015c05e581c38074e893dbf27840">TC</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(typestr, <span class="stringliteral">&quot;GPS&quot;</span>, 3)==0)  <span class="comment">///&lt; Got a GPS message</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                <span class="keywordflow">return</span>(<a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea171ede81b49deebf3e342cdf41c62182">GPS</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                <span class="keywordflow">return</span>(<a name="a145"></a><a class="code" href="group__zephyr__header.html#gga10a0f35066079abd150539d0d13dbf3ea4dfd42ec49d09d8c6555c218301cc30f">Error</a>);</div><div class="line">        }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**********************************</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* gps_power(), gps_reset(), gps_power_toggle(), set_safe(), led(), set_gpio0()</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* Description: These functions control the digital outputs of the TS-7680.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* Parameter: int state</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* Return value: None</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* These functions hide the active hi/lo nature of the signals so they can be</span></div><div class="line"><span class="comment">*   called as gps_power(ON), etc. without worrying about whether that&#39;s a</span></div><div class="line"><span class="comment">*   logic hi or lo. The argument to led() should be one of: GREEN, RED, ORANGE,</span></div><div class="line"><span class="comment">*   or OFF.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">************************************/</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__zephyr__code.html#ga093f472d65a4478a2a23fa69ea593ef0">gps_power</a>(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(state)</div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s gps_power 0&quot;</span>, <a name="a146"></a><a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s gps_power 1&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        system(cmdstr);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a147"></a><a class="code" href="group__zephyr__code.html#gaf1aef5309c25647017f7108bc58873f7">gps_reset</a>(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(state)</div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s gps_reset 0&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s gps_reset 1&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        system(cmdstr);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a148"></a><a class="code" href="group__zephyr__code.html#ga450d4faa9f19206a09ccd2e461eff601">gps_power_toggle</a>(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(state)</div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s gps_pow_tog 0&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s gps_pow_tog 1&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        system(cmdstr);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__zephyr__code.html#ga7e696bce041fca9cc1924bcd65cbc503">set_safe</a>(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(state)</div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s safe 1&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s safe 0&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        system(cmdstr);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__zephyr__code.html#ga94bb341ea8ea68eb26f43e8664513609">led</a>(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">switch</span>(state)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group__roc2__header.html#ga8d23feea868a983c8c2b661e1e16972f">RED</a>:</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;%s led1 0&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">                        system(cmdstr);</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;%s led0 1&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">                        system(cmdstr);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group__roc2__header.html#gacfbc006ea433ad708fdee3e82996e721">GREEN</a>:</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;%s led0 0&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">                        system(cmdstr);</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;%s led1 1&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">                        system(cmdstr);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a name="a149"></a><a class="code" href="group__roc2__header.html#gac5b6e19bf06822021f35602c59658de3">ORANGE</a>:</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;%s led0 1&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">                        system(cmdstr);</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;%s led1 1&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">                        system(cmdstr);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group__roc2__header.html#ga29e413f6725b2ba32d165ffaa35b01e5">OFF</a>:</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;%s led0 0&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">                        system(cmdstr);</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;%s led1 0&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">                        system(cmdstr);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">        }               </div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a150"></a><a class="code" href="group__zephyr__code.html#gac266e79779ea42b506b577821d4a834d">set_gpio0</a>(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(state)</div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s gpio0 1&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s gpio0 0&quot;</span>, <a class="code" href="group__zephyr__header.html#gaa735592f7579934ca442d9a338588b90">GPIO_PATH</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        system(cmdstr);</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
