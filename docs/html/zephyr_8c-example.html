<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Strateole 2 Project: zephyr.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Strateole 2 Project"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Strateole 2 Project
   </div>
   <div id="projectbrief">HaaseResearchGroup@UCSD</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,true,'search.php','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('zephyr_8c-example.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">zephyr.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *      @file zephyr.c</span></div><div class="line"><span class="comment"> *      @brief ROC2 Zephyr Interface Module</span></div><div class="line"><span class="comment"> *      </span></div><div class="line"><span class="comment"> *      This program is the first version of data collection software for the ROC2 Radio</span></div><div class="line"><span class="comment"> *      Occultation Instrument. It lacks the full feature set of the final instrument but</span></div><div class="line"><span class="comment"> *      performs the following:</span></div><div class="line"><span class="comment"> *      </span></div><div class="line"><span class="comment"> *      - Reads configuration file to determine commands for setting up GPS receiver</span></div><div class="line"><span class="comment"> *      - Configures GPS receiver</span></div><div class="line"><span class="comment"> *      - Launch data offload program</span></div><div class="line"><span class="comment"> *      - Logs data received from GPS receiver to files</span></div><div class="line"><span class="comment"> *      - When data file is closed, calls data processing script and open new file</span></div><div class="line"><span class="comment"> *      </span></div><div class="line"><span class="comment"> *      @author David Jabson, Brainstorm Engineering 2018 </span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;ctype.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;libconfig.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;time.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;termios.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;fcntl.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;sys/stat.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;poll.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;dirent.h&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;zephyr.h&quot;</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Main function.</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// Calls ZephyrInit() to perform initialization then enters the main while loop where it</span></div><div class="line"><span class="comment">/// .... </span></div><div class="line"><span class="comment">/// the main loop stops, then ZephyrCleanup() is called before exiting.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="preprocessor">#define SEPTENTRIOTOGLNG 300000</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> err, acked, i, numread, j;</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *endptr, *readptr;</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> term, readbuf[INBUFSIZE], linebuf[INBUFSIZE/2];</div><div class="line">        <span class="keyword">struct </span>termios options;</div><div class="line"><span class="comment">//      struct timespec curTime;</span></div><div class="line">        time_t Timer;</div><div class="line">        <span class="keywordtype">char</span> *nextFile;</div><div class="line">        <span class="keyword">enum</span> msg InMsgType;</div><div class="line">        <span class="keywordtype">char</span> InMsgTypeStr[8];</div><div class="line">        time_t nextS=0, nextTm=0;</div><div class="line">        </div><div class="line">        <span class="keyword">struct </span>pollfd fds[1];</div><div class="line"></div><div class="line">        err = ZephyrInit(argc, argv);</div><div class="line"><span class="comment">//      led(RED);</span></div><div class="line">        sendIMRatPower = 1;</div><div class="line">        <span class="keywordflow">if</span>(err&lt;0)</div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Initialization error %d. Exiting\r\n&quot;</span>,MODULE_NAME,err);</div><div class="line">                <span class="keywordflow">if</span>(hwversion&gt;2) led(RED);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> </div><div class="line">        {</div><div class="line">                printf(<span class="stringliteral">&quot;SWVersion = %s\r\nSWDate = %s\r\n&quot;</span>,SWVersion,SWDate);</div><div class="line">                printf(<span class="stringliteral">&quot;%s: Module started.\r\n&quot;</span>,MODULE_NAME);</div><div class="line"><span class="comment">//              write(zephyr.fp, &quot;ROC online\r\n&quot;, 12);</span></div><div class="line">                <span class="keywordflow">if</span>(hwversion&gt;2) led(GREEN);</div><div class="line">        }</div><div class="line">        </div><div class="line">        term=zephyr.term[strlen(zephyr.term)-1];</div><div class="line">        readptr=readbuf;</div><div class="line">        memset(readbuf, 0, <span class="keyword">sizeof</span>(readbuf));</div><div class="line"></div><div class="line">        fds[0].fd = zephyr.fp;</div><div class="line">        fds[0].events = POLLIN;</div><div class="line"></div><div class="line"><span class="comment">//      tcgetattr(serial.fp, &amp;options);                                         // Get current port options</span></div><div class="line"><span class="comment">//      options.c_cflag |= CREAD;                                                       // Enable the serial receiver</span></div><div class="line"><span class="comment">//      tcflush(serial.fp,TCIOFLUSH);                                           // Flush serial buffers</span></div><div class="line"><span class="comment">//      if(tcsetattr(serial.fp, TCSANOW, &amp;options) == 0)        // Make the new settings active</span></div><div class="line"></div><div class="line">        Timer = time(NULL);</div><div class="line"></div><div class="line">        <span class="keywordflow">while</span>(!quit)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span> (Timer != time(NULL)) {</div><div class="line">                        Timer = time(NULL);             <span class="comment">// set for next second</span></div><div class="line"></div><div class="line">                        <span class="keywordflow">if</span> (waitingAck) {</div><div class="line">                                waitingAck -= 1;</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">if</span> (waitingIM) {</div><div class="line">                                waitingIM -= 1;</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">if</span>(safeTimeout) { </div><div class="line">                                safeTimeout -= 1;</div><div class="line">                                <span class="keywordflow">if</span> (safeTimeout == 0) { <span class="comment">// Haven&#39;t heard from Zephyr in over 2 hours, enter Standby mode</span></div><div class="line">                                        safeTimeout = SAFETIMEOUT;</div><div class="line">                                        InstMode = SB;</div><div class="line">                                        safeAck = 0;</div><div class="line">                                }</div><div class="line">                        }</div><div class="line"></div><div class="line"><span class="preprocessor">#if 0</span></div><div class="line"><span class="comment">// This section checks to make sure we are not receiving chars in Low Power mode</span></div><div class="line"><span class="comment">// and that we are receiving chras in non-Low Power mode</span></div><div class="line">                        <span class="keywordflow">if</span>(lowPowerCheck)       { </div><div class="line">                                lowPowerCheck -= 1;</div><div class="line">                                <span class="keywordflow">if</span> (lowPowerCheck == 0) { <span class="comment">// Check to make sure we are not receiing chars in Low Power mode</span></div><div class="line">                                        lowPowerCheck = LOWPOWERCHECK;</div><div class="line">                                        <span class="keywordflow">if</span> (verbose)</div><div class="line">                                                printf(<span class="stringliteral">&quot;%s:%d: Check Mode %d Power State with %d GPS Chars: %d\r\n&quot;</span>,</div><div class="line">                                                        MODULE_NAME, Timer, InstMode, gotGPSChars, lowPowerCheckWait);</div><div class="line">                                        <span class="keywordflow">if</span> (InstMode == LP) {</div><div class="line">                                                <span class="keywordflow">if</span> (lowPowerCheckWait == 0) {</div><div class="line">                                                        <span class="keywordflow">if</span> (gotGPSChars &gt; 100) {</div><div class="line">                                                                <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Got %d GPS Chars in LP Mode - Toggle Low Power Line\r\n&quot;</span>, MODULE_NAME, gotGPSChars);</div><div class="line">                                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to low</span></div><div class="line">                                                                usleep(SEPTENTRIOTOGLNG);       <span class="comment">// 300 msecs</span></div><div class="line">                                                                system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line">                                                        }</div><div class="line">                                                        gotGPSChars = 0;</div><div class="line">                                                        lowPowerCheckWait = 5;</div><div class="line">                                                        discardFirstFile = 1;</div><div class="line">                                                } <span class="keywordflow">else</span> {</div><div class="line">                                                        lowPowerCheckWait -= 1;</div><div class="line">                                                }</div><div class="line">                                        } <span class="keywordflow">else</span> {</div><div class="line">                                                <span class="keywordflow">if</span> (lowPowerCheckWait == 0) {</div><div class="line">                                                        <span class="keywordflow">if</span> (gotGPSChars &lt; 100) {</div><div class="line">                                                                <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Only %d GPS Chars in NON LP Mode - Toggle Low Power Line\r\n&quot;</span>, MODULE_NAME, gotGPSChars);</div><div class="line">                                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to low</span></div><div class="line">                                                                usleep(SEPTENTRIOTOGLNG);       <span class="comment">// 300 msecs</span></div><div class="line">                                                                system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line">                                                        }</div><div class="line">                                                        gotGPSChars = 0;</div><div class="line">                                                        lowPowerCheckWait = 8;</div><div class="line">                                                } <span class="keywordflow">else</span> {</div><div class="line">                                                        lowPowerCheckWait -= 1;</div><div class="line">                                                }</div><div class="line">                                        }</div><div class="line">                                }</div><div class="line">                        }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">                }</div><div class="line">                </div><div class="line"><span class="comment">//              if(time(NULL) == nextfile.tv_sec)</span></div><div class="line"><span class="comment">//              {</span></div><div class="line"><span class="comment">//                      nextfile.tv_sec+=file_len;</span></div><div class="line"><span class="comment">//                      NewFile();</span></div><div class="line"><span class="comment">//              }</span></div><div class="line">                usleep(200000);         <span class="comment">// sleep for 0.2s</span></div><div class="line">                </div><div class="line"><span class="comment">//              if(time(NULL) &gt; ackTimeout) waitingAck=0;</span></div><div class="line">                </div><div class="line">                <span class="keywordflow">switch</span>(InstMode)</div><div class="line">                {</div><div class="line">                        <span class="keywordflow">case</span> FL:                <span class="comment">// Flight mode. Check for data files to offload</span></div><div class="line">                <span class="comment">//          if (verbose) printf(&quot;%s: FL Set Safe Output to Low\r\n&quot;, MODULE_NAME);</span></div><div class="line">                                sendIMRatPower = 0;</div><div class="line">                                <span class="keywordflow">switch</span>(hwversion)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">case</span> 3:</div><div class="line">                                                set_safe(OFF);</div><div class="line">                                                <span class="keywordflow">break</span>;</div><div class="line">                                        <span class="keywordflow">default</span>:</div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio193/value&quot;</span>);                 <span class="comment">// Set SAFE digital output to lo</span></div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio233/value&quot;</span>);                 <span class="comment">// Set 5V On</span></div><div class="line">                                                <span class="keywordflow">break</span>;</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">if</span>(modeSwitch)  <span class="comment">// coming out of low power mode, reset GPS</span></div><div class="line">                                {</div><div class="line">                                        modeSwitch=0;</div><div class="line"><span class="comment">// Sepentrio Wakeup</span></div><div class="line">                                        <span class="keywordflow">if</span> (wakeUpFlag) {</div><div class="line">                                                wakeUpFlag = 0;</div><div class="line">                                                <span class="keywordflow">switch</span>(hwversion)</div><div class="line">                                                {</div><div class="line">                                                        <span class="keywordflow">case</span> 3:</div><div class="line">                                                                <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Entering FL mode. GPS power on.\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                                                                gps_power(ON);</div><div class="line">                                                                <span class="keywordflow">break</span>;</div><div class="line">                                                        <span class="keywordflow">default</span>:</div><div class="line">                                                                <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Toggle Wakeup to Septentrio - Flight Mode\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to low</span></div><div class="line">                                                                usleep(SEPTENTRIOTOGLNG);       <span class="comment">// 300 msecs</span></div><div class="line">                                                                system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line">                                                                lowPowerCheckWait = 16;</div><div class="line">                                                                lowPowerCheck = LOWPOWERCHECK;</div><div class="line">                                                                gotGPSChars = 0;</div><div class="line">                                                                <span class="keywordflow">break</span>;</div><div class="line">                                                }</div><div class="line">                                        }</div><div class="line">                                }</div><div class="line"></div><div class="line">                                <span class="keywordflow">if</span>(waitingAck==0)</div><div class="line">                                <span class="keywordflow">if</span>(nextFile = GetNextFile())</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">if</span> (strstr(nextFile,<span class="stringliteral">&quot;list.txt&quot;</span>)) {</div><div class="line">                                                TCflag = 1;</div><div class="line">                                                <span class="keywordflow">if</span>(TClastPart==TCnumParts)              <span class="comment">// we finished the previous file, starting a new one</span></div><div class="line">                                                {</div><div class="line">                                                        strcpy(TCfileOffload, nextFile);</div><div class="line">                                                }</div><div class="line">                                                TCSendFile(TCfileOffload);</div><div class="line">                                        } <span class="keywordflow">else</span> {</div><div class="line">                                                TCflag = 0;</div><div class="line">                                                <span class="keywordflow">if</span>(lastPart==numParts)          <span class="comment">// we finished the previous file, starting a new one</span></div><div class="line">                                                {</div><div class="line">                                                        strcpy(fileOffload, nextFile);</div><div class="line">                                                }</div><div class="line">                                                SendFile(fileOffload);</div><div class="line">                                        }</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                        <span class="keywordflow">case</span> SB:                <span class="comment">// Standby mode. Send IMR msg once per minute until we get an IM msg that forces a mode change</span></div><div class="line">                                <span class="keywordflow">if</span> (modeSwitch) {</div><div class="line">                                        modeSwitch = 0;</div><div class="line">                                        <span class="keywordflow">if</span> (wakeUpFlag &amp;&amp; poweroffgps) {</div><div class="line">                                                <span class="keywordflow">switch</span>(hwversion)</div><div class="line">                                                {</div><div class="line">                                                        <span class="keywordflow">case</span> 3:</div><div class="line"><span class="comment">//                                                              if (verbose) printf(&quot;%s: Entering SB mode. GPS power off.\r\n&quot;, MODULE_NAME);</span></div><div class="line"><span class="comment">//                                                              gps_power(OFF);</span></div><div class="line">                                                                <span class="keywordflow">break</span>;</div><div class="line">                                                        <span class="keywordflow">default</span>:</div><div class="line">                                                                <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Toggle Wakeup to Septentrio - Flight Mode\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to low</span></div><div class="line">                                                                usleep(SEPTENTRIOTOGLNG);       <span class="comment">// 300 msecs</span></div><div class="line">                                                                system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line">                                                                <span class="keywordflow">break</span>;</div><div class="line">                                                }</div><div class="line">                                                wakeUpFlag = 0;</div><div class="line">                                                poweroffgps = 0;</div><div class="line">                                                }</div><div class="line">                                        nextImr = time(NULL)+5;</div><div class="line">                                }</div><div class="line">                <span class="comment">//          if (verbose) printf(&quot;%s: SB Set Safe Output to Low\r\n&quot;, MODULE_NAME);</span></div><div class="line">                                <span class="keywordflow">switch</span>(hwversion)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">case</span> 3:</div><div class="line">                                                set_safe(OFF);</div><div class="line">                                                <span class="keywordflow">break</span>;</div><div class="line">                                        <span class="keywordflow">default</span>:</div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio193/value&quot;</span>);                 <span class="comment">// Set SAFE digital output to lo</span></div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio233/value&quot;</span>);                 <span class="comment">// Set 5V On</span></div><div class="line">                                                <span class="keywordflow">break</span>;</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">if</span>(time(NULL) &gt; nextImr)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">if</span> (sendIMRatPower) {</div><div class="line">                                                <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Sending IMR message\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                                                SendMsg(IMR, <span class="stringliteral">&quot;&quot;</span>, 0);</div><div class="line">                                                waitingIM = WAITFORIM;</div><div class="line">                                        }</div><div class="line">                                        nextImr = time(NULL)+60;</div><div class="line">                                }</div><div class="line"></div><div class="line"><span class="comment">//                              if(time(NULL) &gt; nextTm)</span></div><div class="line"><span class="comment">//                              {</span></div><div class="line"><span class="comment">//                                      if(verbose) printf(&quot;%s: Sending TM housekeeping message\r\n&quot;, MODULE_NAME);</span></div><div class="line"><span class="comment">//                                      dataTm = 0;</span></div><div class="line"><span class="comment">//                                      SendMsg(TM, &quot;&quot;, 0);</span></div><div class="line"><span class="comment">//                                      nextTm = time(NULL)+60;</span></div><div class="line"><span class="comment">//                              }</span></div><div class="line"></div><div class="line">                                <span class="keywordflow">if</span>((nextFile = GetNextFile()) &amp;&amp; !waitingAck &amp;&amp; !waitingIM)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">if</span> (strstr(nextFile,<span class="stringliteral">&quot;list.txt&quot;</span>)) {</div><div class="line">                                                TCflag = 1;</div><div class="line">                                                <span class="keywordflow">if</span>(TClastPart==TCnumParts)              <span class="comment">// we finished the previous file, starting a new one</span></div><div class="line">                                                {</div><div class="line">                                                        strcpy(TCfileOffload, nextFile);</div><div class="line">                                                }</div><div class="line">                                                TCSendFile(TCfileOffload);</div><div class="line">                                        } <span class="keywordflow">else</span> {</div><div class="line">                                                TCflag = 0;</div><div class="line">                                                <span class="keywordflow">if</span>(lastPart==numParts)  {       <span class="comment">// we finished the previous file, starting a new one</span></div><div class="line">                                                        dataTm = 0;</div><div class="line">                                                        SendMsg(TM, <span class="stringliteral">&quot;&quot;</span>, 0);</div><div class="line">                                                        waitingAck=WAITFORACK;</div><div class="line">                                                        RemoveFile(nextFile);</div><div class="line">                                                } <span class="keywordflow">else</span> {</div><div class="line">                                                        SendFile(fileOffload);</div><div class="line">                                                }</div><div class="line">                                        }</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                        <span class="keywordflow">case</span> LP:                <span class="comment">// Low power mode. Put GPS in standby.</span></div><div class="line">                <span class="comment">//          if (verbose) printf(&quot;%s: LP Set Safe Output to Low\r\n&quot;, MODULE_NAME);</span></div><div class="line">                                <span class="keywordflow">switch</span>(hwversion)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">case</span> 3:</div><div class="line">                                                set_safe(OFF);</div><div class="line">                                                <span class="keywordflow">break</span>;</div><div class="line">                                        <span class="keywordflow">default</span>:</div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio193/value&quot;</span>);                 <span class="comment">// Set SAFE digital output to lo</span></div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio233/value&quot;</span>);                 <span class="comment">// Set 5V off</span></div><div class="line">                                                <span class="keywordflow">break</span>;</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">if</span>(modeSwitch)</div><div class="line">                                {</div><div class="line">                                        modeSwitch=0;</div><div class="line"><span class="comment">//                                      system(&quot;echo \&quot;exePowerMode StandBy\&quot; &gt; /dev/ttyS3&quot;);           // Ugly hack for now (use this one for VM testing)</span></div><div class="line"><span class="comment">//                                      if (verbose) printf(&quot;%s: Send Low Power Command to Septentrio\r\n&quot;, MODULE_NAME);</span></div><div class="line"><span class="comment">//                                      system(&quot;echo \&quot;exePowerMode, StandBy\&quot; &gt; /dev/ttyAPP2&quot;);                // Ugly hack for now (use this one for flight HW)</span></div><div class="line">                                        <span class="keywordflow">switch</span>(hwversion)</div><div class="line">                                        {</div><div class="line">                                                <span class="keywordflow">case</span> 3:</div><div class="line">                                                        <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Entering LP mode. GPS off.\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                                                        gps_power(OFF);</div><div class="line">                                                        <span class="keywordflow">break</span>;</div><div class="line">                                                <span class="keywordflow">default</span>:</div><div class="line">                                                        <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Toggle Power Down to Septentrio - Flight Mode\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                                                        system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to low</span></div><div class="line">                                                        usleep(SEPTENTRIOTOGLNG);       <span class="comment">// 300 msecs</span></div><div class="line">                                                        system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line">                                                        <span class="keywordflow">break</span>;</div><div class="line">                                        }</div><div class="line">                                        lowPowerCheckWait = 5;</div><div class="line">                                        gotGPSChars = 0;</div><div class="line">                                        poweroffgps = 1;</div><div class="line">                                        discardFirstFile = 1;                                                                                   <span class="comment">// Flag that power off command to GPS sent</span></div><div class="line">                                }</div><div class="line"><span class="comment">//                              nextImr = time(NULL) + 10000000;</span></div><div class="line"><span class="comment">//                              nextTm = time(NULL)+60;</span></div><div class="line"></div><div class="line">                                <span class="keywordflow">if</span>((nextFile = GetNextFile()) &amp;&amp; !waitingAck &amp;&amp; !waitingIM)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">if</span> (strstr(nextFile,<span class="stringliteral">&quot;list.txt&quot;</span>)) {</div><div class="line">                                                TCflag = 1;</div><div class="line">                                                <span class="keywordflow">if</span>(TClastPart==TCnumParts)              <span class="comment">// we finished the previous file, starting a new one</span></div><div class="line">                                                {</div><div class="line">                                                        strcpy(TCfileOffload, nextFile);</div><div class="line">                                                }</div><div class="line">                                                TCSendFile(TCfileOffload);</div><div class="line">                                        } <span class="keywordflow">else</span> {</div><div class="line">                                                TCflag = 0;</div><div class="line">                                                <span class="keywordflow">if</span>(lastPart==numParts)  {       <span class="comment">// we finished the previous file, starting a new one</span></div><div class="line">                                                        dataTm = 0;</div><div class="line">                                                        SendMsg(TM, <span class="stringliteral">&quot;&quot;</span>, 0);</div><div class="line">                                                        waitingAck=WAITFORACK;</div><div class="line">                                                        RemoveFile(nextFile);</div><div class="line">                                                } <span class="keywordflow">else</span> {</div><div class="line">                                                        SendFile(fileOffload);</div><div class="line">                                                }</div><div class="line">                                        }</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                        <span class="keywordflow">case</span> SA:                <span class="comment">// Safety mode.</span></div><div class="line">                                <span class="keywordflow">if</span>(hwversion&lt;3) system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio233/value&quot;</span>);                 <span class="comment">// Set 5V On</span></div><div class="line">                                <span class="keywordflow">if</span> (modeSwitch) {</div><div class="line">                                        nextS = time(NULL) + 60;</div><div class="line">                                        safeAck = 0;</div><div class="line">                                        SendMsg(S, <span class="stringliteral">&quot;&quot;</span>, 0);              <span class="comment">// We need to send an S msg every time Zephyr sends us IM.S                                     </span></div><div class="line">                                        modeSwitch = 0;</div><div class="line"><span class="preprocessor">#if 0</span></div><div class="line">                                        <span class="keywordflow">if</span> (wakeUpFlag &amp;&amp; poweroffgps) {</div><div class="line">                                                <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Toggle Wakeup to Septentrio - Flight Mode\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio200/value&quot;</span>);                 <span class="comment">// Set value to low</span></div><div class="line">                                                usleep(500000); <span class="comment">// 500 msecs</span></div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio200/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line">                                                wakeUpFlag = 0;</div><div class="line">                                                poweroffgps = 0;</div><div class="line">                                        }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">                                }</div><div class="line"></div><div class="line">                                <span class="keywordflow">if</span>((time(NULL) &gt; nextS) <span class="comment">/*&amp;&amp; !safeAck*/</span>)</div><div class="line">                                {</div><div class="line">                                        SendMsg(S, <span class="stringliteral">&quot;&quot;</span>, 0);</div><div class="line">                                        nextS = time(NULL)+60;</div><div class="line">                                        safeAck = 0;</div><div class="line">                                }</div><div class="line"></div><div class="line"><span class="comment">//                      if (verbose) printf(&quot;%s: SA Set Safe Output to High\r\n&quot;, MODULE_NAME);</span></div><div class="line">                                <span class="keywordflow">switch</span>(hwversion)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">case</span> 3:</div><div class="line">                                                set_safe(ON);</div><div class="line">                                                <span class="keywordflow">break</span>;</div><div class="line">                                        <span class="keywordflow">default</span>:</div><div class="line">                                                system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio193/value&quot;</span>);                 <span class="comment">// Set SAFE digital output to high</span></div><div class="line">                                                <span class="keywordflow">break</span>;</div><div class="line">                                }</div><div class="line"><span class="comment">//                              nextImr = time(NULL) + 10000000;</span></div><div class="line"></div><div class="line">                                <span class="keywordflow">if</span> ((nextFile = GetNextFile()) &amp;&amp; !waitingAck)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">if</span> (strstr(nextFile,<span class="stringliteral">&quot;list.txt&quot;</span>)) {</div><div class="line">                                                TCflag = 1;</div><div class="line">                                                <span class="keywordflow">if</span>(TClastPart==TCnumParts)              <span class="comment">// we finished the previous file, starting a new one</span></div><div class="line">                                                {</div><div class="line">                                                        strcpy(TCfileOffload, nextFile);</div><div class="line">                                                }</div><div class="line">                                                TCSendFile(TCfileOffload);</div><div class="line">                                        } <span class="keywordflow">else</span> {</div><div class="line">                                                TCflag = 0;</div><div class="line">                                                <span class="keywordflow">if</span>(lastPart==numParts)  {       <span class="comment">// we finished the previous file, starting a new one</span></div><div class="line">                                                        dataTm = 0;</div><div class="line">                                                        SendMsg(TM, <span class="stringliteral">&quot;&quot;</span>, 0);</div><div class="line">                                                        waitingAck=WAITFORACK;</div><div class="line">                                                        RemoveFile(nextFile);</div><div class="line">                                                } <span class="keywordflow">else</span> {</div><div class="line">                                                        SendFile(fileOffload);</div><div class="line">                                                }</div><div class="line">                                        }</div><div class="line">                                }</div><div class="line"></div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                                </div><div class="line">                        <span class="keywordflow">case</span> EF:                <span class="comment">// End flight mode. Shutdown, stop all Zephyr comms.</span></div><div class="line"><span class="comment">//                              system(&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio233/value&quot;);                 // Set 5V Off</span></div><div class="line"><span class="comment">//                              shutdown = TRUE;        // I thought we were supposed to shut down here but that&#39;s apparently not correct.</span></div><div class="line"><span class="comment">//                              quit=1;                         // Just do nothing for now.</span></div><div class="line">                                <span class="keywordflow">if</span> (modeSwitch) {</div><div class="line">                                        modeSwitch = 0;</div><div class="line"><span class="comment">//                                      system(&quot;echo \&quot; \&quot; &gt; /dev/ttyAPP2&quot;);            // wakeup</span></div><div class="line">                                }</div><div class="line"></div><div class="line"><span class="comment">//                              nextImr = time(NULL) + 10000000;</span></div><div class="line">                                <span class="keywordflow">if</span>((nextFile = GetNextFile()) &amp;&amp; (waitingAck==0))</div><div class="line">                                {</div><div class="line">                                        RemoveFile(nextFile);</div><div class="line">                                }</div><div class="line"></div><div class="line">                                safeTimeout = SAFETIMEOUT;</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        <span class="keywordflow">default</span>:</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">                </div><div class="line">                <span class="keywordflow">if</span>(poll (fds, 1, 10)) {</div><div class="line"><span class="comment">//                      if ((fds [1].revents &amp; POLLIN) || ((data_readptr-1) &gt; data_endptr))</span></div><div class="line">                        <span class="keywordflow">if</span> (fds [0].revents &amp; POLLIN)           <span class="comment">// incoming data on Zephyr serial port</span></div><div class="line">                        {</div><div class="line">                                err = ioctl(zephyr.fp, FIONREAD, &amp;i);</div><div class="line">                                <span class="keywordflow">if</span>(err)</div><div class="line">                                {</div><div class="line">                                        fprintf(stderr,<span class="stringliteral">&quot;%s: I/O error, exiting.&quot;</span>,MODULE_NAME);</div><div class="line">                                        shutdown = FALSE;</div><div class="line">                                        quit=TRUE;</div><div class="line">                                }</div><div class="line"></div><div class="line">        <span class="comment">//                      if(verbose) printf(&quot;%d bytes ready to read from %s\r\n&quot;,i, gps_data.port);</span></div><div class="line">                                <span class="keywordflow">if</span>((readptr + i - readbuf) &gt; INBUFSIZE) <span class="comment">// Serial read will overrun buffer if we do it</span></div><div class="line">                                {</div><div class="line">                                        fprintf(stderr, <span class="stringliteral">&quot;%s: Serial buffer overrun. Data lost!\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                                        readptr=readbuf;</div><div class="line">                                        memset(readbuf, 0, <span class="keyword">sizeof</span>(readbuf));</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">else</span></div><div class="line">                                {</div><div class="line">                                        safeTimeout = SAFETIMEOUT;      <span class="comment">// Enter safety mode if no data from Zephyr in 10 minutes</span></div><div class="line">        <span class="comment">//                              printf(&quot;readbuf=%x  readptr=%x\r\n&quot;,readbuf,readptr);</span></div><div class="line">                                        numread = read(zephyr.fp, readptr, i);</div><div class="line">                                        readptr += numread;</div><div class="line">        <span class="comment">//                              printf(&quot;first char = 0x%d\r\n&quot;,readbuf[0]);</span></div><div class="line">                                        <span class="keywordflow">if</span>(strstr(readbuf, <span class="stringliteral">&quot;&lt;/CRC&gt;\n&quot;</span>))                 <span class="comment">// Found end of a message</span></div><div class="line">                                        {</div><div class="line">                                                readptr=readbuf;</div><div class="line">                                                <span class="keywordflow">if</span> (verbose) printf(readbuf);</div><div class="line">                                                fflush(stdout);</div><div class="line">                                                <span class="keywordflow">while</span>(endptr=strstr(readptr, <span class="stringliteral">&quot;&lt;/CRC&gt;\n&quot;</span>))</div><div class="line">                                                {</div><div class="line">                                                        sscanf(readptr,<span class="stringliteral">&quot;&lt;%s&gt;&quot;</span>,InMsgTypeStr);</div><div class="line">                                                        InMsgTypeStr[strlen(InMsgTypeStr)-1]=0;         <span class="comment">// Remove trailing &gt;</span></div><div class="line">                                                        InMsgType=MsgType(InMsgTypeStr);</div><div class="line">                                                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Received message type %d\r\n&quot;</span>,MODULE_NAME, InMsgType);</div><div class="line">                                                        MsgHandler(InMsgType, readbuf);</div><div class="line">                                                        readptr=endptr+strlen(<span class="stringliteral">&quot;&lt;/CRC&gt;\n&quot;</span>);</div><div class="line"></div><div class="line">                                                        nextMsgTime.tv_nsec += 300000000;                                               <span class="comment">// next message (1 sec from now)</span></div><div class="line">                                                        <span class="keywordflow">if</span> (nextMsgTime.tv_nsec &gt; 1000000000) {</div><div class="line">                                                                nextMsgTime.tv_nsec -= 1000000000;                                              <span class="comment">// next message (1 sec from now)</span></div><div class="line">                                                                nextMsgTime.tv_sec += 1;                                                <span class="comment">// next message (1 sec from now)</span></div><div class="line">                                                        }</div><div class="line">                                                }</div><div class="line">                                                readptr=readbuf;</div><div class="line">                                                memset(readbuf, 0, <span class="keyword">sizeof</span>(readbuf));</div><div class="line">                                        }</div><div class="line">                                        <span class="keywordflow">else</span></div><div class="line">                                        {</div><div class="line">        <span class="comment">//                                      printf(&quot;read %d bytes\r\n&quot;,numread);</span></div><div class="line">        <span class="comment">//                                      printf(readbuf);</span></div><div class="line">        <span class="comment">//                                      fflush(stdout);</span></div><div class="line">                                        }</div><div class="line">                                                </div><div class="line">                                }</div><div class="line">                        }</div><div class="line">                } </div><div class="line"><span class="comment">//              else</span></div><div class="line"><span class="comment">//              {</span></div><div class="line"><span class="comment">//                      if(time(NULL) &gt; safeTimeout)    // Haven&#39;t heard from Zephyr in over 2 hours, enter Safety mode</span></div><div class="line"><span class="comment">//                      {</span></div><div class="line"><span class="comment">//                              InstMode = SA;</span></div><div class="line"><span class="comment">//                      }</span></div><div class="line"><span class="comment">//              }</span></div><div class="line">        }</div><div class="line"></div><div class="line">        ZephyrCleanup();</div><div class="line">        printf(<span class="stringliteral">&quot;%s: Module stopped.\r\n&quot;</span>,MODULE_NAME);</div><div class="line"></div><div class="line">        exit(BCSUCCESS);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> MsgHandler(<span class="keyword">enum</span> msg msgtype, <span class="keywordtype">char</span> *msgdata)</div><div class="line">{</div><div class="line">        <span class="keywordflow">switch</span>(msgtype)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> IM:</div><div class="line">                        <span class="keywordflow">return</span>(HandleIM(msgdata));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> SAck:</div><div class="line">                        <span class="keywordflow">return</span>(HandleSAck(msgdata));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> SW:</div><div class="line">                        <span class="keywordflow">return</span>(HandleSW(msgdata));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> TMAck:</div><div class="line">                        <span class="keywordflow">if</span>(HandleTMAck(msgdata))</div><div class="line">                        {</div><div class="line">                                waitingAck=0;</div><div class="line">                                <span class="keywordflow">if</span>(dataTm)</div><div class="line">                                {</div><div class="line">                                        <span class="keywordflow">if</span> (TCflag) {</div><div class="line">                                                TClastPart++;</div><div class="line">                                                <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Rcvd TMAck. File %s Part %d/%d\r\n&quot;</span>,MODULE_NAME,TCfileOffload,TClastPart,TCnumParts);</div><div class="line">                                                <span class="keywordflow">if</span>(TClastPart==TCnumParts)              <span class="comment">// done with file transfer</span></div><div class="line">                                                {</div><div class="line">                                                        RemoveFile(TCfileOffload);</div><div class="line">                                                        TCflag = 0;</div><div class="line">                                                }</div><div class="line">                                        } <span class="keywordflow">else</span> {</div><div class="line">                                                lastPart++;</div><div class="line">                                                <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Rcvd TMAck. File %s Part %d/%d\r\n&quot;</span>,MODULE_NAME,fileOffload,lastPart,numParts);</div><div class="line">                                                <span class="keywordflow">if</span>(lastPart==numParts)          <span class="comment">// done with file transfer</span></div><div class="line">                                                {</div><div class="line">                                                        RemoveFile(fileOffload);</div><div class="line">                                                }                                               </div><div class="line">                                        }</div><div class="line">                                        <span class="keywordflow">return</span>(1);</div><div class="line">                                }</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">else</span></div><div class="line">                        {</div><div class="line">                                <span class="keywordflow">return</span>(0);</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> TC:</div><div class="line">                        <span class="keywordflow">return</span>(HandleTC(msgdata));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> GPS:</div><div class="line">                        <span class="keywordflow">return</span>(HandleGPS(msgdata));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">return</span>(-1);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> HandleIM(<span class="keywordtype">char</span> *msgdata)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> modestr[3]=<span class="stringliteral">&quot;&quot;</span>;</div><div class="line">        <span class="keywordtype">char</span> *loc;</div><div class="line">        <span class="keyword">enum</span> mode newmode;</div><div class="line"></div><div class="line">        waitingIM = 0;</div><div class="line">        </div><div class="line">        loc=strstr(msgdata, <span class="stringliteral">&quot;&lt;Mode&gt;&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span> (loc == 0) {</div><div class="line">                <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: HandleIM &lt;Mode&gt; not found, ERROR!!!\r\n&quot;</span>,MODULE_NAME);</div><div class="line">                <span class="keywordflow">return</span>;</div><div class="line">        }</div><div class="line">        strncpy(modestr,loc+strlen(<span class="stringliteral">&quot;&lt;Mode&gt;&quot;</span>),2);</div><div class="line">        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Switching to mode %s\r\n&quot;</span>,MODULE_NAME, modestr);</div><div class="line">        LastMode = InstMode;            <span class="comment">// Save current inst mode</span></div><div class="line">        <span class="keywordflow">if</span>(strncmp(modestr, <span class="stringliteral">&quot;FL&quot;</span>, 2)==0)        <span class="comment">///&lt; Switch to flight mode</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                newmode=FL;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(modestr, <span class="stringliteral">&quot;SB&quot;</span>, 2)==0)   <span class="comment">///&lt; Switch to Standby mode</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                newmode=SB;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(modestr, <span class="stringliteral">&quot;LP&quot;</span>, 2)==0)   <span class="comment">///&lt; Switch to Low Power mode</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                newmode=LP;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(modestr, <span class="stringliteral">&quot;SA&quot;</span>, 2)==0)   <span class="comment">///&lt; Switch to Safety mode</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                newmode=SA;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(modestr, <span class="stringliteral">&quot;EF&quot;</span>, 2)==0)   <span class="comment">///&lt; Switch to End Flight mode</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                newmode=EF;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Unknown mode change request: %s\r\n&quot;</span>, MODULE_NAME, modestr);</div><div class="line">                <span class="keywordflow">return</span>(-1);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Now in mode %d\r\n&quot;</span>, MODULE_NAME, newmode);</div><div class="line">        <span class="keywordflow">if</span> ((InstMode != newmode) || (newmode==SA)) {</div><div class="line">                modeSwitch = 1;</div><div class="line"><span class="comment">// Do wake up when coming out of LP,SA or EF since we may have been gone to SA or EF from LP</span></div><div class="line">                <span class="keywordflow">if</span> (InstMode == LP) {</div><div class="line"><span class="comment">//                      if ((newmode == FL) || (newmode == SB)) {</span></div><div class="line">                                wakeUpFlag = 1; <span class="comment">// only toggle wake up after low power mode</span></div><div class="line"><span class="comment">//                      }</span></div><div class="line">                }</div><div class="line"></div><div class="line"><span class="comment">// Do wake up when coming out of SA or EF since we may have been gone to SA or EF from LP</span></div><div class="line"><span class="comment">//              if ((InstMode == SA) || (InstMode == EF)) {</span></div><div class="line"><span class="comment">//                      wakeUpFlag = 1; // only toggle wake up after low power mode</span></div><div class="line"><span class="comment">//              }</span></div><div class="line">        } </div><div class="line">        InstMode = newmode;</div><div class="line">        SendMsg(IMAck, <span class="stringliteral">&quot;&quot;</span>, 0);</div><div class="line">        <span class="comment">//if(newmode==SA)</span></div><div class="line">        <span class="comment">//{</span></div><div class="line">        <span class="comment">//      SendMsg(S, &quot;&quot;, 0);              // We need to send an S msg every time Zephyr sends us IM.S</span></div><div class="line">        <span class="comment">//}</span></div><div class="line"><span class="comment">//      nextImr = time(NULL) + 10000000;                // Set timer way into future so no more IMR msgs go out</span></div><div class="line"><span class="comment">//      return(newmode);</span></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> HandleSAck(<span class="keywordtype">char</span> *msgdata)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> ackstr[4]=<span class="stringliteral">&quot;&quot;</span>;</div><div class="line">        <span class="keywordtype">char</span> *loc;</div><div class="line">        </div><div class="line">        loc=strstr(msgdata, <span class="stringliteral">&quot;&lt;Ack&gt;&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span> (loc == 0) {</div><div class="line">                <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: HandleSAck &lt;Ack&gt; not found, ERROR!!!\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                <span class="keywordflow">return</span> (0);</div><div class="line">        }</div><div class="line">        strncpy(ackstr,loc+strlen(<span class="stringliteral">&quot;&lt;Ack&gt;&quot;</span>),3);</div><div class="line">        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Ack is %s\r\n&quot;</span>, MODULE_NAME, ackstr);</div><div class="line">        <span class="keywordflow">if</span>(!strncmp(ackstr,<span class="stringliteral">&quot;ACK&quot;</span>,3)) </div><div class="line">        {</div><div class="line">                safeAck = 1;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> </div><div class="line">        {</div><div class="line">                safeAck = 0;</div><div class="line">        }</div><div class="line">        </div><div class="line">        <span class="keywordflow">return</span>(safeAck);</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> HandleSW(<span class="keywordtype">char</span> *msgdata)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Received shutdown warning.\r\n&quot;</span>, MODULE_NAME);</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> HandleTMAck(<span class="keywordtype">char</span> *msgdata)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> ackstr[4]=<span class="stringliteral">&quot;&quot;</span>;</div><div class="line">        <span class="keywordtype">char</span> *loc;</div><div class="line">        </div><div class="line">        loc=strstr(msgdata, <span class="stringliteral">&quot;&lt;Ack&gt;&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span> (loc == 0) {</div><div class="line">                <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Handle TMAck &lt;Ack&gt; not found, ERROR!!!\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                <span class="keywordflow">return</span> (0);</div><div class="line">        }</div><div class="line">        strncpy(ackstr,loc+strlen(<span class="stringliteral">&quot;&lt;Ack&gt;&quot;</span>),3);</div><div class="line">        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Ack is %s\r\n&quot;</span>, MODULE_NAME, ackstr);</div><div class="line">        <span class="keywordflow">if</span>(!strncmp(ackstr,<span class="stringliteral">&quot;ACK&quot;</span>,3)) <span class="keywordflow">return</span>(1);</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">return</span>(0);</div><div class="line">}</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/** @brief  HandleTC() reads the TC commands and returns a terminal echo of the response</span></div><div class="line"><span class="comment"> *      </span></div><div class="line"><span class="comment"> *      1. To carry out a telecommand (TC), user types in the linux command in &#39;cmd&#39; under /root/LV/TC_Files. Note: Only one file can exist here at a time</span></div><div class="line"><span class="comment"> *      2. Zephyr wraps cmd in standard XML format and sends to ROC</span></div><div class="line"><span class="comment"> *      3. HandleTC() decipher XML format and reads the linux command</span></div><div class="line"><span class="comment"> *      4. HandleTC() compares the command to the list and executes it</span></div><div class="line"><span class="comment"> *      5. HandleTC() copies linux terminal output to file under /queue, which is automatically sent back to Zephyr Module</span></div><div class="line"><span class="comment"> *      </span></div><div class="line"><span class="comment"> *      @param *msgdata pointer to the zephyr TC file containing TC instructions</span></div><div class="line"><span class="comment"> *      @return 0 on error</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> HandleTC(<span class="keywordtype">char</span> *msgdata)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> lenstr[8]=<span class="stringliteral">&quot;&quot;</span>;</div><div class="line">        <span class="keywordtype">char</span> cmdstr[128];</div><div class="line">        <span class="keywordtype">char</span> *loc, *payload, *filename;</div><div class="line">        <span class="keywordtype">int</span> len, doit;</div><div class="line">        FILE *f;</div><div class="line">        </div><div class="line">        loc=strstr(msgdata, <span class="stringliteral">&quot;&lt;Length&gt;&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span> (loc == 0) {</div><div class="line">                <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: HandleTC &lt;Length&gt; not found, ERROR!!!\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                <span class="keywordflow">return</span> (0);</div><div class="line">        }</div><div class="line">        sscanf(loc+strlen(<span class="stringliteral">&quot;&lt;Length&gt;&quot;</span>),<span class="stringliteral">&quot;%d&quot;</span>,&amp;len);</div><div class="line">        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Rcvd TC msg. Payload is %d bytes\r\n&quot;</span>, MODULE_NAME, len);</div><div class="line">        payload=malloc(len);</div><div class="line">        </div><div class="line">        loc=strstr(msgdata, <span class="stringliteral">&quot;&lt;/CRC&gt;\n&quot;</span>)+strlen(<span class="stringliteral">&quot;&lt;/CRC&gt;\n&quot;</span>);             <span class="comment">// point to beginning of binary section</span></div><div class="line">        <span class="keywordflow">if</span> (loc == 0) {</div><div class="line">                <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: HandleTC &lt;/CRC&gt; not found, ERROR!!!\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                free(payload);</div><div class="line">                <span class="keywordflow">return</span> (0);</div><div class="line">        }</div><div class="line">        <span class="comment">//printf(&quot;LOC:%c&quot;, loc[0]);</span></div><div class="line">        loc+=strlen(<span class="stringliteral">&quot;START&quot;</span>);                                                                   <span class="comment">// skip over binary section header</span></div><div class="line">        memcpy(payload, loc, len);                                                              <span class="comment">// copy payload into buffer</span></div><div class="line">        <span class="comment">//printf(&quot;:%c:%2.2s\n&quot;, loc[0], payload);</span></div><div class="line">        </div><div class="line"><span class="comment">/*      loc=strstr(payload,&quot;!!&quot;);                                                               // search for !! that separates filename from data</span></div><div class="line"><span class="comment">        filename=malloc(strlen(pathUpload)+(loc-payload));              // allocate space for name of upload file</span></div><div class="line"><span class="comment">        memcpy(filename, pathUpload, strlen(pathUpload));               // copy upload directory into filename</span></div><div class="line"><span class="comment">        memcpy(filename+strlen(pathUpload), payload, loc-payload);                              // copy filename</span></div><div class="line"><span class="comment">        loc+=2;                                                                                                 // point to beginning of data</span></div><div class="line"><span class="comment">        </span></div><div class="line"><span class="comment">        f = fopen(filename, &quot;w&quot;);</span></div><div class="line"><span class="comment">        printf(&quot;Writing %s to file %s\r\n&quot;, loc, filename);</span></div><div class="line"><span class="comment">        fwrite(loc, 1, len-(loc-payload), f);</span></div><div class="line"><span class="comment">        fclose(f); */</span></div><div class="line">        </div><div class="line">        SendMsg(TCAck, <span class="stringliteral">&quot;&quot;</span>, 0);</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(memmem(payload, len, <span class="stringliteral">&quot;ls&quot;</span>, strlen(<span class="stringliteral">&quot;ls&quot;</span>)))    <span class="comment">// do &quot;ls -1&quot; on queue and put results in file for offload</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;ls -l /data/roc/queue &gt; /data/roc/queue/list.txt&quot;</span>);</div><div class="line">                doit=1;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(memmem(payload, len, <span class="stringliteral">&quot;reboot&quot;</span>, strlen(<span class="stringliteral">&quot;reboot&quot;</span>)))       <span class="comment">// reboot ROC</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;reboot&quot;</span>);       </div><div class="line">                doit=1;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(memmem(payload, len, <span class="stringliteral">&quot;clear&quot;</span>, strlen(<span class="stringliteral">&quot;clear&quot;</span>))) <span class="comment">// clear download queue</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;rm %s/*&quot;</span>,queueDir);</div><div class="line">                doit=0;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Executing command &#39;%s&#39;\r\n&quot;</span>, MODULE_NAME, cmdstr);</div><div class="line">        <span class="keywordflow">if</span>(doit) system(cmdstr);</div><div class="line"></div><div class="line">        </div><div class="line">        free(payload);</div><div class="line"><span class="comment">//      free(filename);</span></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> HandleGPS(<span class="keywordtype">char</span> *msgdata)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Received GPS message.\r\n&quot;</span>, MODULE_NAME);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Performs module initialization</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// Calls LoadConfigFileSettings() to load the configuration file settings for this module and calls</span></div><div class="line"><span class="comment">/// CmdLineHandler() to handle any command line options. Finally configures a ZMQ REP</span></div><div class="line"><span class="comment">/// socket to listen for messages from other modules.</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// \param argc Number of command line arguments passed to main().</span></div><div class="line"><span class="comment">/// \param argv[] List of command line arguments passed to main().</span></div><div class="line"><span class="comment">/// \return</span></div><div class="line"><span class="comment">/// - BCSUCCESS if successful.</span></div><div class="line"><span class="comment">/// - BCCONFIGREADERROR indicates an error in LoadConfigFileSettings().</span></div><div class="line"><span class="comment">/// - BCCMDLINEERROR indicates an error in CmdLineHandler().</span></div><div class="line"><span class="comment">/// - BCZMQOPTERROR indicates an error setting the options of a ZMQ socket.</span></div><div class="line"><span class="comment">/// - BCMODLISTERROR indicates an error in PopulateModules().</span></div><div class="line"><span class="comment">/// - BCZMQBINDERROR indicates an error binding the ZMQ REP socket.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">int</span> ZephyrInit(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> err, port;</div><div class="line"></div><div class="line">        verbose = FALSE;</div><div class="line">        quit = FALSE;</div><div class="line"></div><div class="line">        fclose(stdin);</div><div class="line"></div><div class="line">        <span class="comment">// Read config file</span></div><div class="line">        <span class="keywordflow">if</span>(LoadConfigFileSettings(&amp;cfgZephyr, pathCfgZephyr) != BCSUCCESS)</div><div class="line">                <span class="keywordflow">return</span>(BCCONFIGREADERROR);              </div><div class="line"></div><div class="line">        <span class="comment">// Parse command line options</span></div><div class="line">        <span class="keywordflow">if</span>(CmdLineHandler(argc, argv) != BCSUCCESS)</div><div class="line">        {</div><div class="line">                Usage();</div><div class="line">                <span class="keywordflow">return</span>(BCCMDLINEERROR);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Set up serial ports</span></div><div class="line">        err = SerialPortInit(zephyr);</div><div class="line">        <span class="keywordflow">if</span>(err != BCSUCCESS)</div><div class="line">                <span class="keywordflow">return</span>(err);</div><div class="line">        </div><div class="line">        <span class="comment">// Set up data logging</span></div><div class="line"><span class="comment">//      CreateDayDirectory();</span></div><div class="line"><span class="comment">//      OpenLogFile(MODULE_NAME);</span></div><div class="line"><span class="comment">//      clock_gettime(CLOCK_REALTIME, &amp;now);    // use internal clock for now. Eventually get times from data blocks</span></div><div class="line"><span class="comment">//      nextfile.tv_sec = now.tv_sec + file_len;</span></div><div class="line"><span class="comment">//      nextfile.tv_nsec = now.tv_nsec;</span></div><div class="line">        </div><div class="line">        poweroffgps = 0;</div><div class="line">        MsgID = 0;</div><div class="line">        InstMode = SB;</div><div class="line">        modeSwitch = 0;</div><div class="line">        wakeUpFlag = 0;</div><div class="line">        safeAck = 0;</div><div class="line">        numParts = TCnumParts = 0;</div><div class="line">        lastPart = TClastPart = 0;</div><div class="line">        waitingAck = 0;</div><div class="line">        waitingIM = 0;</div><div class="line">        shutdown = FALSE;</div><div class="line">        safeTimeout = SAFETIMEOUT;              <span class="comment">// Enter Safe mode if we don&#39;t hear from Zephyr in 10 minutes</span></div><div class="line">        lowPowerCheck = LOWPOWERCHECK;  <span class="comment">// Time Interval to check for low power state</span></div><div class="line">        lowPowerCheckWait = 5;                  <span class="comment">// wait an extra cycle before checking</span></div><div class="line">        discardFirstFile = 0;</div><div class="line">        clock_gettime(CLOCK_REALTIME, &amp;nextMsgTime);    <span class="comment">// OK to send msg at any time</span></div><div class="line">        nextImr = time(NULL)+5;</div><div class="line"></div><div class="line">        <span class="comment">// Set up named pipe</span></div><div class="line">        printf(<span class="stringliteral">&quot;%s: mkfifo returned %d\r\n&quot;</span>, MODULE_NAME, mkfifo(ipcPipe, 0666));</div><div class="line">        pipefp = fopen(ipcPipe, <span class="stringliteral">&quot;r+&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(pipefp)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Opened named pipe successfully\r\n&quot;</span>, MODULE_NAME);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Attempt to open named pipe returned %d\r\n&quot;</span>, MODULE_NAME, errno);</div><div class="line">        }</div><div class="line">        </div><div class="line">        <span class="keywordflow">switch</span>(hwversion)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> 3:</div><div class="line">                        gps_power(ON);  <span class="comment">// Note: this also turns on power to LED&#39;s</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Init: Set Safe Export\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;193\&quot; &gt; /sys/class/gpio/export&quot;</span>);                                <span class="comment">// Prepare SAFE digital output</span></div><div class="line">                        <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Init: Set Safe Direction\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;out\&quot; &gt; /sys/class/gpio/gpio193/direction&quot;</span>);             <span class="comment">// Set as output</span></div><div class="line">                        <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Init: Set Safe Low\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;0\&quot;   &gt; /sys/class/gpio/gpio193/value&quot;</span>);                 <span class="comment">// Set value to low</span></div><div class="line">        </div><div class="line">                        <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Init: Set nRST Export\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;200\&quot; &gt; /sys/class/gpio/export&quot;</span>);                                <span class="comment">// Prepare SAFE digital output</span></div><div class="line">                        <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Init: Set nRST Direction\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;out\&quot; &gt; /sys/class/gpio/gpio200/direction&quot;</span>);             <span class="comment">// Set as output</span></div><div class="line">                        <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Init: Set nRST Low\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio200/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line"></div><div class="line">                        <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Init: Set TogglePwr Export\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;202\&quot; &gt; /sys/class/gpio/export&quot;</span>);                                <span class="comment">// Prepare SAFE digital output</span></div><div class="line">                        <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Init: Set nRST Direction\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;out\&quot; &gt; /sys/class/gpio/gpio202/direction&quot;</span>);             <span class="comment">// Set as output</span></div><div class="line">                        <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Init: Set nRST Low\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio202/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line"></div><div class="line">                        <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Init: Set 5VPwr Export\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;233\&quot; &gt; /sys/class/gpio/export&quot;</span>);                                <span class="comment">// Prepare SAFE digital output</span></div><div class="line">                        <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Init: Set 5VPwr Direction\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;out\&quot; &gt; /sys/class/gpio/gpio233/direction&quot;</span>);             <span class="comment">// Set as output</span></div><div class="line">                        <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: Init: Set 5VPwr High(on)\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        system(<span class="stringliteral">&quot;echo \&quot;1\&quot;   &gt; /sys/class/gpio/gpio233/value&quot;</span>);                 <span class="comment">// Set value to high</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">        </div><div class="line">        <span class="keywordflow">return</span>(BCSUCCESS);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Closes sockets and frees memory.</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// There will be some serial port clean up stuff in here.</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// \return Always returns BCSUCCESS</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">int</span> ZephyrCleanup(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (zephyr.port) free(zephyr.port);</div><div class="line">        <span class="keywordflow">if</span> (data_dir) free(data_dir);</div><div class="line"></div><div class="line">        close(zephyr.fp);</div><div class="line">        <span class="keywordflow">if</span>(shutdown) system(<span class="stringliteral">&quot;shutdown now&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span>(BCSUCCESS);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Parses command line arguments.</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// \param argc Number of command line arguments passed to main().</span></div><div class="line"><span class="comment">/// \param argv[] List of command line arguments passed to main().</span></div><div class="line"><span class="comment">/// \return</span></div><div class="line"><span class="comment">/// - BCSUCCESS if successful</span></div><div class="line"><span class="comment">/// - BCERROR if there was an error parsing any of the command line options</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">int</span> CmdLineHandler(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i;</div><div class="line"></div><div class="line">        opterr=0;</div><div class="line">        optind=0;       <span class="comment">// Reinitialize getopt()</span></div><div class="line"></div><div class="line">        <span class="keywordflow">while</span> ((i = getopt (argc, argv, cloptions)) != -1)</div><div class="line">        <span class="keywordflow">switch</span> (i)</div><div class="line">                {</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;v&#39;</span>:               <span class="comment">// &#39;v&#39; option turns on verbose mode</span></div><div class="line">                                verbose = TRUE;</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line"><span class="comment">//                      case &#39;l&#39;:               // &#39;l&#39; option specifies data file length</span></div><div class="line"><span class="comment">//                              file_len=get_baud(atoi(optarg));</span></div><div class="line"><span class="comment">//                              if((file_len &lt; 0) || (file_len &gt; 3600))</span></div><div class="line"><span class="comment">//                              {</span></div><div class="line"><span class="comment">//                                      fprintf(stderr, &quot;%s: Invalid file length setting %s\r\n&quot;, MODULE_NAME, optarg);</span></div><div class="line"><span class="comment">//                                      return(BCERROR);</span></div><div class="line"><span class="comment">//                              }</span></div><div class="line"><span class="comment">//                              printf(&quot;File length = %d\r\n&quot;,file_len);</span></div><div class="line"><span class="comment">//                              break;</span></div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:               <span class="comment">// &#39;p&#39; option specifies serial port to use</span></div><div class="line">                                free(zephyr.port);</div><div class="line">                                zephyr.port = malloc(strlen(optarg)+1);</div><div class="line">                                strcpy(zephyr.port, optarg);</div><div class="line">                                <span class="keywordflow">if</span>(zephyr.port == NULL)</div><div class="line">                                {</div><div class="line">                                        fprintf(stderr, <span class="stringliteral">&quot;%s: Error setting serial port to %s\r\n&quot;</span>,MODULE_NAME,optarg);</div><div class="line">                                        <span class="keywordflow">return</span>(BCERROR);</div><div class="line">                                }</div><div class="line">                                printf(<span class="stringliteral">&quot;Port = %s\r\n&quot;</span>,zephyr.port);</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:               <span class="comment">// &#39;s&#39; option specifies serial port speed</span></div><div class="line">                                zephyr.speed=get_baud(atoi(optarg));</div><div class="line">                                zephyr.speed=get_baud(atoi(optarg));</div><div class="line">                                <span class="keywordflow">if</span>(zephyr.speed == BCERROR)</div><div class="line">                                {</div><div class="line">                                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid bits setting %s\r\n&quot;</span>, MODULE_NAME, optarg);</div><div class="line">                                        <span class="keywordflow">return</span>(BCERROR);</div><div class="line">                                }</div><div class="line">                                printf(<span class="stringliteral">&quot;Speed = %d\r\n&quot;</span>,zephyr.speed);</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;b&#39;</span>:               <span class="comment">// &#39;b&#39; option specifies serial port bit settings</span></div><div class="line">                                <span class="keywordflow">if</span>(verify_bits(optarg))</div><div class="line">                                {</div><div class="line">                                        zephyr.bits = optarg[0]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                                        zephyr.parity = optarg[1];</div><div class="line">                                        zephyr.stop = optarg[2]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                                        zephyr.bits = optarg[0]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                                        zephyr.parity = optarg[1];</div><div class="line">                                        zephyr.stop = optarg[2]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">else</span></div><div class="line">                                {</div><div class="line">                                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid bits setting %s\r\n&quot;</span>, MODULE_NAME, optarg);</div><div class="line">                                        <span class="keywordflow">return</span>(BCERROR);</div><div class="line">                                }</div><div class="line">                                printf(<span class="stringliteral">&quot;Bits = %d, Par = %c, Stop = %d\r\n&quot;</span>,zephyr.bits, zephyr.parity,zephyr.stop);</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;f&#39;</span>:               <span class="comment">// &#39;f&#39; option specifies serial port flow control</span></div><div class="line">                                <span class="keywordflow">if</span>(verify_flow(optarg))</div><div class="line">                                {</div><div class="line">                                        zephyr.flow = optarg[0];</div><div class="line">                                        zephyr.flow = optarg[0];</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">else</span></div><div class="line">                                {</div><div class="line">                                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid flow control setting %s\r\n&quot;</span>, MODULE_NAME, optarg);</div><div class="line">                                        <span class="keywordflow">return</span>(BCERROR);</div><div class="line">                                }</div><div class="line">                                printf(<span class="stringliteral">&quot;Flow = %c\r\n&quot;</span>,zephyr.flow);</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;?&#39;</span>:</div><div class="line">                                <span class="keywordflow">if</span> ((optopt == <span class="charliteral">&#39;f&#39;</span>) || (optopt == <span class="charliteral">&#39;p&#39;</span>) || (optopt == <span class="charliteral">&#39;s&#39;</span>) || (optopt == <span class="charliteral">&#39;b&#39;</span>) || (optopt == <span class="charliteral">&#39;l&#39;</span>))</div><div class="line">                                        fprintf (stderr, <span class="stringliteral">&quot;%s: Option -%c requires an argument.\n&quot;</span>, MODULE_NAME,optopt);</div><div class="line">                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isprint (optopt))</div><div class="line">                                        fprintf (stderr, <span class="stringliteral">&quot;%s: Unknown option `-%c&#39;.\n&quot;</span>, MODULE_NAME,optopt);</div><div class="line">                                <span class="keywordflow">else</span></div><div class="line">                                        fprintf (stderr,<span class="stringliteral">&quot;%s: Unknown option character `\\x%x&#39;.\n&quot;</span>,MODULE_NAME,optopt);</div><div class="line">                                <span class="keywordflow">return</span>(BCERROR);</div><div class="line">                        <span class="keywordflow">default</span>:</div><div class="line">                                <span class="keywordflow">return</span>(BCERROR);</div><div class="line">                }</div><div class="line">        <span class="keywordflow">return</span>(BCSUCCESS);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Prints the usage summary showing valid command line options.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">void</span> Usage(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"></div><div class="line">        printf(<span class="stringliteral">&quot;Usage:\r\n zephyr [OPTIONS]\r\n\r\n&quot;</span>);</div><div class="line">        printf(<span class="stringliteral">&quot;Options:\r\n -b &lt;bit settings&gt;\tUse &lt;bit settings&gt; for the serial port (default = %s).\r\n&quot;</span>,BITS_DEFAULT);</div><div class="line">        printf(<span class="stringliteral">&quot; -f [N | H | S]\tSpecifies what type of flow control to use (N=None, H=Hardware, S=Software) (default=%c).\r\n&quot;</span>,FLOW_DEFAULT);</div><div class="line">        printf(<span class="stringliteral">&quot; -s &lt;speed&gt;\tConfigure the serial ports for &lt;speed&gt; bits per second (default = %d).\r\n&quot;</span>,BAUD_DEFAULT);</div><div class="line"><span class="comment">//      printf(&quot; -l &lt;length&gt;\tCreate data files of length &lt;length&gt; seconds (default = %d).\r\n&quot;,FILE_LEN_DEFAULT);</span></div><div class="line">        printf(<span class="stringliteral">&quot; -v\tVerbose mode.\r\n&quot;</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Reads the program configuration file</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// This function opens the module&#39;s configuration file (whose path is defined in the</span></div><div class="line"><span class="comment">/// pathCfgRoc global) and reads the contents. The currently supported settings that can</span></div><div class="line"><span class="comment">/// be placed in the config file are:</span></div><div class="line"><span class="comment">/// - (Optional) Port number to use for incoming socket connections (socket_in)</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// \param cfg Pointer to config_t object for storing state of config file operations.</span></div><div class="line"><span class="comment">/// \param path String containing full path of the config file to read.</span></div><div class="line"><span class="comment">/// \return</span></div><div class="line"><span class="comment">/// - BCSUCCESS if successful</span></div><div class="line"><span class="comment">/// - BCCONFIGREADERROR indicates an error reading the configuration file</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">int</span> LoadConfigFileSettings(config_t *cfg, <span class="keyword">const</span> <span class="keywordtype">char</span> *path)</div><div class="line">{</div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *str;</div><div class="line">        <span class="keywordtype">int</span> count, i;</div><div class="line"></div><div class="line">        config_init(cfg);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(config_read_file(cfg, path) == CONFIG_FALSE)</div><div class="line">        {</div><div class="line">                fprintf(stderr,<span class="stringliteral">&quot;%s: Error %s in config file %s, line %d\r\n&quot;</span>,MODULE_NAME, config_error_text(cfg),config_error_file(cfg),config_error_line(cfg));</div><div class="line">                config_destroy(cfg);</div><div class="line">                <span class="keywordflow">return</span>(BCCONFIGREADERROR);</div><div class="line">        }</div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;data_dir&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(setting);</div><div class="line">                <span class="keywordflow">if</span>(str != NULL)</div><div class="line">                {</div><div class="line">                        data_dir = malloc(strlen(str)+1);</div><div class="line">                        strcpy(data_dir, str);</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Data logged in %s.\r\n&quot;</span>,MODULE_NAME, data_dir);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid directory name %s in config file. Using default location %s\r\n&quot;</span>,MODULE_NAME, str, DIR_DEFAULT);</div><div class="line">                        data_dir = DIR_DEFAULT;</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                data_dir = DIR_DEFAULT;</div><div class="line">        }</div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;zeph_port&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(setting);</div><div class="line">                <span class="keywordflow">if</span>(str != NULL)</div><div class="line">                {</div><div class="line">                        zephyr.port = malloc(strlen(str)+1);</div><div class="line">                        strcpy(zephyr.port, str);</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: GPS commands on %s.\r\n&quot;</span>,MODULE_NAME, zephyr.port);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid device name %s in config file.\r\n&quot;</span>,MODULE_NAME, str);</div><div class="line">                        zephyr.port = NULL;</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                zephyr.port = NULL;</div><div class="line">        }</div><div class="line"></div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;zeph_speed&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                zephyr.speed = get_baud(config_setting_get_int(setting));</div><div class="line">                <span class="keywordflow">if</span>(zephyr.speed == BCERROR)</div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid baud rate %d in config file %s. Using default vaule %d.\r\n&quot;</span>,MODULE_NAME, zephyr.speed, path, BAUD_DEFAULT);</div><div class="line">                        zephyr.speed = BAUD_DEFAULT;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Using baud rate %d for serial port %s from config file %s.\r\n&quot;</span>,MODULE_NAME, zephyr.speed, zephyr.port, path);</div><div class="line">                }</div><div class="line">        } </div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                zephyr.speed = BAUD_DEFAULT;</div><div class="line">        }</div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;bits&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(setting);</div><div class="line">                <span class="keywordflow">if</span>(verify_bits(str))</div><div class="line">                {</div><div class="line">                        zephyr.bits = str[0]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                        zephyr.parity = str[1];</div><div class="line">                        zephyr.stop = str[2]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Using serial bit settings %s.\r\n&quot;</span>,MODULE_NAME, str);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid bits setting %s in config file. Using default value %s\r\n&quot;</span>, MODULE_NAME, str, BITS_DEFAULT);</div><div class="line">                        zephyr.bits = 8;</div><div class="line">                        zephyr.parity = <span class="charliteral">&#39;N&#39;</span>;</div><div class="line">                        zephyr.stop = 1;</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                        zephyr.bits = 8;</div><div class="line">                        zephyr.parity = <span class="charliteral">&#39;N&#39;</span>;</div><div class="line">                        zephyr.stop = 1;</div><div class="line">        }</div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;flow&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(setting);</div><div class="line">                <span class="keywordflow">if</span>(verify_flow(str))</div><div class="line">                {</div><div class="line">                        zephyr.flow = str[0];</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Using %c flow control.\r\n&quot;</span>,MODULE_NAME, zephyr.flow);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid flow control setting %c in config file. Using default value %s\r\n&quot;</span>, MODULE_NAME, str[0], FLOW_DEFAULT);</div><div class="line">                        zephyr.flow = FLOW_DEFAULT;</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                        zephyr.flow = FLOW_DEFAULT;</div><div class="line">        }</div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;terminator&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(setting);</div><div class="line">                <span class="keywordflow">if</span>(str != NULL)</div><div class="line">                {</div><div class="line">                        strcpy(zephyr.term, str);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid line terminator specified. Using default value\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        strcpy(zephyr.term, TERM_DEFAULT);</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                strcpy(zephyr.term, TERM_DEFAULT);</div><div class="line">        }</div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;lp_mode&quot;</span>);</div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;hwversion&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                hwversion = config_setting_get_int(setting);</div><div class="line">                printf(<span class="stringliteral">&quot;%s: Interface board version %d.\r\n&quot;</span>,MODULE_NAME, hwversion);</div><div class="line">        } </div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                hwversion = HWVERSION_DEFAULT;</div><div class="line">                printf(<span class="stringliteral">&quot;%s: No interface board version number found. Using default %d.\r\n&quot;</span>,MODULE_NAME, hwversion);</div><div class="line">        }</div><div class="line">        </div><div class="line">        config_destroy(cfg);</div><div class="line">        <span class="keywordflow">return</span>(BCSUCCESS);</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> SerialPortInit(serial port)</div><div class="line">{</div><div class="line">        <span class="keyword">struct </span>termios options;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Opening port %s\r\n&quot;</span>, MODULE_NAME, port.port);</div><div class="line">        port.fp = open(port.port, O_RDWR | O_NOCTTY | O_NDELAY);        <span class="comment">// Open serial port</span></div><div class="line">        <span class="keywordflow">if</span>(port.fp == BCERROR)</div><div class="line">                <span class="keywordflow">return</span>(BCSEROPENERROR);</div><div class="line"></div><div class="line">        tcgetattr(port.fp, &amp;options);                                           <span class="comment">// Get current port options</span></div><div class="line"></div><div class="line">        cfsetispeed(&amp;options, port.speed);                              <span class="comment">// Set input baud rate</span></div><div class="line">        cfsetospeed(&amp;options, port.speed);                              <span class="comment">// Set output baud rate</span></div><div class="line"></div><div class="line">        options.c_cflag &amp;= ~CSIZE;                                                      <span class="comment">// Clear data bit fields</span></div><div class="line">        <span class="keywordflow">switch</span>(port.bits)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> 7:</div><div class="line">                        options.c_cflag |= CS7;                                         <span class="comment">// Select 7 data bits</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> 8:</div><div class="line">                        options.c_cflag |= CS8;                                         <span class="comment">// Select 8 data bits</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">return</span>(BCINVALIDBITS);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span>(port.parity)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;N&#39;</span>:</div><div class="line">                        options.c_cflag &amp;= ~PARENB;                                     <span class="comment">// Clear parity enable bit</span></div><div class="line">                        options.c_iflag &amp;= ~INPCK;                                      <span class="comment">// Disable parity checking of incoming data</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;O&#39;</span>:</div><div class="line">                        options.c_cflag |= PARENB;                                      <span class="comment">// Set parity enable bit</span></div><div class="line">                        options.c_cflag |= PARODD;                                      <span class="comment">// Set odd parity bit</span></div><div class="line">                        options.c_iflag |= (INPCK | ISTRIP);            <span class="comment">// Enable parity checking of incoming data</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;E&#39;</span>:</div><div class="line">                        options.c_cflag |= PARENB;                                      <span class="comment">// Set parity enable bit</span></div><div class="line">                        options.c_cflag &amp;= ~PARODD;                                     <span class="comment">// Clear odd parity bit (which means use even parity)</span></div><div class="line">                        options.c_iflag |= (INPCK | ISTRIP);            <span class="comment">// Enable parity checking of incoming data</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">return</span>(BCINVALIDPAR);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span>(port.stop)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> 1:</div><div class="line">                        options.c_cflag &amp;= ~CSTOPB;                                     <span class="comment">// Clear stop bits bit (which means use 1 stop bit)</span></div><div class="line">                        <span class="keywordflow">break</span>;                  </div><div class="line">                <span class="keywordflow">case</span> 2:</div><div class="line">                        options.c_cflag |= CSTOPB;                                      <span class="comment">// Set stop bits bit (which means use 2 stop bits)</span></div><div class="line">                        <span class="keywordflow">break</span>;                  </div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">return</span>(BCINVALIDSTOP);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span>(port.flow)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;N&#39;</span>:</div><div class="line">                        options.c_cflag &amp;= ~CRTSCTS;                            <span class="comment">// Disable hardware flow control</span></div><div class="line">                        options.c_iflag &amp;= ~(IXON | IXOFF | IXANY);     <span class="comment">// Disable software flow control</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;H&#39;</span>:</div><div class="line">                        options.c_cflag |= CRTSCTS;                                     <span class="comment">// Enable hardware flow control</span></div><div class="line">                        options.c_iflag &amp;= ~(IXON | IXOFF | IXANY);     <span class="comment">// Disable software flow control</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;S&#39;</span>:</div><div class="line">                        options.c_cflag &amp;= ~CRTSCTS;                            <span class="comment">// Disable hardware flow control</span></div><div class="line">                        options.c_iflag |= (IXON | IXOFF | IXANY);      <span class="comment">// Enable software flow control</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">return</span>(BCINVALIDFLOW);</div><div class="line">        }</div><div class="line"></div><div class="line">        options.c_iflag &amp;= ~ICRNL;                                                      <span class="comment">// disable mapping of CR to NL</span></div><div class="line">        options.c_lflag &amp;= ~(ICANON | ECHO | ECHOE | ECHOK | ECHONL | ECHOCTL | ECHOPRT | ECHOKE | ISIG);       <span class="comment">// Turn off line read (canonical) mode and character echoes</span></div><div class="line">        options.c_cflag |= CLOCAL;                                                      <span class="comment">// Set local mode</span></div><div class="line"><span class="comment">//      options.c_cflag &amp;= ~CREAD;                                                      // Disable the receiver for now</span></div><div class="line">        options.c_cflag |= CREAD;                                                       <span class="comment">// Enable the receiver</span></div><div class="line">        options.c_oflag &amp;= ~OPOST;                                                      <span class="comment">// Disable all processed output settings</span></div><div class="line">        options.c_cc[VMIN] = 0;                                                         <span class="comment">// Forces the read() function to return immediately with however many characters are available</span></div><div class="line">        options.c_cc[VTIME] = 0;                                                        <span class="comment">// Tells the read() function not to wait for any data</span></div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(tcsetattr(port.fp, TCSANOW, &amp;options) == 0)  <span class="comment">// Make the new settings active</span></div><div class="line">        {</div><div class="line"><span class="comment">//              sleep(2);</span></div><div class="line">                tcflush(port.fp,TCIOFLUSH);</div><div class="line">                <span class="keywordflow">return</span>(BCSUCCESS);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">                <span class="keywordflow">return</span>(BCSETATTRERROR);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> get_baud(<span class="keywordtype">int</span> baud)</div><div class="line">{</div><div class="line">        <span class="keywordflow">switch</span> (baud) {</div><div class="line">        <span class="keywordflow">case</span> 300:</div><div class="line">                <span class="keywordflow">return</span> B300;</div><div class="line">        <span class="keywordflow">case</span> 600:</div><div class="line">                <span class="keywordflow">return</span> B600;</div><div class="line">        <span class="keywordflow">case</span> 1200:</div><div class="line">                <span class="keywordflow">return</span> B1200;</div><div class="line">        <span class="keywordflow">case</span> 2400:</div><div class="line">                <span class="keywordflow">return</span> B2400;</div><div class="line">        <span class="keywordflow">case</span> 4800:</div><div class="line">                <span class="keywordflow">return</span> B4800;</div><div class="line">        <span class="keywordflow">case</span> 9600:</div><div class="line">                <span class="keywordflow">return</span> B9600;</div><div class="line">        <span class="keywordflow">case</span> 19200:</div><div class="line">                <span class="keywordflow">return</span> B19200;</div><div class="line">        <span class="keywordflow">case</span> 38400:</div><div class="line">                <span class="keywordflow">return</span> B38400;</div><div class="line">        <span class="keywordflow">case</span> 57600:</div><div class="line">                <span class="keywordflow">return</span> B57600;</div><div class="line">        <span class="keywordflow">case</span> 115200:</div><div class="line">                <span class="keywordflow">return</span> B115200;</div><div class="line">        <span class="keywordflow">case</span> 230400:</div><div class="line">                <span class="keywordflow">return</span> B230400;</div><div class="line">        <span class="keywordflow">case</span> 460800:</div><div class="line">                <span class="keywordflow">return</span> B460800;</div><div class="line">        <span class="keywordflow">case</span> 500000:</div><div class="line">                <span class="keywordflow">return</span> B500000;</div><div class="line">        <span class="keywordflow">case</span> 576000:</div><div class="line">                <span class="keywordflow">return</span> B576000;</div><div class="line">        <span class="keywordflow">case</span> 921600:</div><div class="line">                <span class="keywordflow">return</span> B921600;</div><div class="line">        <span class="keywordflow">case</span> 1000000:</div><div class="line">                <span class="keywordflow">return</span> B1000000;</div><div class="line">        <span class="keywordflow">case</span> 1152000:</div><div class="line">                <span class="keywordflow">return</span> B1152000;</div><div class="line">        <span class="keywordflow">case</span> 1500000:</div><div class="line">                <span class="keywordflow">return</span> B1500000;</div><div class="line">        <span class="keywordflow">case</span> 2000000:</div><div class="line">                <span class="keywordflow">return</span> B2000000;</div><div class="line">        <span class="keywordflow">case</span> 2500000:</div><div class="line">                <span class="keywordflow">return</span> B2500000;</div><div class="line">        <span class="keywordflow">case</span> 3000000:</div><div class="line">                <span class="keywordflow">return</span> B3000000;</div><div class="line">        <span class="keywordflow">case</span> 3500000:</div><div class="line">                <span class="keywordflow">return</span> B3500000;</div><div class="line">        <span class="keywordflow">case</span> 4000000:</div><div class="line">                <span class="keywordflow">return</span> B4000000;</div><div class="line">        <span class="keywordflow">default</span>: </div><div class="line">                <span class="keywordflow">return</span> BCERROR;</div><div class="line">        }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> verify_bits(<span class="keyword">const</span> <span class="keywordtype">char</span> *bits)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span>(((bits[0]==<span class="charliteral">&#39;7&#39;</span>) || (bits[0]==<span class="charliteral">&#39;8&#39;</span>)) &amp;&amp; ((toupper(bits[1])==<span class="charliteral">&#39;N&#39;</span>) || (toupper(bits[1])==<span class="charliteral">&#39;O&#39;</span>) || (toupper(bits[1])==<span class="charliteral">&#39;E&#39;</span>)) &amp;&amp; ((bits[2]==<span class="charliteral">&#39;1&#39;</span>) || (bits[2]==<span class="charliteral">&#39;2&#39;</span>)))</div><div class="line">                <span class="keywordflow">return</span>(TRUE);</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">                <span class="keywordflow">return</span>(FALSE);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> verify_flow(<span class="keyword">const</span> <span class="keywordtype">char</span> *bits)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span>((toupper(bits[0])==<span class="charliteral">&#39;N&#39;</span>) || (toupper(bits[0])==<span class="charliteral">&#39;H&#39;</span>) || (toupper(bits[0])==<span class="charliteral">&#39;S&#39;</span>))</div><div class="line">                <span class="keywordflow">return</span>(TRUE);</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">                <span class="keywordflow">return</span>(FALSE);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">char</span> *TodaysDirectoryName(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        time_t epoch;</div><div class="line">        <span class="keyword">struct </span>tm *now;</div><div class="line">        <span class="keyword">struct </span>timespec ts;</div><div class="line">        <span class="keywordtype">char</span> *rootname, *fullpath;</div><div class="line"></div><div class="line">        epoch = time(NULL);</div><div class="line"><span class="comment">//      epoch = ts.tv_sec;</span></div><div class="line">        now = gmtime(&amp;epoch);</div><div class="line">        sprintf(todaysDirectoryName,<span class="stringliteral">&quot;%04d%02d%02d&quot;</span>, (now-&gt;tm_year)+1900, (now-&gt;tm_mon)+1, now-&gt;tm_mday);</div><div class="line">        <span class="keywordflow">return</span>(todaysDirectoryName);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">char</span> *TodaysDirectoryPath(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> len;</div><div class="line">        <span class="keywordtype">char</span> *dirname, *fullpath;</div><div class="line"></div><div class="line">        dirname = TodaysDirectoryName();</div><div class="line"></div><div class="line">        fullpath = &amp;todaysDirectoryPath[0];</div><div class="line">        len = strlen(data_dir);</div><div class="line">        strcpy(fullpath, data_dir);</div><div class="line">        strcpy(fullpath + len, <span class="stringliteral">&quot;/&quot;</span>);</div><div class="line">        strcpy(fullpath + len + 1, dirname);</div><div class="line">        strcpy(fullpath + len + 1 + strlen(dirname), <span class="stringliteral">&quot;/&quot;</span>);</div><div class="line">        fullpath[len + strlen(dirname) + 2] = 0;        <span class="comment">// Null term</span></div><div class="line">        <span class="keywordflow">return</span>(fullpath);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> TodaysDirectoryExists(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i, found;</div><div class="line">        DIR *dir;</div><div class="line"></div><div class="line">        found = TRUE;</div><div class="line"></div><div class="line">        dir = opendir(TodaysDirectoryPath());</div><div class="line">        <span class="keywordflow">if</span>(!dir)</div><div class="line">                <span class="keywordflow">if</span>(ENOENT == errno)             <span class="comment">// Directory not found</span></div><div class="line">                {</div><div class="line">                        found = FALSE;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span>                                    <span class="comment">// Some other error occurred</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">return</span>(BCFILEOPENERROR);</div><div class="line">                }</div><div class="line">                        </div><div class="line">        <span class="keywordflow">if</span>(verbose)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(found) printf(<span class="stringliteral">&quot;%s: Found %s\r\n&quot;</span>, MODULE_NAME, TodaysDirectoryName());</div><div class="line">                <span class="keywordflow">else</span> printf(<span class="stringliteral">&quot;%s: Did not find %s\r\n&quot;</span>, MODULE_NAME, TodaysDirectoryName());</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span>(found);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> CreateDayDirectory(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i, ret;</div><div class="line"></div><div class="line">        ret = mkdir(TodaysDirectoryPath(), 0777);</div><div class="line">        <span class="keywordflow">if</span>(ret)</div><div class="line">                <span class="keywordflow">if</span>(errno != EEXIST)             <span class="comment">// Existing directories not an error, anything else is</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">return</span>(errno);</div><div class="line">                }</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>(BCSUCCESS);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">char</span> *LogFileName(<span class="keywordtype">char</span> *name)</div><div class="line">{</div><div class="line">        time_t epoch;</div><div class="line">        <span class="keyword">struct </span>tm *now;</div><div class="line">        <span class="keywordtype">char</span> *rootname, *fullpath;</div><div class="line">        <span class="keyword">struct </span>timespec ts;</div><div class="line"></div><div class="line">        <span class="keywordtype">char</span> *filename = malloc(14 + 1 + strlen(name) + 4 + 1); <span class="comment">// format is YYYYMMDDhhmmss_name.txt</span></div><div class="line">        <span class="keywordflow">if</span>(filename == NULL)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">return</span>(NULL);</div><div class="line">        }</div><div class="line"></div><div class="line">        epoch = time(NULL);</div><div class="line"><span class="comment">//      epoch = ts.tv_sec;</span></div><div class="line">        now = gmtime(&amp;epoch);</div><div class="line">        sprintf(filename,<span class="stringliteral">&quot;%s_%04d%02d%02d%02d%02d%02d.sbf&quot;</span>, name, (now-&gt;tm_year)+1900, (now-&gt;tm_mon)+1, now-&gt;tm_mday, now-&gt;tm_hour, now-&gt;tm_min, now-&gt;tm_sec);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>((rootname = TodaysDirectoryPath()) == NULL)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">return</span>(NULL);</div><div class="line">        }</div><div class="line"></div><div class="line">        fullpath = &amp;logFileName[0];</div><div class="line">        strcpy(fullpath, rootname);</div><div class="line"><span class="comment">//      strcpy(fullpath + strlen(rootname), &quot;/&quot;);</span></div><div class="line">        strcpy(fullpath + strlen(rootname), filename);</div><div class="line">        fullpath[strlen(rootname) + strlen(filename)] = 0;</div><div class="line"></div><div class="line">        free (filename);</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>(fullpath);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> OpenLogFile(<span class="keywordtype">char</span> *name)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i, index, ret;</div><div class="line">        <span class="keywordtype">char</span> *strName;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(!TodaysDirectoryExists())</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(CreateDayDirectory()) <span class="keywordflow">return</span>(BCFILEERROR);</div><div class="line">        }</div><div class="line"></div><div class="line">        ret = BCSUCCESS;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>((strName = LogFileName(name)) == NULL)</div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Error generating log file name.\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                <span class="keywordflow">return</span>(BCFILEERROR);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>((fp = fopen(strName, <span class="stringliteral">&quot;a+&quot;</span>)) == NULL)</div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Error Opening log file %s.\r\n&quot;</span>, MODULE_NAME, strName);</div><div class="line">                ret = BCFILEOPENERROR;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(verbose) </div><div class="line">                {</div><div class="line">                        printf(<span class="stringliteral">&quot;%s: Opened log file %s.\r\n&quot;</span>, MODULE_NAME, strName);</div><div class="line">                        fflush(stdout);</div><div class="line">                }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>(ret);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> CloseLogFile(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i, index, err, ret;</div><div class="line"></div><div class="line">        ret = BCSUCCESS;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(err = fclose(fp))</div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Error closing log file.\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                ret = BCFILEERROR;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(ret == BCSUCCESS)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Closed log files.\r\n&quot;</span>, MODULE_NAME);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>(ret);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> NewFile(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        CloseLogFile();</div><div class="line">        OpenLogFile(MODULE_NAME);</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>(BCSUCCESS);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> LogData(FILE *fp, <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> n)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> ret;</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(fp==NULL)</div><div class="line">        {</div><div class="line">                fprintf(stderr,<span class="stringliteral">&quot;%s: Error. Invalid log file stream\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                <span class="keywordflow">return</span>(BCFILEERROR);</div><div class="line">        }</div><div class="line">        ret = fwrite(data, 1, n, fp);</div><div class="line">        fflush(fp);</div><div class="line">        <span class="keywordflow">return</span>(ret);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">char</span> *GetNextFile(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        DIR *dir;</div><div class="line">        <span class="keyword">struct </span>dirent *entry, *lastentry;</div><div class="line">        <span class="keywordtype">int</span> found;</div><div class="line">        <span class="keywordtype">char</span> *fullPath;</div><div class="line">        </div><div class="line">        found = FALSE;</div><div class="line">        dir = opendir(queueDir);</div><div class="line">        <span class="keywordflow">if</span>(dir != NULL)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">while</span>((!found) &amp;&amp; (entry = readdir(dir)))</div><div class="line">                {</div><div class="line">                        <span class="keywordflow">if</span>(strcmp(entry-&gt;d_name,<span class="stringliteral">&quot;list.txt&quot;</span>)==0)</div><div class="line">                                {</div><div class="line">                                found = TRUE;</div><div class="line">                                }</div><div class="line">                }</div><div class="line">                closedir(dir);</div><div class="line">                <span class="keywordflow">if</span> (!found) {</div><div class="line">                        dir = opendir(queueDir);</div><div class="line">                        <span class="keywordflow">while</span>((!found) &amp;&amp; (entry = readdir(dir)))</div><div class="line">                        {</div><div class="line">                                <span class="keywordflow">if</span>(entry-&gt;d_name[0] != <span class="charliteral">&#39;.&#39;</span>)</div><div class="line">                                        {</div><div class="line">                                        found = TRUE;</div><div class="line">                                        }</div><div class="line">                        }</div><div class="line">                        closedir(dir);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span>(found)</div><div class="line">                {</div><div class="line">                        <span class="keyword">struct </span>stat st;</div><div class="line"></div><div class="line">                        fullPath= &amp;getNextFile[0];</div><div class="line">                        strcpy(fullPath,queueDir);</div><div class="line">                        strcpy(fullPath+strlen(queueDir), <span class="stringliteral">&quot;/&quot;</span>);</div><div class="line">                        strcpy(fullPath+strlen(queueDir)+1, entry-&gt;d_name);</div><div class="line">                        stat(fullPath, &amp;st);</div><div class="line">                        <span class="keywordflow">if</span> (strstr(fullPath,<span class="stringliteral">&quot;list.txt&quot;</span>)==0) {</div><div class="line">                                <span class="keywordflow">if</span> (!discardFirstFile) {</div><div class="line">                                        <span class="keywordflow">if</span> (!lastPart) gotGPSChars += st.st_size;</div><div class="line">                                        <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: File Size = %d, Discard=%d\n&quot;</span>, MODULE_NAME, st.st_size, discardFirstFile);</div><div class="line">                                }</div><div class="line">                                discardFirstFile = 0;</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">return</span>(fullPath);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">return</span>(NULL);</div><div class="line">                }</div><div class="line">        }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> SendFile(<span class="keywordtype">char</span> *name)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> *buf;</div><div class="line">        <span class="keyword">struct </span>stat st;</div><div class="line">        <span class="keywordtype">int</span> err, n;</div><div class="line">        FILE *ptr;</div><div class="line"></div><div class="line">        err=stat(name, &amp;st);</div><div class="line">        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Opening file %s\r\n&quot;</span>, MODULE_NAME, name);</div><div class="line">        ptr = fopen(name, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(ptr==NULL)</div><div class="line">        {</div><div class="line">                fprintf(stderr,<span class="stringliteral">&quot;%s: Error getting file size\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                <span class="keywordflow">return</span>(BCFILEERROR);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(numParts&gt;lastPart)                                           <span class="comment">// In the middle of a file transfer</span></div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Continuing offload of %s %d/%d\r\n&quot;</span>, MODULE_NAME, name, lastPart+1, numParts);</div><div class="line">                buf=malloc(MAX_DATA);</div><div class="line">                <span class="keywordflow">if</span>(buf==NULL)</div><div class="line">                {</div><div class="line">                        fprintf(stderr,<span class="stringliteral">&quot;%s: Error allocating buffer for file read\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        <span class="keywordflow">return</span>(BCFILEERROR);</div><div class="line">                }</div><div class="line">                fseek(ptr, MAX_DATA*lastPart, SEEK_SET);        <span class="comment">// move to proper place in the data file</span></div><div class="line">                n = fread(buf, 1, MAX_DATA, ptr);</div><div class="line">                dataTm = 1;</div><div class="line">                SendMsg(TM, buf, n);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span>                                                                            <span class="comment">// Starting new transfer</span></div><div class="line">        {</div><div class="line">                numParts = (st.st_size / MAX_DATA) + 1;         <span class="comment">// calculate how many parts the file needs to be broken into</span></div><div class="line">                <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: size = %d parts = %d\r\n&quot;</span>,MODULE_NAME,st.st_size,numParts);</div><div class="line">                <span class="keywordflow">if</span>(numParts&gt;1)                                                          <span class="comment">// multipart file</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Starting offload of %s 1/%d\r\n&quot;</span>, MODULE_NAME, name, numParts);</div><div class="line">                        buf=malloc(MAX_DATA);</div><div class="line">                        <span class="keywordflow">if</span>(buf==NULL)</div><div class="line">                        {</div><div class="line">                                fprintf(stderr,<span class="stringliteral">&quot;%s: Error allocating buffer for file read\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                                <span class="keywordflow">return</span>(BCFILEERROR);</div><div class="line">                        }</div><div class="line">                        n = fread(buf, 1, MAX_DATA, ptr);</div><div class="line">                        dataTm = 1;</div><div class="line">                        SendMsg(TM, buf, n);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {                                                                                       <span class="comment">// single part file</span></div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s:  Offloading %s 1/1\r\n&quot;</span>, MODULE_NAME, name);</div><div class="line">                        buf=malloc(st.st_size);</div><div class="line">                        <span class="keywordflow">if</span>(buf==NULL)</div><div class="line">                        {</div><div class="line">                                fprintf(stderr,<span class="stringliteral">&quot;%s: Error allocating buffer for file read\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                                <span class="keywordflow">return</span>(BCFILEERROR);</div><div class="line">                        }</div><div class="line">                        n = fread(buf, 1, st.st_size, ptr);</div><div class="line">                        dataTm = 1;</div><div class="line">                        SendMsg(TM, buf, st.st_size);</div><div class="line"><span class="comment">//                      write(zephyr.fp, buf, n);</span></div><div class="line">                }</div><div class="line">        }</div><div class="line">        waitingAck=WAITFORACK;</div><div class="line"><span class="comment">//      ackTimeout=time(NULL) + 5;</span></div><div class="line">        fclose(ptr);</div><div class="line">        <span class="keywordflow">if</span> (buf) free(buf);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> TCSendFile(<span class="keywordtype">char</span> *name)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> *buf;</div><div class="line">        <span class="keyword">struct </span>stat st;</div><div class="line">        <span class="keywordtype">int</span> err, n;</div><div class="line">        FILE *ptr;</div><div class="line"></div><div class="line">        err=stat(name, &amp;st);</div><div class="line">        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Opening file %s\r\n&quot;</span>, MODULE_NAME, name);</div><div class="line">        ptr = fopen(name, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(ptr==NULL)</div><div class="line">        {</div><div class="line">                fprintf(stderr,<span class="stringliteral">&quot;%s: Error getting file size\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                <span class="keywordflow">return</span>(BCFILEERROR);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(TCnumParts&gt;TClastPart)                                               <span class="comment">// In the middle of a file transfer</span></div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Continuing offload of %s %d/%d\r\n&quot;</span>, MODULE_NAME, name, TClastPart+1, TCnumParts);</div><div class="line">                buf=malloc(MAX_DATA);</div><div class="line">                <span class="keywordflow">if</span>(buf==NULL)</div><div class="line">                {</div><div class="line">                        fprintf(stderr,<span class="stringliteral">&quot;%s: Error allocating buffer for file read\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        <span class="keywordflow">return</span>(BCFILEERROR);</div><div class="line">                }</div><div class="line">                fseek(ptr, MAX_DATA*TClastPart, SEEK_SET);      <span class="comment">// move to proper place in the data file</span></div><div class="line">                n = fread(buf, 1, MAX_DATA, ptr);</div><div class="line">                dataTm = 1;</div><div class="line">                SendMsg(TM, buf, n);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span>                                                                            <span class="comment">// Starting new transfer</span></div><div class="line">        {</div><div class="line">                TCnumParts = (st.st_size / MAX_DATA) + 1;               <span class="comment">// calculate how many parts the file needs to be broken into</span></div><div class="line">                <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;%s: size = %d parts = %d\r\n&quot;</span>,MODULE_NAME,st.st_size,TCnumParts);</div><div class="line">                <span class="keywordflow">if</span>(TCnumParts&gt;1)                                                                <span class="comment">// multipart file</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Starting offload of %s 1/%d\r\n&quot;</span>, MODULE_NAME, name, TCnumParts);</div><div class="line">                        buf=malloc(MAX_DATA);</div><div class="line">                        <span class="keywordflow">if</span>(buf==NULL)</div><div class="line">                        {</div><div class="line">                                fprintf(stderr,<span class="stringliteral">&quot;%s: Error allocating buffer for file read\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                                <span class="keywordflow">return</span>(BCFILEERROR);</div><div class="line">                        }</div><div class="line">                        n = fread(buf, 1, MAX_DATA, ptr);</div><div class="line">                        dataTm = 1;</div><div class="line">                        SendMsg(TM, buf, n);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {                                                                                       <span class="comment">// single part file</span></div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s:  Offloading %s 1/1\r\n&quot;</span>, MODULE_NAME, name);</div><div class="line">                        buf=malloc(st.st_size);</div><div class="line">                        <span class="keywordflow">if</span>(buf==NULL)</div><div class="line">                        {</div><div class="line">                                fprintf(stderr,<span class="stringliteral">&quot;%s: Error allocating buffer for file read\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                                <span class="keywordflow">return</span>(BCFILEERROR);</div><div class="line">                        }</div><div class="line">                        n = fread(buf, 1, st.st_size, ptr);</div><div class="line">                        dataTm = 1;</div><div class="line">                        SendMsg(TM, buf, st.st_size);</div><div class="line"><span class="comment">//                      write(zephyr.fp, buf, n);</span></div><div class="line">                }</div><div class="line">        }</div><div class="line">        waitingAck=WAITFORACK;</div><div class="line"><span class="comment">//      ackTimeout=time(NULL) + 5;</span></div><div class="line">        fclose(ptr);</div><div class="line">        <span class="keywordflow">if</span> (buf) free(buf);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> RemoveFile(<span class="keywordtype">char</span> *name)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span> (strstr(name,<span class="stringliteral">&quot;list.txt&quot;</span>)) {  </div><div class="line">                TClastPart=0;</div><div class="line">                TCnumParts=0;</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">                lastPart=0;</div><div class="line">                numParts=0;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span>(<span class="keyword">remove</span>(name));</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> SendMsg(<span class="keyword">enum</span> msg msgtype, <span class="keywordtype">char</span> *payload, <span class="keywordtype">int</span> payload_size)</div><div class="line">{</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> cs;</div><div class="line">        <span class="keywordtype">int</span> ptr;</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> byte;</div><div class="line">        <span class="keyword">struct </span>timespec curTime;</div><div class="line">        <span class="keywordtype">char</span> hdr_msg[128];</div><div class="line">        <span class="keywordtype">size_t</span>  wrote;</div><div class="line">        </div><div class="line">        clock_gettime(CLOCK_REALTIME, &amp;curTime);</div><div class="line">        <span class="keywordflow">while</span>((curTime.tv_sec &lt; nextMsgTime.tv_sec) || ((curTime.tv_sec == nextMsgTime.tv_sec) &amp;&amp; (curTime.tv_nsec &lt; nextMsgTime.tv_nsec)))     <span class="comment">// Wait until it&#39;s ok to send next msg</span></div><div class="line">        {</div><div class="line">                clock_gettime(CLOCK_REALTIME, &amp;curTime);</div><div class="line">                usleep(50000);          <span class="comment">// sleep for 50ms</span></div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Sending message at time %ld.%03ld\r\n&quot;</span>, MODULE_NAME, curTime.tv_sec, curTime.tv_nsec/1000000);</div><div class="line">        <span class="keywordflow">switch</span>(msgtype)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> IMR:                       <span class="comment">///&lt; Tells Zephyr we&#39;re done booting and ready for mode change</span></div><div class="line"><span class="comment"></span>                        sprintf(outBuf,<span class="stringliteral">&quot;&lt;IMR&gt;\n\t&lt;Msg&gt;%d&lt;/Msg&gt;\n\t&lt;Inst&gt;%s&lt;/Inst&gt;\n\t&lt;SWDate&gt;%s&lt;/SWDate&gt;\n\t&lt;SWVersion&gt;%s&lt;/SWVersion&gt;\n\t&lt;ZProtocolVersion&gt;%s&lt;/ZProtocolVersion&gt;\n&lt;/IMR&gt;\n&quot;</span>,MsgID,INSTID,SWDate,SWVersion,ZephVersion);</div><div class="line">                        crc_calc=ComputeCRC(outBuf,strlen(outBuf));</div><div class="line">                        sprintf(outBuf+strlen(outBuf),<span class="stringliteral">&quot;&lt;CRC&gt;%d&lt;/CRC&gt;\n&quot;</span>,crc_calc);</div><div class="line">                        <span class="keywordflow">if</span> (verbose) printf(outBuf);</div><div class="line">                        write(zephyr.fp, outBuf, strlen(outBuf));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> IMAck:                     <span class="comment">///&lt; Tells Zephyr we got the mode change command</span></div><div class="line"><span class="comment"></span>                        sprintf(outBuf,<span class="stringliteral">&quot;&lt;IMAck&gt;\n\t&lt;Msg&gt;%d&lt;/Msg&gt;\n\t&lt;Inst&gt;%s&lt;/Inst&gt;\n\t&lt;Ack&gt;%s&lt;/Ack&gt;\n&lt;/IMAck&gt;\n&quot;</span>,MsgID,INSTID,<span class="stringliteral">&quot;ACK&quot;</span>);          <span class="comment">///&lt; always sending ACK for now, change later</span></div><div class="line"><span class="comment"></span>                        crc_calc=ComputeCRC(outBuf,strlen(outBuf));</div><div class="line">                        sprintf(outBuf+strlen(outBuf),<span class="stringliteral">&quot;&lt;CRC&gt;%d&lt;/CRC&gt;\n&quot;</span>,crc_calc);</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(outBuf);</div><div class="line">                        write(zephyr.fp, outBuf, strlen(outBuf));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> S:                         <span class="comment">///&lt; Tells Zephyr we&#39;re in Safety mode now, ok to shut off power</span></div><div class="line"><span class="comment"></span>                        sprintf(outBuf,<span class="stringliteral">&quot;&lt;S&gt;\n\t&lt;Msg&gt;%d&lt;/Msg&gt;\n\t&lt;Inst&gt;%s&lt;/Inst&gt;\n&lt;/S&gt;\n&quot;</span>,MsgID,INSTID);         </div><div class="line">                        crc_calc=ComputeCRC(outBuf,strlen(outBuf));</div><div class="line">                        sprintf(outBuf+strlen(outBuf),<span class="stringliteral">&quot;&lt;CRC&gt;%d&lt;/CRC&gt;\n&quot;</span>,crc_calc);</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(outBuf);</div><div class="line">                        write(zephyr.fp, outBuf, strlen(outBuf));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> TM:                        <span class="comment">///&lt; Telemetry message. This is how we send data to Zephyr</span></div><div class="line"><span class="comment"></span>                        <span class="keywordflow">if</span> (TCflag) {</div><div class="line">                                sprintf(hdr_msg, <span class="stringliteral">&quot;%s,%d,%d&quot;</span>,TCfileOffload,TClastPart,TCnumParts);</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dataTm)         <span class="comment">// This message contains a data payload</span></div><div class="line">                        {</div><div class="line">                                sprintf(hdr_msg, <span class="stringliteral">&quot;%s,%d,%d&quot;</span>,fileOffload,lastPart,numParts);</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">else</span>                    <span class="comment">// This is just a housekeeping message, no data payload</span></div><div class="line">                        {</div><div class="line">                                sprintf(hdr_msg,<span class="stringliteral">&quot;000&quot;</span>);         <span class="comment">// This should eventually contain # satellites tracked</span></div><div class="line">                        }</div><div class="line">                        sprintf(outBuf,<span class="stringliteral">&quot;&lt;TM&gt;\n\t&lt;Msg&gt;%d&lt;/Msg&gt;\n\t&lt;Inst&gt;%s&lt;/Inst&gt;\n\t&lt;StateFlag1&gt;FINE&lt;/StateFlag1&gt;\n\t&lt;StateMess1&gt;%s&lt;/StateMess1&gt;\n\t&lt;Length&gt;%d&lt;/Length&gt;\n&lt;/TM&gt;\n&quot;</span>,MsgID,INSTID,hdr_msg,payload_size);</div><div class="line">                        crc_calc=ComputeCRC(outBuf,strlen(outBuf));</div><div class="line">                        sprintf(outBuf+strlen(outBuf),<span class="stringliteral">&quot;&lt;CRC&gt;%d&lt;/CRC&gt;\n&quot;</span>,crc_calc);</div><div class="line">                        sprintf(outBuf+strlen(outBuf),<span class="stringliteral">&quot;START&quot;</span>);</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s:Payload %d bytes:&quot;</span>, outBuf, payload_size);</div><div class="line">                        ptr=strlen(outBuf);</div><div class="line">                        memcpy(outBuf+ptr,payload,payload_size);</div><div class="line">                        ptr+=payload_size;</div><div class="line">                        cs = ComputeCRC(payload,payload_size);</div><div class="line">                        byte = ((cs &amp; 0xFF00) &gt;&gt; 8) &amp; 0xFF;</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%02X&quot;</span>, byte);</div><div class="line">                        memcpy(outBuf+ptr, &amp;byte, 1);</div><div class="line">                        ptr++;</div><div class="line">                        byte = cs &amp; 0xFF;</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%02X&quot;</span>, byte);</div><div class="line">                        memcpy(outBuf+ptr, &amp;byte, 1);</div><div class="line">                        ptr++;</div><div class="line">                        sprintf(outBuf+ptr,<span class="stringliteral">&quot;END&quot;</span>);</div><div class="line">                        ptr+=3;</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;:END\n&quot;</span>);</div><div class="line">                        wrote=0;</div><div class="line"><span class="comment">//                      printf(&quot;data to write = %d\r\n&quot;, ptr);</span></div><div class="line">                        <span class="keywordflow">while</span>(ptr &gt; 0)</div><div class="line">                        {</div><div class="line">                                wrote = write(zephyr.fp, outBuf+wrote, ptr);</div><div class="line">                                ptr -= wrote;</div><div class="line"><span class="comment">//                              printf(&quot;wrote = %d  ptr = %d\r\n&quot;, wrote, ptr);</span></div><div class="line"><span class="comment">//                              usleep(300000);         // sleep for 300ms</span></div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> TCAck:                     <span class="comment">///&lt; Tells Zephyr we got the telecommand message (uplink data)</span></div><div class="line"><span class="comment"></span>                        sprintf(outBuf,<span class="stringliteral">&quot;&lt;TCAck&gt;\n\t&lt;Msg&gt;%d&lt;/Msg&gt;\n\t&lt;Inst&gt;%s&lt;/Inst&gt;\n\t&lt;Ack&gt;%s&lt;/Ack&gt;\n&lt;/TCAck&gt;\n&quot;</span>,MsgID,INSTID,<span class="stringliteral">&quot;ACK&quot;</span>);          <span class="comment">///&lt; always sending ACK for now, change later</span></div><div class="line"><span class="comment"></span>                        crc_calc=ComputeCRC(outBuf,strlen(outBuf));</div><div class="line">                        sprintf(outBuf+strlen(outBuf),<span class="stringliteral">&quot;&lt;CRC&gt;%d&lt;/CRC&gt;\n&quot;</span>,crc_calc);</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(outBuf);</div><div class="line">                        write(zephyr.fp, outBuf, strlen(outBuf));</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">        </div><div class="line">        MsgID++;</div><div class="line"><span class="comment">//      nextMsgTime = curTime;  // set earliest time for sending</span></div><div class="line">        clock_gettime(CLOCK_REALTIME, &amp;nextMsgTime);    <span class="comment">// set earliest time for sending</span></div><div class="line"><span class="comment">//      if (msgtype != TM) {</span></div><div class="line"><span class="comment">//              nextMsgTime.tv_nsec += 300000000;                                       // next message (300 msec from now)</span></div><div class="line"><span class="comment">//              if (nextMsgTime.tv_nsec &gt; 1000000000) {</span></div><div class="line"><span class="comment">//                      nextMsgTime.tv_nsec -= 1000000000;</span></div><div class="line"><span class="comment">//                      nextMsgTime.tv_sec += 1;</span></div><div class="line"><span class="comment">//              }</span></div><div class="line"><span class="comment">//      } else  nextMsgTime.tv_sec += 1;                                                // next message (1 sec from now)</span></div><div class="line">        nextMsgTime.tv_sec += 1;                                                <span class="comment">// next message (1 sec from now)</span></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> CRCComp(<span class="keywordtype">char</span>* data, <span class="keywordtype">int</span> len)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span>(ComputeCRC(data, len)==crc_msg) <span class="keywordflow">return</span>(1);</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">return</span>(0);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> CRC(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> last, <span class="keywordtype">char</span> next)</div><div class="line">{</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> x, y;</div><div class="line"></div><div class="line">        x = ((last&gt;&gt;8) ^ next) &amp; 0xff;</div><div class="line">        x ^= x&gt;&gt;4;</div><div class="line"></div><div class="line">        y = (last &lt;&lt; 8) ^ (x &lt;&lt; 12) ^ (x &lt;&lt;5) ^ x;</div><div class="line"></div><div class="line">        y &amp;= 0xffff;</div><div class="line">        <span class="keywordflow">return</span>(y);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> ComputeCRC(<span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> len)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i;</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> result;</div><div class="line"></div><div class="line">        result = 0x1021;</div><div class="line">        <span class="keywordflow">for</span>(i=0;i&lt;len;i++)</div><div class="line">        {</div><div class="line">                result=CRC(result, data[i]);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span>(result);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">enum</span> msg MsgType(<span class="keywordtype">char</span> *typestr)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span>(strncmp(typestr, <span class="stringliteral">&quot;IM&quot;</span>, 2)==0)        <span class="comment">///&lt; Got an IM message</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                <span class="keywordflow">return</span>(IM);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(typestr, <span class="stringliteral">&quot;SAck&quot;</span>, 4)==0) <span class="comment">///&lt; Got an SAck message</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                <span class="keywordflow">return</span>(SAck);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(typestr, <span class="stringliteral">&quot;SW&quot;</span>, 2)==0)   <span class="comment">///&lt; Got an SW message</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                <span class="keywordflow">return</span>(SW);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(typestr, <span class="stringliteral">&quot;TMAck&quot;</span>, 5)==0)        <span class="comment">///&lt; Got a TMAck message</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                <span class="keywordflow">return</span>(TMAck);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(typestr, <span class="stringliteral">&quot;TC&quot;</span>, 2)==0)   <span class="comment">///&lt; Got a TC message</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                <span class="keywordflow">return</span>(TC);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strncmp(typestr, <span class="stringliteral">&quot;GPS&quot;</span>, 3)==0)  <span class="comment">///&lt; Got a GPS message</span></div><div class="line"><span class="comment"></span>        {</div><div class="line">                <span class="keywordflow">return</span>(GPS);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                <span class="keywordflow">return</span>(Error);</div><div class="line">        }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**********************************</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* gps_power(), gps_reset(), gps_power_toggle(), set_safe(), led(), set_gpio0()</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* Description: These functions control the digital outputs of the TS-7680.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* Parameter: int state</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* Return value: None</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* These functions hide the active hi/lo nature of the signals so they can be</span></div><div class="line"><span class="comment">*   called as gps_power(ON), etc. without worrying about whether that&#39;s a</span></div><div class="line"><span class="comment">*   logic hi or lo. The argument to led() should be one of: GREEN, RED, ORANGE,</span></div><div class="line"><span class="comment">*   or OFF.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">************************************/</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> gps_power(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(state)</div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s gps_power 0&quot;</span>, GPIO_PATH);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s gps_power 1&quot;</span>, GPIO_PATH);</div><div class="line">        }</div><div class="line"></div><div class="line">        system(cmdstr);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> gps_reset(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(state)</div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s gps_reset 0&quot;</span>, GPIO_PATH);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s gps_reset 1&quot;</span>, GPIO_PATH);</div><div class="line">        }</div><div class="line"></div><div class="line">        system(cmdstr);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> gps_power_toggle(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(state)</div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s gps_pow_tog 0&quot;</span>, GPIO_PATH);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s gps_pow_tog 1&quot;</span>, GPIO_PATH);</div><div class="line">        }</div><div class="line"></div><div class="line">        system(cmdstr);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> set_safe(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(state)</div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s safe 1&quot;</span>, GPIO_PATH);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s safe 0&quot;</span>, GPIO_PATH);</div><div class="line">        }</div><div class="line"></div><div class="line">        system(cmdstr);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> led(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">switch</span>(state)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> RED:</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;%s led1 0&quot;</span>, GPIO_PATH);</div><div class="line">                        system(cmdstr);</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;%s led0 1&quot;</span>, GPIO_PATH);</div><div class="line">                        system(cmdstr);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> GREEN:</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;%s led0 0&quot;</span>, GPIO_PATH);</div><div class="line">                        system(cmdstr);</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;%s led1 1&quot;</span>, GPIO_PATH);</div><div class="line">                        system(cmdstr);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> ORANGE:</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;%s led0 1&quot;</span>, GPIO_PATH);</div><div class="line">                        system(cmdstr);</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;%s led1 1&quot;</span>, GPIO_PATH);</div><div class="line">                        system(cmdstr);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> OFF:</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;%s led0 0&quot;</span>, GPIO_PATH);</div><div class="line">                        system(cmdstr);</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;%s led1 0&quot;</span>, GPIO_PATH);</div><div class="line">                        system(cmdstr);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">        }               </div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> set_gpio0(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(state)</div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s gpio0 1&quot;</span>, GPIO_PATH);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;%s gpio0 0&quot;</span>, GPIO_PATH);</div><div class="line">        }</div><div class="line"></div><div class="line">        system(cmdstr);</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
