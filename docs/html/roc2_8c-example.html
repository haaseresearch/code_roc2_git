<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Strateole 2 Project: roc2.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Strateole 2 Project"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Strateole 2 Project
   </div>
   <div id="projectbrief">Scripps_Institute_of_Oceanography_@_UC_San_Diego</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,true,'search.php','Search');
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('roc2_8c-example.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">roc2.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> *      @file roc2.c</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \copyright 2017 David Jabson, Brainstorm Engineering</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// \file roc.c</span></div><div class="line"><span class="comment">/// \brief ROC2 Initial Data Collection Program</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// This program is the first version of data collection software for the ROC2 Radio</span></div><div class="line"><span class="comment">///   Occultation Instrument. It lacks the full feature set of the final instrument but</span></div><div class="line"><span class="comment">///   performs the following:</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">///   - Reads configuration file to determine commands for setting up GPS receiver</span></div><div class="line"><span class="comment">///   - Configures GPS receiver</span></div><div class="line"><span class="comment">///   - Launch data offload program</span></div><div class="line"><span class="comment">///   - Logs data received from GPS receiver to files</span></div><div class="line"><span class="comment">///   - When data file is closed, calls data processing script and open new file</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;ctype.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;libconfig.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;time.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;termios.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;fcntl.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;poll.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;dirent.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;sys/types.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;sys/stat.h&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;roc2.h&quot;</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Main function.</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// Calls RocInit() to perform initialization then enters the main while loop where it</span></div><div class="line"><span class="comment">/// .... </span></div><div class="line"><span class="comment">/// the main loop stops, then RocCleanup() is called before exiting.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> err, acked, i, numread, j;</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cmd_endptr, *cmd_readptr, *data_endptr, *data_readptr;</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> term, cmd_readbuf[READBUFSIZE*2], cmd_linebuf[READBUFSIZE/2], data_readbuf[READBUFSIZE*2];</div><div class="line">        <span class="keyword">struct </span>termios options;</div><div class="line">        <span class="keyword">struct </span>timespec curtime;</div><div class="line">        FILE *wkfp;</div><div class="line"></div><div class="line">        <span class="keyword">struct </span>pollfd fds[2];</div><div class="line"></div><div class="line">        err = RocInit(argc, argv);</div><div class="line">        <span class="keywordflow">if</span>(err&lt;0)</div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Initialization error %d. Exiting\r\n&quot;</span>,MODULE_NAME,err);</div><div class="line"><span class="comment">//              led(RED);</span></div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                printf(<span class="stringliteral">&quot;SWVersion = %s\r\nSWDate = %s\r\n&quot;</span>,SWVersion,SWDate);</div><div class="line">                printf(<span class="stringliteral">&quot;%s: Module started.\r\n&quot;</span>,MODULE_NAME);</div><div class="line"><span class="comment">//              led(GREEN);</span></div><div class="line">        }</div><div class="line"></div><div class="line">        err = GPSStartupCmds();</div><div class="line">        <span class="keywordflow">if</span>(err&lt;0)</div><div class="line">        {</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Processed %d startup commands.\r\n&quot;</span>, MODULE_NAME, err);</div><div class="line">        }</div><div class="line"></div><div class="line">        term=gps_cmd.term[strlen(gps_cmd.term)-1];</div><div class="line">        cmd_readptr=cmd_readbuf;</div><div class="line">        memset(cmd_readbuf, 0, <span class="keyword">sizeof</span>(cmd_readbuf));</div><div class="line">        data_readptr=data_readbuf;</div><div class="line">        memset(data_readbuf, 0, <span class="keyword">sizeof</span>(data_readbuf));</div><div class="line"></div><div class="line">        fds[0].fd = gps_data.fp;</div><div class="line">        fds[0].events = POLLIN;</div><div class="line">        fds[1].fd = gps_cmd.fp;</div><div class="line">        fds[1].events = POLLIN;</div><div class="line"></div><div class="line"><span class="comment">//      tcgetattr(serial.fp, &amp;options);                                         // Get current port options</span></div><div class="line"><span class="comment">//      options.c_cflag |= CREAD;                                                       // Enable the serial receiver</span></div><div class="line"><span class="comment">//      tcflush(serial.fp,TCIOFLUSH);                                           // Flush serial buffers</span></div><div class="line"><span class="comment">//      if(tcsetattr(serial.fp, TCSANOW, &amp;options) == 0)        // Make the new settings active</span></div><div class="line"></div><div class="line">    verbose = 1;</div><div class="line">        numread = 0;</div><div class="line"><span class="comment">//      fp = 0;</span></div><div class="line"></div><div class="line">        <span class="keywordflow">while</span>(!quit)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(time(NULL) &gt;= nextfile.tv_sec)</div><div class="line">                {</div><div class="line">                        nextfile.tv_sec+=file_len;</div><div class="line">                        <span class="keywordflow">if</span> (numread &amp;&amp; fp) {</div><div class="line">                                err = LogData(fp, data_readbuf, numread);</div><div class="line">                                <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Logged %d bytes, err=%d : 1\r\n&quot;</span>, MODULE_NAME, numread, err);</div><div class="line">                                numread = 0;</div><div class="line">                        }</div><div class="line">                        NewFile();</div><div class="line">                }</div><div class="line"></div><div class="line"><span class="preprocessor">#if 0</span></div><div class="line">                <span class="keywordflow">if</span> ((wkfp = fopen(<span class="stringliteral">&quot;/data/roc/FLAGWAKEUP&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>)) &gt; 0) {</div><div class="line">                        <span class="keywordtype">char</span> buf[50];</div><div class="line">                        <span class="keywordtype">int</span> saveSpeed;</div><div class="line"></div><div class="line">                        printf(<span class="stringliteral">&quot;roc: Wakeup GPS\n&quot;</span>);</div><div class="line">                        close(gps_data.fp);</div><div class="line">                        saveSpeed = gps_data.speed;</div><div class="line">                        gps_data.speed = 4800;</div><div class="line">                        err = SerialPortInit(&amp;gps_data);</div><div class="line">                        <span class="keywordflow">if</span>(err != BCSUCCESS) </div><div class="line">                                printf(<span class="stringliteral">&quot;roc: Baud rate change to 4800 unsuccessful&quot;</span>);</div><div class="line">                        </div><div class="line">                        <span class="keywordflow">for</span> (i=0;i&lt;50;i++) buf[i] = 0;</div><div class="line">                        fclose(wkfp);</div><div class="line">                        write(gps_data.fp, buf, 1);</div><div class="line">                        usleep(100000);</div><div class="line">                        write(gps_data.fp, buf, 1);</div><div class="line">                        usleep(100000);</div><div class="line">                        write(gps_data.fp, buf, 1);</div><div class="line">                        usleep(100000);</div><div class="line">                        write(gps_data.fp, buf, 1);</div><div class="line">                        usleep(100000);</div><div class="line">                        write(gps_data.fp, buf, 1);</div><div class="line">                        usleep(100000);</div><div class="line">                        write(gps_data.fp, buf, 1);</div><div class="line">                        usleep(500000);</div><div class="line">                        close(gps_data.fp);</div><div class="line">                        gps_data.speed = saveSpeed;</div><div class="line">                        err = SerialPortInit(&amp;gps_data);</div><div class="line">                        <span class="keywordflow">if</span>(err != BCSUCCESS) </div><div class="line">                                printf(<span class="stringliteral">&quot;roc: Baud rate change to %d unsuccessful&quot;</span>, saveSpeed);</div><div class="line">                        usleep(200000);</div><div class="line"></div><div class="line">                        system(<span class="stringliteral">&quot;rm /data/roc/FLAGWAKEUP&quot;</span>);</div><div class="line">                }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">                <span class="keywordflow">if</span>(poll (fds, 1, 10)) {</div><div class="line"><span class="comment">//              if ((fds [1].revents &amp; POLLIN) || ((data_readptr-1) &gt; data_endptr))</span></div><div class="line">                <span class="keywordflow">if</span> (fds [0].revents &amp; POLLIN)           <span class="comment">// incoming data on GPS data port</span></div><div class="line">                {</div><div class="line">                        err = ioctl(gps_data.fp, FIONREAD, &amp;i);</div><div class="line">                        <span class="keywordflow">if</span>(err)</div><div class="line">                        {</div><div class="line">                                fprintf(stderr,<span class="stringliteral">&quot;%s: I/O error, exiting.&quot;</span>,MODULE_NAME);</div><div class="line">                                quit=1;</div><div class="line">                        }</div><div class="line"></div><div class="line"><span class="comment">//                      if(verbose) printf(&quot;%d bytes ready to read from %s\r\n&quot;,i, gps_data.port);</span></div><div class="line">                        <span class="keywordflow">if</span>((numread + i) &gt; READBUFSIZE) <span class="comment">// Serial read will overrun buffer if we do it</span></div><div class="line">                        {</div><div class="line">                                err = LogData(fp, data_readbuf, numread);</div><div class="line">                                <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Logged %d bytes, err=%d : 2\r\n&quot;</span>, MODULE_NAME, numread, err);</div><div class="line">                                numread = 0;</div><div class="line">                        }</div><div class="line"></div><div class="line">                        numread += read(gps_data.fp, data_readbuf+numread, i);</div><div class="line"><span class="comment">//                      if(verbose) printf(&quot;Writing %d bytes\r\n&quot;, numread);</span></div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (fds [1].revents &amp; POLLIN)           <span class="comment">// incoming data on GPS command port</span></div><div class="line">                {</div><div class="line">                        ioctl(gps_cmd.fp, FIONREAD, &amp;i);</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%d bytes ready to read from %s\r\n&quot;</span>,i, gps_cmd.port);</div><div class="line">                        <span class="keywordflow">if</span>((cmd_readptr + i - cmd_readbuf) &gt; READBUFSIZE)       <span class="comment">// Serial read will overrun buffer if we do it</span></div><div class="line">                        {</div><div class="line">                                fprintf(stderr, <span class="stringliteral">&quot;Serial buffer overrun. Data lost!\r\n&quot;</span>);</div><div class="line">                                cmd_readptr=cmd_readbuf;</div><div class="line">                                memset(cmd_readbuf, 0, <span class="keyword">sizeof</span>(cmd_readbuf));</div><div class="line">                        }</div><div class="line">                        <span class="keywordflow">else</span></div><div class="line">                        {</div><div class="line">                                numread = read(gps_cmd.fp, cmd_readbuf, i);</div><div class="line"><span class="comment">//                              if(verbose) printf(&quot;Writing %d bytes\r\n&quot;, numread);</span></div><div class="line"><span class="comment">//                              if(verbose)</span></div><div class="line"><span class="comment">//                              {</span></div><div class="line"><span class="comment">//                                      for(j=0;j&lt;numread;j++)</span></div><div class="line"><span class="comment">//                                      {</span></div><div class="line"><span class="comment">//                                              printf(&quot;%02x &quot;, cmd_readbuf[j]);</span></div><div class="line"><span class="comment">//                                      }</span></div><div class="line"><span class="comment">//                                      printf(&quot;\r\n&quot;);</span></div><div class="line"><span class="comment">//                                      fflush(stdout);</span></div><div class="line"><span class="comment">//                              }</span></div><div class="line"><span class="comment">//                              err = LogData(fp, cmd_readbuf, numread);</span></div><div class="line"><span class="comment">//                              if(verbose) printf(&quot;LogData returned %d\r\n&quot;, err);</span></div><div class="line">                        }</div><div class="line">                } </div><div class="line">                }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Cleaning up\r\n&quot;</span>, MODULE_NAME);</div><div class="line">        RocCleanup();</div><div class="line">        printf(<span class="stringliteral">&quot;%s: ROC stopped.\r\n&quot;</span>,MODULE_NAME);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (gps_cmd.port) free(gps_cmd.port);</div><div class="line">        <span class="keywordflow">if</span> (gps_data.port) free(gps_data.port);</div><div class="line">        <span class="keywordflow">if</span> (data_dir) free(data_dir);</div><div class="line">        <span class="keywordflow">if</span> (curfilename) free(curfilename);</div><div class="line"></div><div class="line">        exit(BCSUCCESS);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Performs module initialization</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// Calls LoadConfigFileSettings() to load the configuration file settings for this module and calls</span></div><div class="line"><span class="comment">/// CmdLineHandler() to handle any command line options. Finally configures a ZMQ REP</span></div><div class="line"><span class="comment">/// socket to listen for messages from other modules.</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// \param argc Number of command line arguments passed to main().</span></div><div class="line"><span class="comment">/// \param argv[] List of command line arguments passed to main().</span></div><div class="line"><span class="comment">/// \return</span></div><div class="line"><span class="comment">/// - BCSUCCESS if successful.</span></div><div class="line"><span class="comment">/// - BCCONFIGREADERROR indicates an error in LoadConfigFileSettings().</span></div><div class="line"><span class="comment">/// - BCCMDLINEERROR indicates an error in CmdLineHandler().</span></div><div class="line"><span class="comment">/// - BCZMQOPTERROR indicates an error setting the options of a ZMQ socket.</span></div><div class="line"><span class="comment">/// - BCMODLISTERROR indicates an error in PopulateModules().</span></div><div class="line"><span class="comment">/// - BCZMQBINDERROR indicates an error binding the ZMQ REP socket.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">int</span> RocInit(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> err, port;</div><div class="line"></div><div class="line">        verbose = FALSE;</div><div class="line">        quit = FALSE;</div><div class="line"></div><div class="line">        fclose(stdin);</div><div class="line"></div><div class="line">        <span class="comment">// Read config file</span></div><div class="line">        <span class="keywordflow">if</span>(LoadConfigFileSettings(&amp;cfgRoc, pathCfgRoc) != BCSUCCESS)</div><div class="line">                <span class="keywordflow">return</span>(BCCONFIGREADERROR);              </div><div class="line"></div><div class="line">        <span class="comment">// Parse command line options</span></div><div class="line">        <span class="keywordflow">if</span>(CmdLineHandler(argc, argv) != BCSUCCESS)</div><div class="line">        {</div><div class="line">                Usage();</div><div class="line">                <span class="keywordflow">return</span>(BCCMDLINEERROR);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// Set up serial ports</span></div><div class="line">        err = SerialPortInit(&amp;gps_data);</div><div class="line">        <span class="keywordflow">if</span>(err != BCSUCCESS)</div><div class="line">                <span class="keywordflow">return</span>(err);</div><div class="line">        err = SerialPortInit(&amp;gps_cmd);</div><div class="line">        <span class="keywordflow">if</span>(err != BCSUCCESS)</div><div class="line">                <span class="keywordflow">return</span>(err);</div><div class="line">        </div><div class="line">        <span class="comment">// Set up data logging</span></div><div class="line">        CreateDayDirectory();</div><div class="line">        OpenLogFile(MODULE_NAME);</div><div class="line">        clock_gettime(CLOCK_REALTIME, &amp;now);    <span class="comment">// use internal clock for now. Eventually get times from data blocks</span></div><div class="line">        nextfile.tv_sec = now.tv_sec + file_len - ((now.tv_sec + file_len) % file_len);</div><div class="line">        printf(<span class="stringliteral">&quot;now = %ld  len = %d  next = %ld\r\n&quot;</span>, now.tv_sec, file_len, nextfile.tv_sec);</div><div class="line">        nextfile.tv_nsec = now.tv_nsec;</div><div class="line">        </div><div class="line">        <span class="keywordflow">return</span>(BCSUCCESS);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Closes sockets and frees memory.</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// There will be some serial port clean up stuff in here.</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// \return Always returns BCSUCCESS</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">int</span> RocCleanup(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"></div><div class="line">        close(gps_cmd.fp);</div><div class="line">        close(gps_data.fp);</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>(BCSUCCESS);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Parses command line arguments.</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// \param argc Number of command line arguments passed to main().</span></div><div class="line"><span class="comment">/// \param argv[] List of command line arguments passed to main().</span></div><div class="line"><span class="comment">/// \return</span></div><div class="line"><span class="comment">/// - BCSUCCESS if successful</span></div><div class="line"><span class="comment">/// - BCERROR if there was an error parsing any of the command line options</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">int</span> CmdLineHandler(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i;</div><div class="line"></div><div class="line">        opterr=0;</div><div class="line">        optind=0;       <span class="comment">// Reinitialize getopt()</span></div><div class="line"></div><div class="line">        <span class="keywordflow">while</span> ((i = getopt (argc, argv, cloptions)) != -1)</div><div class="line">        <span class="keywordflow">switch</span> (i)</div><div class="line">                {</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;v&#39;</span>:               <span class="comment">// &#39;v&#39; option turns on verbose mode</span></div><div class="line">                                verbose = TRUE;</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;l&#39;</span>:               <span class="comment">// &#39;l&#39; option specifies data file length</span></div><div class="line"><span class="comment">//                              file_len=get_baud(atoi(optarg));</span></div><div class="line">                                file_len=atoi(optarg);</div><div class="line">                                <span class="keywordflow">if</span>((file_len &lt; 0) || (file_len &gt; 3600))</div><div class="line">                                {</div><div class="line">                                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid file length setting %s\r\n&quot;</span>, MODULE_NAME, optarg);</div><div class="line">                                        <span class="keywordflow">return</span>(BCERROR);</div><div class="line">                                }</div><div class="line">                                printf(<span class="stringliteral">&quot;File length = %d\r\n&quot;</span>,file_len);</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:               <span class="comment">// &#39;p&#39; option specifies serial port to use</span></div><div class="line">                                free(gps_cmd.port);</div><div class="line">                                gps_cmd.port = malloc(strlen(optarg)+1);</div><div class="line">                                strcpy(gps_cmd.port, optarg);</div><div class="line">                                <span class="keywordflow">if</span>(gps_cmd.port == NULL)</div><div class="line">                                {</div><div class="line">                                        fprintf(stderr, <span class="stringliteral">&quot;%s: Error setting serial port to %s\r\n&quot;</span>,MODULE_NAME,optarg);</div><div class="line">                                        <span class="keywordflow">return</span>(BCERROR);</div><div class="line">                                }</div><div class="line">                                printf(<span class="stringliteral">&quot;Port = %s\r\n&quot;</span>,gps_cmd.port);</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:               <span class="comment">// &#39;s&#39; option specifies serial port speed</span></div><div class="line">                                gps_cmd.speed=get_baud(atoi(optarg));</div><div class="line">                                gps_data.speed=get_baud(atoi(optarg));</div><div class="line">                                <span class="keywordflow">if</span>(gps_cmd.speed == BCERROR)</div><div class="line">                                {</div><div class="line">                                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid bits setting %s\r\n&quot;</span>, MODULE_NAME, optarg);</div><div class="line">                                        <span class="keywordflow">return</span>(BCERROR);</div><div class="line">                                }</div><div class="line">                                printf(<span class="stringliteral">&quot;Speed = %d\r\n&quot;</span>,gps_cmd.speed);</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;b&#39;</span>:               <span class="comment">// &#39;b&#39; option specifies serial port bit settings</span></div><div class="line">                                <span class="keywordflow">if</span>(verify_bits(optarg))</div><div class="line">                                {</div><div class="line">                                        gps_cmd.bits = optarg[0]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                                        gps_cmd.parity = optarg[1];</div><div class="line">                                        gps_cmd.stop = optarg[2]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                                        gps_data.bits = optarg[0]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                                        gps_data.parity = optarg[1];</div><div class="line">                                        gps_data.stop = optarg[2]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">else</span></div><div class="line">                                {</div><div class="line">                                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid bits setting %s\r\n&quot;</span>, MODULE_NAME, optarg);</div><div class="line">                                        <span class="keywordflow">return</span>(BCERROR);</div><div class="line">                                }</div><div class="line">                                printf(<span class="stringliteral">&quot;Bits = %d, Par = %c, Stop = %d\r\n&quot;</span>,gps_cmd.bits, gps_cmd.parity,gps_cmd.stop);</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;f&#39;</span>:               <span class="comment">// &#39;f&#39; option specifies serial port flow control</span></div><div class="line">                                <span class="keywordflow">if</span>(verify_flow(optarg))</div><div class="line">                                {</div><div class="line">                                        gps_cmd.flow = optarg[0];</div><div class="line">                                        gps_data.flow = optarg[0];</div><div class="line">                                }</div><div class="line">                                <span class="keywordflow">else</span></div><div class="line">                                {</div><div class="line">                                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid flow control setting %s\r\n&quot;</span>, MODULE_NAME, optarg);</div><div class="line">                                        <span class="keywordflow">return</span>(BCERROR);</div><div class="line">                                }</div><div class="line">                                printf(<span class="stringliteral">&quot;Flow = %c\r\n&quot;</span>,gps_cmd.flow);</div><div class="line">                                <span class="keywordflow">break</span>;</div><div class="line">                        <span class="keywordflow">case</span> <span class="charliteral">&#39;?&#39;</span>:</div><div class="line">                                <span class="keywordflow">if</span> ((optopt == <span class="charliteral">&#39;f&#39;</span>) || (optopt == <span class="charliteral">&#39;p&#39;</span>) || (optopt == <span class="charliteral">&#39;s&#39;</span>) || (optopt == <span class="charliteral">&#39;b&#39;</span>) || (optopt == <span class="charliteral">&#39;l&#39;</span>))</div><div class="line">                                        fprintf (stderr, <span class="stringliteral">&quot;%s: Option -%c requires an argument.\n&quot;</span>, MODULE_NAME,optopt);</div><div class="line">                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isprint (optopt))</div><div class="line">                                        fprintf (stderr, <span class="stringliteral">&quot;%s: Unknown option `-%c&#39;.\n&quot;</span>, MODULE_NAME,optopt);</div><div class="line">                                <span class="keywordflow">else</span></div><div class="line">                                        fprintf (stderr,<span class="stringliteral">&quot;%s: Unknown option character `\\x%x&#39;.\n&quot;</span>,MODULE_NAME,optopt);</div><div class="line">                                <span class="keywordflow">return</span>(BCERROR);</div><div class="line">                        <span class="keywordflow">default</span>:</div><div class="line">                                <span class="keywordflow">return</span>(BCERROR);</div><div class="line">                }</div><div class="line">        <span class="keywordflow">return</span>(BCSUCCESS);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Prints the usage summary showing valid command line options.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">void</span> Usage(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"></div><div class="line">        printf(<span class="stringliteral">&quot;Usage:\r\n roc [OPTIONS]\r\n\r\n&quot;</span>);</div><div class="line">        printf(<span class="stringliteral">&quot;Options:\r\n -b &lt;bit settings&gt;\tUse &lt;bit settings&gt; for the serial port (default = %s).\r\n&quot;</span>,BITS_DEFAULT);</div><div class="line">        printf(<span class="stringliteral">&quot; -f [N | H | S]\tSpecifies what type of flow control to use (N=None, H=Hardware, S=Software) (default=%c).\r\n&quot;</span>,FLOW_DEFAULT);</div><div class="line">        printf(<span class="stringliteral">&quot; -s &lt;speed&gt;\tConfigure the serial ports for &lt;speed&gt; bits per second (default = %d).\r\n&quot;</span>,BAUD_DEFAULT);</div><div class="line">        printf(<span class="stringliteral">&quot; -l &lt;length&gt;\tCreate data files of length &lt;length&gt; seconds (default = %d).\r\n&quot;</span>,FILE_LEN_DEFAULT);</div><div class="line">        printf(<span class="stringliteral">&quot; -v\tVerbose mode.\r\n&quot;</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/// \brief Reads the program configuration file</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// This function opens the module&#39;s configuration file (whose path is defined in the</span></div><div class="line"><span class="comment">/// pathCfgRoc global) and reads the contents. The currently supported settings that can</span></div><div class="line"><span class="comment">/// be placed in the config file are:</span></div><div class="line"><span class="comment">/// - (Optional) Port number to use for incoming socket connections (socket_in)</span></div><div class="line"><span class="comment">///</span></div><div class="line"><span class="comment">/// \param cfg Pointer to config_t object for storing state of config file operations.</span></div><div class="line"><span class="comment">/// \param path String containing full path of the config file to read.</span></div><div class="line"><span class="comment">/// \return</span></div><div class="line"><span class="comment">/// - BCSUCCESS if successful</span></div><div class="line"><span class="comment">/// - BCCONFIGREADERROR indicates an error reading the configuration file</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="keywordtype">int</span> LoadConfigFileSettings(config_t *cfg, <span class="keyword">const</span> <span class="keywordtype">char</span> *path)</div><div class="line">{</div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *str;</div><div class="line">        <span class="keywordtype">int</span> count, i;</div><div class="line"></div><div class="line">        config_init(cfg);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(config_read_file(cfg, path) == CONFIG_FALSE)</div><div class="line">        {</div><div class="line">                fprintf(stderr,<span class="stringliteral">&quot;%s: Error %s in config file %s, line %d\r\n&quot;</span>,MODULE_NAME, config_error_text(cfg),config_error_file(cfg),config_error_line(cfg));</div><div class="line">                config_destroy(cfg);</div><div class="line">                <span class="keywordflow">return</span>(BCCONFIGREADERROR);</div><div class="line">        }</div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;data_dir&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(setting);</div><div class="line">                <span class="keywordflow">if</span>(str != NULL)</div><div class="line">                {</div><div class="line">                        data_dir = malloc(strlen(str)+1);</div><div class="line">                        strcpy(data_dir, str);</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Data logged in %s.\r\n&quot;</span>,MODULE_NAME, data_dir);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid directory name %s in config file. Using default location %s\r\n&quot;</span>,MODULE_NAME, str, DIR_DEFAULT);</div><div class="line">                        data_dir = DIR_DEFAULT;</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                data_dir = DIR_DEFAULT;</div><div class="line">        }</div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;gps_cmd_port&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(setting);</div><div class="line">                <span class="keywordflow">if</span>(str != NULL)</div><div class="line">                {</div><div class="line">                        gps_cmd.port = malloc(strlen(str)+1);</div><div class="line">                        strcpy(gps_cmd.port, str);</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: GPS commands on %s.\r\n&quot;</span>,MODULE_NAME, gps_cmd.port);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid device name %s in config file.\r\n&quot;</span>,MODULE_NAME, str);</div><div class="line">                        gps_cmd.port = NULL;</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                gps_cmd.port = NULL;</div><div class="line">        }</div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;gps_data_port&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(setting);</div><div class="line">                <span class="keywordflow">if</span>(str != NULL)</div><div class="line">                {</div><div class="line">                        gps_data.port = malloc(strlen(str)+1);</div><div class="line">                        strcpy(gps_data.port, str);</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: GPS data on %s.\r\n&quot;</span>,MODULE_NAME, gps_data.port);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid device name %s in config file.\r\n&quot;</span>,MODULE_NAME, str);</div><div class="line">                        gps_data.port = NULL;</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                gps_data.port = NULL;</div><div class="line">        }</div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;gps_cmd_speed&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                gps_cmd.speed = get_baud(config_setting_get_int(setting));</div><div class="line">                <span class="keywordflow">if</span>(gps_cmd.speed == BCERROR)</div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid baud rate %d in config file %s. Using default vaule %d.\r\n&quot;</span>,MODULE_NAME, gps_cmd.speed, path, BAUD_DEFAULT);</div><div class="line">                        gps_cmd.speed = BAUD_DEFAULT;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Using baud rate %d for serial port %s from config file %s.\r\n&quot;</span>,MODULE_NAME, gps_cmd.speed, gps_cmd.port, path);</div><div class="line">                }</div><div class="line">        } </div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                gps_cmd.speed = BAUD_DEFAULT;</div><div class="line">        }</div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;gps_data_speed&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                gps_data.speed = get_baud(config_setting_get_int(setting));</div><div class="line">                <span class="keywordflow">if</span>(gps_data.speed == BCERROR)</div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid baud rate %d in config file %s. Using default vaule %d.\r\n&quot;</span>,MODULE_NAME, gps_data.speed, path, BAUD_DEFAULT);</div><div class="line">                        gps_data.speed = BAUD_DEFAULT;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Using baud rate %d for serial port %s from config file %s.\r\n&quot;</span>,MODULE_NAME, gps_data.speed, gps_data.port, path);</div><div class="line">                }</div><div class="line">        } </div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                gps_data.speed = BAUD_DEFAULT;</div><div class="line">        }</div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;bits&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(setting);</div><div class="line">                <span class="keywordflow">if</span>(verify_bits(str))</div><div class="line">                {</div><div class="line">                        gps_cmd.bits = str[0]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                        gps_data.bits = str[0]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                        gps_cmd.parity = str[1];</div><div class="line">                        gps_data.parity = str[1];</div><div class="line">                        gps_cmd.stop = str[2]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                        gps_data.stop = str[2]-<span class="charliteral">&#39;0&#39;</span>;</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Using serial bit settings %s.\r\n&quot;</span>,MODULE_NAME, str);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid bits setting %s in config file. Using default value %s\r\n&quot;</span>, MODULE_NAME, str, BITS_DEFAULT);</div><div class="line">                        gps_cmd.bits = 8;</div><div class="line">                        gps_cmd.parity = <span class="charliteral">&#39;N&#39;</span>;</div><div class="line">                        gps_cmd.stop = 1;</div><div class="line">                        gps_data.bits = 8;</div><div class="line">                        gps_data.parity = <span class="charliteral">&#39;N&#39;</span>;</div><div class="line">                        gps_data.stop = 1;</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                        gps_cmd.bits = 8;</div><div class="line">                        gps_cmd.parity = <span class="charliteral">&#39;N&#39;</span>;</div><div class="line">                        gps_cmd.stop = 1;</div><div class="line">                        gps_data.bits = 8;</div><div class="line">                        gps_data.parity = <span class="charliteral">&#39;N&#39;</span>;</div><div class="line">                        gps_data.stop = 1;</div><div class="line">        }</div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;flow&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(setting);</div><div class="line">                <span class="keywordflow">if</span>(verify_flow(str))</div><div class="line">                {</div><div class="line">                        gps_cmd.flow = str[0];</div><div class="line">                        gps_data.flow = str[0];</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Using %c flow control.\r\n&quot;</span>,MODULE_NAME, gps_cmd.flow);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid flow control setting %c in config file. Using default value %s\r\n&quot;</span>, MODULE_NAME, str[0], FLOW_DEFAULT);</div><div class="line">                        gps_cmd.flow = FLOW_DEFAULT;</div><div class="line">                        gps_data.flow = FLOW_DEFAULT;</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                        gps_cmd.flow = FLOW_DEFAULT;</div><div class="line">                        gps_data.flow = FLOW_DEFAULT;</div><div class="line">        }</div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;terminator&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(setting);</div><div class="line">                <span class="keywordflow">if</span>(str != NULL)</div><div class="line">                {</div><div class="line">                        strcpy(gps_cmd.term, str);</div><div class="line">                        strcpy(gps_data.term, str);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid line terminator specified. Using default value\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        strcpy(gps_cmd.term, TERM_DEFAULT);</div><div class="line">                        strcpy(gps_data.term, TERM_DEFAULT);</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                strcpy(gps_cmd.term, TERM_DEFAULT);</div><div class="line">                strcpy(gps_data.term, TERM_DEFAULT);</div><div class="line">        }</div><div class="line"></div><div class="line">        setting = config_lookup(cfg, <span class="stringliteral">&quot;file_len&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                file_len = config_setting_get_int(setting);</div><div class="line">                <span class="keywordflow">if</span>((file_len &lt; 0) || (file_len &gt; 3600))</div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid file length %d. Using default value %d\r\n&quot;</span>, MODULE_NAME, FILE_LEN_DEFAULT);</div><div class="line">                        file_len = FILE_LEN_DEFAULT;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Using file length %d.\r\n&quot;</span>,MODULE_NAME, file_len);</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                file_len = FILE_LEN_DEFAULT;</div><div class="line">        }</div><div class="line"></div><div class="line">        config_destroy(cfg);</div><div class="line">        <span class="keywordflow">return</span>(BCSUCCESS);</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> SerialPortInit(serial *port)</div><div class="line">{</div><div class="line">        <span class="keyword">struct </span>termios options;</div><div class="line"></div><div class="line">        printf(<span class="stringliteral">&quot;Opening port %s\r\n&quot;</span>,port-&gt;port);</div><div class="line">        port-&gt;fp = open(port-&gt;port, O_RDWR | O_NOCTTY | O_NDELAY);      <span class="comment">// Open serial port</span></div><div class="line">        <span class="keywordflow">if</span>(port-&gt;fp == BCERROR)</div><div class="line">                <span class="keywordflow">return</span>(BCSEROPENERROR);</div><div class="line"></div><div class="line">        tcgetattr(port-&gt;fp, &amp;options);                                          <span class="comment">// Get current port options</span></div><div class="line"></div><div class="line">        cfsetispeed(&amp;options, port-&gt;speed);                             <span class="comment">// Set input baud rate</span></div><div class="line">        cfsetospeed(&amp;options, port-&gt;speed);                             <span class="comment">// Set output baud rate</span></div><div class="line"></div><div class="line">        options.c_cflag &amp;= ~CSIZE;                                                      <span class="comment">// Clear data bit fields</span></div><div class="line">        <span class="keywordflow">switch</span>(port-&gt;bits)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> 7:</div><div class="line">                        options.c_cflag |= CS7;                                         <span class="comment">// Select 7 data bits</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> 8:</div><div class="line">                        options.c_cflag |= CS8;                                         <span class="comment">// Select 8 data bits</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">return</span>(BCINVALIDBITS);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span>(port-&gt;parity)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;N&#39;</span>:</div><div class="line">                        options.c_cflag &amp;= ~PARENB;                                     <span class="comment">// Clear parity enable bit</span></div><div class="line">                        options.c_iflag &amp;= ~INPCK;                                      <span class="comment">// Disable parity checking of incoming data</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;O&#39;</span>:</div><div class="line">                        options.c_cflag |= PARENB;                                      <span class="comment">// Set parity enable bit</span></div><div class="line">                        options.c_cflag |= PARODD;                                      <span class="comment">// Set odd parity bit</span></div><div class="line">                        options.c_iflag |= (INPCK | ISTRIP);            <span class="comment">// Enable parity checking of incoming data</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;E&#39;</span>:</div><div class="line">                        options.c_cflag |= PARENB;                                      <span class="comment">// Set parity enable bit</span></div><div class="line">                        options.c_cflag &amp;= ~PARODD;                                     <span class="comment">// Clear odd parity bit (which means use even parity)</span></div><div class="line">                        options.c_iflag |= (INPCK | ISTRIP);            <span class="comment">// Enable parity checking of incoming data</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">return</span>(BCINVALIDPAR);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span>(port-&gt;stop)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> 1:</div><div class="line">                        options.c_cflag &amp;= ~CSTOPB;                                     <span class="comment">// Clear stop bits bit (which means use 1 stop bit)</span></div><div class="line">                        <span class="keywordflow">break</span>;                  </div><div class="line">                <span class="keywordflow">case</span> 2:</div><div class="line">                        options.c_cflag |= CSTOPB;                                      <span class="comment">// Set stop bits bit (which means use 2 stop bits)</span></div><div class="line">                        <span class="keywordflow">break</span>;                  </div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">return</span>(BCINVALIDSTOP);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span>(port-&gt;flow)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;N&#39;</span>:</div><div class="line">                        options.c_cflag &amp;= ~CRTSCTS;                            <span class="comment">// Disable hardware flow control</span></div><div class="line">                        options.c_iflag &amp;= ~(IXON | IXOFF | IXANY);     <span class="comment">// Disable software flow control</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;H&#39;</span>:</div><div class="line">                        options.c_cflag |= CRTSCTS;                                     <span class="comment">// Enable hardware flow control</span></div><div class="line">                        options.c_iflag &amp;= ~(IXON | IXOFF | IXANY);     <span class="comment">// Disable software flow control</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <span class="charliteral">&#39;S&#39;</span>:</div><div class="line">                        options.c_cflag &amp;= ~CRTSCTS;                            <span class="comment">// Disable hardware flow control</span></div><div class="line">                        options.c_iflag |= (IXON | IXOFF | IXANY);      <span class="comment">// Enable software flow control</span></div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                        <span class="keywordflow">return</span>(BCINVALIDFLOW);</div><div class="line">        }</div><div class="line"></div><div class="line">        options.c_iflag &amp;= ~ICRNL;                                                      <span class="comment">// disable mapping of CR to NL</span></div><div class="line">        options.c_lflag &amp;= ~(ICANON | ECHO | ECHOE | ECHOK | ECHONL | ECHOCTL | ECHOPRT | ECHOKE | ISIG);       <span class="comment">// Turn off line read (canonical) mode and character echoes</span></div><div class="line">        options.c_cflag |= CLOCAL;                                                      <span class="comment">// Set local mode</span></div><div class="line"><span class="comment">//      options.c_cflag &amp;= ~CREAD;                                                      // Disable the receiver for now</span></div><div class="line">        options.c_cflag |= CREAD;                                                       <span class="comment">// Enable the receiver</span></div><div class="line">        options.c_oflag &amp;= ~OPOST;                                                      <span class="comment">// Disable all processed output settings</span></div><div class="line">        options.c_cc[VMIN] = 0;                                                         <span class="comment">// Forces the read() function to return immediately with however many characters are available</span></div><div class="line">        options.c_cc[VTIME] = 0;                                                        <span class="comment">// Tells the read() function not to wait for any data</span></div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(tcsetattr(port-&gt;fp, TCSANOW, &amp;options) == 0) <span class="comment">// Make the new settings active</span></div><div class="line">        {</div><div class="line">                sleep(2);</div><div class="line">                tcflush(port-&gt;fp,TCIOFLUSH);</div><div class="line">                <span class="keywordflow">return</span>(BCSUCCESS);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">                <span class="keywordflow">return</span>(BCSETATTRERROR);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> GPSStartupCmds(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> count, i, ret, skipped;</div><div class="line">        <span class="keywordtype">char</span> *cmdstr=NULL, *confstr, *configfile;</div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *str;</div><div class="line">        FILE *cmdfile;</div><div class="line">        ssize_t numread;</div><div class="line">        <span class="keywordtype">size_t</span> len=0;</div><div class="line">        <span class="keywordtype">char</span> reply[256];</div><div class="line">        </div><div class="line">        config_init(&amp;cfgGps);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(config_read_file(&amp;cfgGps, pathCfgGps)==CONFIG_FALSE)</div><div class="line">        {</div><div class="line">                config_destroy(&amp;cfgGps);</div><div class="line">                <span class="keywordflow">return</span>(BCCONFIGREADERROR);</div><div class="line">        }</div><div class="line"></div><div class="line">        setting = config_lookup(&amp;cfgGps, <span class="stringliteral">&quot;startup&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span>(setting != NULL)</div><div class="line">        {</div><div class="line">                str = config_setting_get_string(setting);</div><div class="line">                <span class="keywordflow">if</span>(str != NULL)</div><div class="line">                {</div><div class="line">                        configfile = malloc(strlen(str)+1);</div><div class="line">                        strcpy(configfile, str);</div><div class="line">                        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Using GPS config file %s.\r\n&quot;</span>,MODULE_NAME, configfile);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Invalid GPS config file %s\r\n&quot;</span>,MODULE_NAME, str);</div><div class="line">                        <span class="keywordflow">return</span>(BCERROR);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span>(configfile)</div><div class="line">                {</div><div class="line">                        cmdfile=fopen(configfile, <span class="stringliteral">&quot;r&quot;</span>);</div><div class="line">                        <span class="keywordflow">if</span>(!cmdfile)</div><div class="line">                        {</div><div class="line">                                fprintf(stderr, <span class="stringliteral">&quot;%s: Error opening GPS config file %s\r\n&quot;</span>, MODULE_NAME, configfile);</div><div class="line">                                <span class="keywordflow">return</span>(BCERROR);</div><div class="line">                        }</div><div class="line"></div><div class="line">                        free(configfile);</div><div class="line">                }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                <span class="keywordflow">return</span>(0);</div><div class="line">        }</div><div class="line"></div><div class="line"><span class="comment">// getline allocates memory when cmdstr = NULL, to allow unknown length strings</span></div><div class="line">        i = 0;</div><div class="line">        <span class="keywordflow">while</span>((numread = getline(&amp;cmdstr, &amp;len, cmdfile)) != -1)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(ret = SendGpsCmd(cmdstr, 12000))</div><div class="line">                {</div><div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%s: Error %d sending command %s to GPS receiver.\r\n&quot;</span>, MODULE_NAME, ret, cmdstr);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">if</span> (cmdstr) free(cmdstr);</div><div class="line">                        cmdstr = NULL;</div><div class="line">                        <span class="keywordflow">if</span>(GetGpsReply(reply, 3000) == -1) fprintf(stderr, <span class="stringliteral">&quot;%s: Timeout error waiting for GPS reply\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                        i++;</div><div class="line">                }</div><div class="line">        }</div><div class="line">        fclose(cmdfile);</div><div class="line">        <span class="keywordflow">if</span> (cmdstr) free(cmdstr);</div><div class="line">        config_destroy(&amp;cfgGps);</div><div class="line">        <span class="keywordflow">return</span>(i);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> get_baud(<span class="keywordtype">int</span> baud)</div><div class="line">{</div><div class="line">        <span class="keywordflow">switch</span> (baud) {</div><div class="line">        <span class="keywordflow">case</span> 300:</div><div class="line">                <span class="keywordflow">return</span> B300;</div><div class="line">        <span class="keywordflow">case</span> 600:</div><div class="line">                <span class="keywordflow">return</span> B600;</div><div class="line">        <span class="keywordflow">case</span> 1200:</div><div class="line">                <span class="keywordflow">return</span> B1200;</div><div class="line">        <span class="keywordflow">case</span> 2400:</div><div class="line">                <span class="keywordflow">return</span> B2400;</div><div class="line">        <span class="keywordflow">case</span> 4800:</div><div class="line">                <span class="keywordflow">return</span> B4800;</div><div class="line">        <span class="keywordflow">case</span> 9600:</div><div class="line">                <span class="keywordflow">return</span> B9600;</div><div class="line">        <span class="keywordflow">case</span> 19200:</div><div class="line">                <span class="keywordflow">return</span> B19200;</div><div class="line">        <span class="keywordflow">case</span> 38400:</div><div class="line">                <span class="keywordflow">return</span> B38400;</div><div class="line">        <span class="keywordflow">case</span> 57600:</div><div class="line">                <span class="keywordflow">return</span> B57600;</div><div class="line">        <span class="keywordflow">case</span> 115200:</div><div class="line">                <span class="keywordflow">return</span> B115200;</div><div class="line">        <span class="keywordflow">case</span> 230400:</div><div class="line">                <span class="keywordflow">return</span> B230400;</div><div class="line">        <span class="keywordflow">case</span> 460800:</div><div class="line">                <span class="keywordflow">return</span> B460800;</div><div class="line">        <span class="keywordflow">case</span> 500000:</div><div class="line">                <span class="keywordflow">return</span> B500000;</div><div class="line">        <span class="keywordflow">case</span> 576000:</div><div class="line">                <span class="keywordflow">return</span> B576000;</div><div class="line">        <span class="keywordflow">case</span> 921600:</div><div class="line">                <span class="keywordflow">return</span> B921600;</div><div class="line">        <span class="keywordflow">case</span> 1000000:</div><div class="line">                <span class="keywordflow">return</span> B1000000;</div><div class="line">        <span class="keywordflow">case</span> 1152000:</div><div class="line">                <span class="keywordflow">return</span> B1152000;</div><div class="line">        <span class="keywordflow">case</span> 1500000:</div><div class="line">                <span class="keywordflow">return</span> B1500000;</div><div class="line">        <span class="keywordflow">case</span> 2000000:</div><div class="line">                <span class="keywordflow">return</span> B2000000;</div><div class="line">        <span class="keywordflow">case</span> 2500000:</div><div class="line">                <span class="keywordflow">return</span> B2500000;</div><div class="line">        <span class="keywordflow">case</span> 3000000:</div><div class="line">                <span class="keywordflow">return</span> B3000000;</div><div class="line">        <span class="keywordflow">case</span> 3500000:</div><div class="line">                <span class="keywordflow">return</span> B3500000;</div><div class="line">        <span class="keywordflow">case</span> 4000000:</div><div class="line">                <span class="keywordflow">return</span> B4000000;</div><div class="line">        <span class="keywordflow">default</span>: </div><div class="line">                <span class="keywordflow">return</span> BCERROR;</div><div class="line">        }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> verify_bits(<span class="keyword">const</span> <span class="keywordtype">char</span> *bits)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span>(((bits[0]==<span class="charliteral">&#39;7&#39;</span>) || (bits[0]==<span class="charliteral">&#39;8&#39;</span>)) &amp;&amp; ((toupper(bits[1])==<span class="charliteral">&#39;N&#39;</span>) || (toupper(bits[1])==<span class="charliteral">&#39;O&#39;</span>) || (toupper(bits[1])==<span class="charliteral">&#39;E&#39;</span>)) &amp;&amp; ((bits[2]==<span class="charliteral">&#39;1&#39;</span>) || (bits[2]==<span class="charliteral">&#39;2&#39;</span>)))</div><div class="line">                <span class="keywordflow">return</span>(TRUE);</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">                <span class="keywordflow">return</span>(FALSE);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> verify_flow(<span class="keyword">const</span> <span class="keywordtype">char</span> *bits)</div><div class="line">{</div><div class="line">        <span class="keywordflow">if</span>((toupper(bits[0])==<span class="charliteral">&#39;N&#39;</span>) || (toupper(bits[0])==<span class="charliteral">&#39;H&#39;</span>) || (toupper(bits[0])==<span class="charliteral">&#39;S&#39;</span>))</div><div class="line">                <span class="keywordflow">return</span>(TRUE);</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">                <span class="keywordflow">return</span>(FALSE);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">char</span> *TodaysDirectoryName(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        time_t epoch;</div><div class="line">        <span class="keyword">struct </span>tm *now;</div><div class="line">        <span class="keyword">struct </span>timespec ts;</div><div class="line">        <span class="keywordtype">char</span> *dirname;</div><div class="line"></div><div class="line">        dirname = &amp;todaysDirectoryName[0];</div><div class="line">        epoch = time(NULL);</div><div class="line"><span class="comment">//      epoch = ts.tv_sec;</span></div><div class="line">        now = gmtime(&amp;epoch);</div><div class="line">        sprintf(dirname,<span class="stringliteral">&quot;%04d%02d%02d&quot;</span>, (now-&gt;tm_year)+1900, (now-&gt;tm_mon)+1, now-&gt;tm_mday);</div><div class="line">        <span class="keywordflow">return</span>(dirname);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">char</span> *TodaysDirectoryPath(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> len;</div><div class="line">        <span class="keywordtype">char</span> *dirname, *fullpath;</div><div class="line"></div><div class="line">        dirname = TodaysDirectoryName();</div><div class="line"></div><div class="line">        len = strlen(data_dir);</div><div class="line">        fullpath = &amp;todaysDirectoryPath[0];     <span class="comment">// +3 is for 2 &#39;/&#39;s that we&#39;re adding plus the null terminator</span></div><div class="line">        <span class="keywordflow">if</span>(fullpath == NULL) <span class="keywordflow">return</span> (NULL);</div><div class="line">        strcpy(fullpath, data_dir);</div><div class="line">        strcpy(fullpath + len, <span class="stringliteral">&quot;/&quot;</span>);</div><div class="line">        strcpy(fullpath + len + 1, dirname);</div><div class="line">        strcpy(fullpath + len + 1 + strlen(dirname), <span class="stringliteral">&quot;/&quot;</span>);</div><div class="line">        fullpath[len + strlen(dirname) + 2] = 0;        <span class="comment">// Null term</span></div><div class="line">        <span class="keywordflow">return</span>(todaysDirectoryPath);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> TodaysDirectoryExists(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i, found;</div><div class="line">        DIR *dir;</div><div class="line"></div><div class="line">        found = TRUE;</div><div class="line"></div><div class="line">        dir = opendir(TodaysDirectoryPath());</div><div class="line">        <span class="keywordflow">if</span>(!dir)</div><div class="line">                <span class="keywordflow">if</span>(ENOENT == errno)             <span class="comment">// Directory not found</span></div><div class="line">                {</div><div class="line">                        found = FALSE;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span>                                    <span class="comment">// Some other error occurred</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">return</span>(BCFILEOPENERROR);</div><div class="line">                }</div><div class="line">                        </div><div class="line">        <span class="keywordflow">if</span>(verbose)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(found) printf(<span class="stringliteral">&quot;%s: Found %s\r\n&quot;</span>, MODULE_NAME, TodaysDirectoryName());</div><div class="line">                <span class="keywordflow">else</span> printf(<span class="stringliteral">&quot;%s: Did not find %s\r\n&quot;</span>, MODULE_NAME, TodaysDirectoryName());</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span>(found);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> CreateDayDirectory(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i, ret;</div><div class="line"></div><div class="line">        ret = mkdir(TodaysDirectoryPath(), 0777);</div><div class="line">        <span class="keywordflow">if</span>(ret)</div><div class="line">                <span class="keywordflow">if</span>(errno != EEXIST)             <span class="comment">// Existing directories not an error, anything else is</span></div><div class="line">                {</div><div class="line">                        <span class="keywordflow">return</span>(errno);</div><div class="line">                }</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>(BCSUCCESS);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">char</span> *LogFileName(<span class="keywordtype">char</span> *name)</div><div class="line">{</div><div class="line">        time_t epoch;</div><div class="line">        <span class="keyword">struct </span>tm *now;</div><div class="line">        <span class="keywordtype">char</span> *rootname, *fullpath;</div><div class="line">        <span class="keyword">struct </span>timespec ts;</div><div class="line">        <span class="keywordtype">char</span> filename[50];      <span class="comment">// format is YYYYMMDDhhmmss_name.txt</span></div><div class="line"></div><div class="line">        epoch = time(NULL);</div><div class="line"><span class="comment">//      epoch = ts.tv_sec;</span></div><div class="line">        now = gmtime(&amp;epoch);</div><div class="line">        sprintf(filename,<span class="stringliteral">&quot;%s_%04d%02d%02d%02d%02d%02d.sbf&quot;</span>, name, (now-&gt;tm_year)+1900, (now-&gt;tm_mon)+1, now-&gt;tm_mday, now-&gt;tm_hour, now-&gt;tm_min, now-&gt;tm_sec);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>((rootname = TodaysDirectoryPath()) == NULL)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">return</span>(NULL);</div><div class="line">        }</div><div class="line"></div><div class="line">        fullpath = &amp;logFileName[0];             <span class="comment">// +1&#39;s are for the &#39;/&#39; and null term</span></div><div class="line">        strcpy(fullpath, rootname);</div><div class="line"><span class="comment">//      strcpy(fullpath + strlen(rootname), &quot;/&quot;);</span></div><div class="line">        strcpy(fullpath + strlen(rootname), filename);</div><div class="line">        fullpath[strlen(rootname) + strlen(filename)] = 0;</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>(logFileName);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> OpenLogFile(<span class="keywordtype">char</span> *name)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i, index, ret;</div><div class="line">        <span class="keywordtype">char</span> *strName;</div><div class="line">        <span class="keywordtype">char</span> reply[256];</div><div class="line"></div><div class="line">        SendGpsCmd(<span class="stringliteral">&quot;enoc, COM2, RMC\r&quot;</span>, 1000);</div><div class="line">        GetGpsReply(reply, 3000);</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(!TodaysDirectoryExists())</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(CreateDayDirectory()) <span class="keywordflow">return</span>(BCFILEERROR);</div><div class="line">        }</div><div class="line"></div><div class="line">        ret = BCSUCCESS;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>((strName = LogFileName(name)) == NULL)</div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Error generating log file name.\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                <span class="keywordflow">return</span>(BCFILEERROR);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>((fp = fopen(strName, <span class="stringliteral">&quot;a+&quot;</span>)) == NULL)</div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Error Opening log file %s.\r\n&quot;</span>, MODULE_NAME, strName);</div><div class="line">                ret = BCFILEOPENERROR;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(verbose) </div><div class="line">                {</div><div class="line">                        printf(<span class="stringliteral">&quot;%s: Opened log file %s.\r\n&quot;</span>, MODULE_NAME, strName);</div><div class="line">                        fflush(stdout);</div><div class="line">                }</div><div class="line">                curfilename = malloc(strlen(strName));</div><div class="line">                strcpy(curfilename, strName);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>(ret);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> CloseLogFile(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> i, index, err, ret;</div><div class="line"></div><div class="line">        ret = BCSUCCESS;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(err = fclose(fp))</div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Error closing log file.\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                ret = BCFILEERROR;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(ret == BCSUCCESS)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Closed log file.\r\n&quot;</span>, MODULE_NAME);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>(ret);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> NewFile(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"><span class="comment">//      led(ORANGE);</span></div><div class="line">        CloseLogFile();</div><div class="line">        CopyFile(curfilename);</div><div class="line">        OpenLogFile(MODULE_NAME);</div><div class="line"><span class="comment">//      led(OFF);</span></div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>(BCSUCCESS);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> LogData(FILE *fp, <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> n)</div><div class="line">{</div><div class="line">        <span class="keywordtype">int</span> ret;</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(fp==NULL)</div><div class="line">        {</div><div class="line">                fprintf(stderr,<span class="stringliteral">&quot;%s: Error. Invalid log file stream\r\n&quot;</span>, MODULE_NAME);</div><div class="line">                <span class="keywordflow">return</span>(BCFILEERROR);</div><div class="line">        }</div><div class="line">        ret = fwrite(data, 1, n, fp);</div><div class="line">        fflush(fp);</div><div class="line">        <span class="keywordflow">return</span>(ret);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> CopyFile(<span class="keywordtype">char</span> *name)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmd[128];</div><div class="line">        <span class="keywordtype">int</span> err;</div><div class="line">        </div><div class="line">        sprintf(cmd,<span class="stringliteral">&quot;cp %s %s&quot;</span>, name, queueDir);</div><div class="line"><span class="comment">//      sprintf(cmd,&quot;cp data.txt %s&quot;, queueDir);</span></div><div class="line">        <span class="keywordflow">if</span>((err==system(cmd)) &lt; 0)</div><div class="line">        {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: Error copying data %s file to queue directory %s\r\n&quot;</span>, MODULE_NAME, name, queueDir);</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%s: data.txt copied\n&quot;</span>, cmd);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span>(err);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> SendGpsCmd(<span class="keywordtype">char</span> *cmdstr, <span class="keywordtype">int</span> timeout)</div><div class="line">{</div><div class="line">        <span class="keywordtype">size_t</span> n;</div><div class="line">        <span class="keyword">struct </span>timespec spec;</div><div class="line">        <span class="keywordtype">int</span> prompt, i, numread, ptr;</div><div class="line">        <span class="keywordtype">char</span> inbuf[256];        <span class="comment">// needs to be big enough to hold replies from commands</span></div><div class="line">        <span class="keywordtype">double</span> nowtime, endtime;</div><div class="line">        </div><div class="line"><span class="comment">/* Get prompt to make sure GPS is ready to receive command.</span></div><div class="line"><span class="comment">        Return an error if prompt not received </span></div><div class="line"><span class="comment">*/</span></div><div class="line">        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: Sending GPS command %s&quot;</span>, MODULE_NAME, cmdstr);</div><div class="line">        clock_gettime(CLOCK_MONOTONIC, &amp;spec);</div><div class="line">        nowtime = spec.tv_sec + (spec.tv_nsec / 1000000000);</div><div class="line">        endtime = nowtime + (timeout/1000);</div><div class="line">        </div><div class="line">        write(gps_cmd.fp, <span class="stringliteral">&quot;\n&quot;</span>, 1);             <span class="comment">// send LF to get command prompt</span></div><div class="line">        prompt=0;</div><div class="line">        numread=0;</div><div class="line">        inbuf[0]=0;</div><div class="line">        ptr=0;</div><div class="line">        </div><div class="line">        <span class="keywordflow">while</span>(!prompt &amp;&amp; (nowtime &lt; endtime))           <span class="comment">// Wait until prompt (COMx&gt;) is received</span></div><div class="line">        {</div><div class="line">                ioctl(gps_cmd.fp, FIONREAD, &amp;i);</div><div class="line">                <span class="keywordflow">if</span>(i&gt;0)</div><div class="line">                {</div><div class="line">                        numread = read(gps_cmd.fp, inbuf+ptr, i);</div><div class="line">                        ptr += numread;</div><div class="line">                        inbuf[ptr] = 0;</div><div class="line">                        <span class="keywordflow">if</span>(strstr(inbuf, <span class="stringliteral">&quot;COM&quot;</span>) &amp;&amp; strstr(inbuf, <span class="stringliteral">&quot;&gt;&quot;</span>))</div><div class="line">                        {</div><div class="line">                                prompt = 1;</div><div class="line">                        }</div><div class="line">                }</div><div class="line">                clock_gettime(CLOCK_MONOTONIC, &amp;spec);</div><div class="line">                nowtime = spec.tv_sec + (spec.tv_nsec / 1000000000);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span>(nowtime &gt;= endtime)  <span class="keywordflow">return</span>(-1);             <span class="comment">// Timed out without receiving prompt</span></div><div class="line"></div><div class="line"><span class="comment">/* Send command</span></div><div class="line"><span class="comment">*/</span>      </div><div class="line">        n = write(gps_cmd.fp, cmdstr, strlen(cmdstr));          <span class="comment">// Send command</span></div><div class="line">        <span class="keywordflow">if</span>(n != strlen(cmdstr)) <span class="keywordflow">return</span>(-2);                                     <span class="comment">// Some sort of write error occurred</span></div><div class="line">        </div><div class="line">        <span class="keywordflow">return</span>(BCSUCCESS);</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> GetGpsReply(<span class="keywordtype">char</span> *replybuf, <span class="keywordtype">int</span> timeout)</div><div class="line">{</div><div class="line">        <span class="keywordtype">size_t</span> n;</div><div class="line">        <span class="keywordtype">int</span> endreply, i, numread, ptr;</div><div class="line">        <span class="keyword">struct </span>timespec spec;</div><div class="line">        <span class="keywordtype">double</span> nowtime, endtime;</div><div class="line"></div><div class="line">        replybuf[0]=0;</div><div class="line">        </div><div class="line">        clock_gettime(CLOCK_MONOTONIC, &amp;spec);</div><div class="line">        nowtime = spec.tv_sec + (spec.tv_nsec / 1000000000);</div><div class="line">        endtime = nowtime + (timeout/1000);</div><div class="line">        </div><div class="line">        endreply = 0;</div><div class="line">        ptr = 0;</div><div class="line">        <span class="keywordflow">while</span>(!endreply &amp;&amp; (nowtime &lt; endtime))</div><div class="line">        {</div><div class="line">                ioctl(gps_cmd.fp, FIONREAD, &amp;i);</div><div class="line">                <span class="keywordflow">if</span>(i&gt;0)</div><div class="line">                {</div><div class="line">                        numread = read(gps_cmd.fp, replybuf+ptr, 1);</div><div class="line">                        ptr += numread;</div><div class="line">                        replybuf[ptr] = 0;</div><div class="line">                        <span class="keywordflow">if</span>(strstr(replybuf, <span class="stringliteral">&quot;COM&quot;</span>) &amp;&amp; strstr(replybuf, <span class="stringliteral">&quot;&gt;&quot;</span>))</div><div class="line">                        {</div><div class="line">                                endreply = 1;</div><div class="line">                        }</div><div class="line">                }</div><div class="line">                clock_gettime(CLOCK_MONOTONIC, &amp;spec);</div><div class="line">                nowtime = spec.tv_sec + (spec.tv_nsec / 1000000000);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span>(nowtime &gt;= endtime)  <span class="keywordflow">return</span>(-1);             <span class="comment">// Timed out without receiving prompt</span></div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(verbose) printf(<span class="stringliteral">&quot;%s: GPS Reply = %s&quot;</span>,MODULE_NAME, replybuf);</div><div class="line">        <span class="keywordflow">return</span>(strlen(replybuf));</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**********************************</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* gps_power(), gps_reset(), gps_power_toggle(), set_safe(), led(), set_gpio0()</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* Description: These functions control the digital outputs of the TS-7680.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* Parameter: int state</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* Return value: None</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* These functions hide the active hi/lo nature of the signals so they can be</span></div><div class="line"><span class="comment">*   called as gps_power(ON), etc. without worrying about whether that&#39;s a</span></div><div class="line"><span class="comment">*   logic hi or lo. The argument to led() should be one of: GREEN, RED, ORANGE,</span></div><div class="line"><span class="comment">*   or OFF.</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">************************************/</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> gps_power(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(state)</div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;gpio gps_power 0&quot;</span>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;gpio gps_power 1&quot;</span>);</div><div class="line">        }</div><div class="line"></div><div class="line">        system(cmdstr);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> gps_reset(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(state)</div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;gpio gps_reset 0&quot;</span>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;gpio gps_reset 1&quot;</span>);</div><div class="line">        }</div><div class="line"></div><div class="line">        system(cmdstr);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> gps_power_toggle(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(state)</div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;gpio gps_pow_tog 0&quot;</span>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;gpio gps_pow_tog 1&quot;</span>);</div><div class="line">        }</div><div class="line"></div><div class="line">        system(cmdstr);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> set_safe(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(state)</div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;gpio safe 1&quot;</span>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;gpio safe 0&quot;</span>);</div><div class="line">        }</div><div class="line"></div><div class="line">        system(cmdstr);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> led(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">switch</span>(state)</div><div class="line">        {</div><div class="line">                <span class="keywordflow">case</span> RED:</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;gpio led1 0&quot;</span>);</div><div class="line">                        system(cmdstr);</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;gpio led0 1&quot;</span>);</div><div class="line">                        system(cmdstr);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> GREEN:</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;gpio led0 0&quot;</span>);</div><div class="line">                        system(cmdstr);</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;gpio led1 1&quot;</span>);</div><div class="line">                        system(cmdstr);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> ORANGE:</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;gpio led0 1&quot;</span>);</div><div class="line">                        system(cmdstr);</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;gpio led1 1&quot;</span>);</div><div class="line">                        system(cmdstr);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> OFF:</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;gpio led0 0&quot;</span>);</div><div class="line">                        system(cmdstr);</div><div class="line">                        sprintf(cmdstr,<span class="stringliteral">&quot;gpio led1 0&quot;</span>);</div><div class="line">                        system(cmdstr);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">        }               </div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> set_gpio0(<span class="keywordtype">int</span> state)</div><div class="line">{</div><div class="line">        <span class="keywordtype">char</span> cmdstr[32];</div><div class="line">        </div><div class="line">        <span class="keywordflow">if</span>(state)</div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;gpio gpio0 1&quot;</span>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">                sprintf(cmdstr,<span class="stringliteral">&quot;gpio gpio0 0&quot;</span>);</div><div class="line">        }</div><div class="line"></div><div class="line">        system(cmdstr);</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> led_blink(<span class="keywordtype">int</span> color, <span class="keywordtype">int</span> num, <span class="keywordtype">int</span> duration)</div><div class="line">{</div><div class="line">        </div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"></div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
